{% extends "base.html" %}
{% block title %}Th√™m ƒê·∫∑t ph√≤ng{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-plus-circle me-2"></i>Th√™m ƒê·∫∑t ph√≤ng <small class="text-muted">Photo AI + Manual</small></h1>

<!-- Duplicate Warning Modal -->
{% if duplicate_warning %}
<div class="alert alert-warning border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%); color: white;">
    <h4 class="alert-heading">
        <i class="fas fa-exclamation-triangle me-2"></i>‚ö†Ô∏è Ph√°t hi·ªán kh√°ch c√≥ th·ªÉ tr√πng l·∫∑p!
    </h4>
    
    {% for duplicate in duplicate_warning.duplicates %}
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="card bg-white bg-opacity-20 border-0">
                <div class="card-body">
                    <h6 class="text-white">üìù Booking M·ªöI (ƒëang th√™m)</h6>
                    <div class="text-white-75">
                        <strong>T√™n:</strong> {{ duplicate.new_booking.guest_name }}<br>
                        <strong>Check-in:</strong> {{ duplicate.new_booking.check_in_date }}<br>
                        <strong>Check-out:</strong> {{ duplicate.new_booking.check_out_date }}<br>
                        <strong>Ph√≤ng:</strong> {{ duplicate.new_booking.room_type }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-white bg-opacity-20 border-0">
                <div class="card-body">
                    <h6 class="text-white">üóÉÔ∏è Booking HI·ªÜN T·∫†I (trong h·ªá th·ªëng)</h6>
                    <div class="text-white-75">
                        <strong>ID:</strong> {{ duplicate.existing_booking.booking_id }}<br>
                        <strong>T√™n:</strong> {{ duplicate.existing_booking.guest_name }}<br>
                        <strong>Check-in:</strong> {{ duplicate.existing_booking.check_in_date }}<br>
                        <strong>Check-out:</strong> {{ duplicate.existing_booking.check_out_date }}<br>
                        <strong>Tr·∫°ng th√°i:</strong> {{ duplicate.existing_booking.status }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <div class="mt-3">
        <h6>üí° L·ª±a ch·ªçn c·ªßa b·∫°n:</h6>
        <div class="d-flex gap-3">
            <form method="POST" action="{{ url_for('add_booking') }}" style="display: inline;">
                {% for key, value in form_data.items() %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endfor %}
                <input type="hidden" name="force_add" value="1">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>‚úÖ V·∫´n th√™m booking m·ªõi
                </button>
            </form>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">
                <i class="fas fa-times me-1"></i>‚ùå H·ªßy v√† ki·ªÉm tra l·∫°i
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Smart Photo Upload Section -->
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
        <h6 class="mb-0 text-white fw-bold">
            <i class="fas fa-camera me-2"></i>
            <span class="text-white">üì∏ AI Smart Upload - T·ª± ƒë·ªông nh·∫≠n di·ªán 1 kh√°ch ho·∫∑c nhi·ªÅu kh√°ch</span>
        </h6>
    </div>
    <div class="card-body">
        <div id="photo-upload-area" class="border-2 border-dashed border-primary rounded p-4 text-center" 
             style="cursor: pointer; background-color: #f8f9ff;">
            <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
            <p class="mb-2"><strong>D√°n ·∫£nh (Ctrl+V) ho·∫∑c click ƒë·ªÉ ch·ªçn file</strong></p>
            <small class="text-muted">AI s·∫Ω t·ª± ƒë·ªông ph√¢n t√≠ch v√† quy·∫øt ƒë·ªãnh: ƒëi·ªÅn form (1 kh√°ch) ho·∫∑c l∆∞u nhi·ªÅu kh√°ch</small>
            <input type="file" id="photo-input" accept="image/*" style="display: none;">
        </div>
        
        <!-- Processing Status -->
        <div id="photo-processing" class="mt-3" style="display: none;">
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                    <small class="text-primary"><strong>AI ƒëang ph√¢n t√≠ch ·∫£nh...</strong></small>
                </div>
            </div>
        </div>
        
        <!-- AI Extraction Results - Review Table -->
        <div id="ai-results-review" class="mt-3" style="display: none;">
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i>AI ƒë√£ tr√≠ch xu·∫•t th√†nh c√¥ng!</h5>
                <p class="mb-0">T√¨m th·∫•y <span id="extracted-count">0</span> booking t·ª´ ·∫£nh. Vui l√≤ng ki·ªÉm tra v√† ch·ªânh s·ª≠a n·∫øu c·∫ßn:</p>
            </div>
            
            <!-- Review Table with Edit Capabilities -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-table me-2"></i>Xem tr∆∞·ªõc v√† ch·ªânh s·ª≠a th√¥ng tin</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover mb-0" id="review-table">
                            <thead class="table-primary">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="15%">T√™n kh√°ch *</th>
                                    <th width="12%">Booking ID</th>
                                    <th width="10%">Check-in *</th>
                                    <th width="10%">Check-out *</th>
                                    <th width="12%">T·ªïng ti·ªÅn *</th>
                                    <th width="12%">Hoa h·ªìng</th>
                                    <th width="10%">Email</th>
                                    <th width="10%">Phone</th>
                                    <th width="4%">X√≥a</th>
                                </tr>
                            </thead>
                            <tbody id="review-table-body">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-6">
                            <button id="add-manual-row" class="btn btn-outline-primary">
                                <i class="fas fa-plus me-2"></i>Th√™m kh√°ch th·ªß c√¥ng
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <button onclick="resetPhotoUpload()" class="btn btn-secondary me-2">
                                <i class="fas fa-undo me-2"></i>Th·ª≠ l·∫°i
                            </button>
                            <button id="confirm-save-all" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>X√°c nh·∫≠n l∆∞u t·∫•t c·∫£
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Form (Auto-filled by AI or manual entry) -->
<div id="manual-form-container">
    <div class="card border-secondary">
        <div class="card-header bg-secondary text-white">
            <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Form th·ªß c√¥ng (t·ª± ƒë·ªông ƒëi·ªÅn t·ª´ AI)</h6>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('add_booking') }}">
                <div class="row g-3">
                    <!-- Essential Information -->
                    <div class="col-md-6">
                        <label for="T√™n ng∆∞·ªùi ƒë·∫∑t" class="form-label"><i class="fas fa-user me-1"></i>T√™n ng∆∞·ªùi ƒë·∫∑t *</label>
                        <input type="text" class="form-control" id="T√™n ng∆∞·ªùi ƒë·∫∑t" name="T√™n ng∆∞·ªùi ƒë·∫∑t" 
                               value="{{ form_data.get('T√™n ng∆∞·ªùi ƒë·∫∑t', '') if form_data else '' }}" 
                               placeholder="Nh·∫≠p t√™n kh√°ch h√†ng ho·∫∑c ƒë·ªÉ AI t·ª± ƒëi·ªÅn" required>
                    </div>
                    <div class="col-md-6">
                        <label for="S·ªë ƒë·∫∑t ph√≤ng" class="form-label"><i class="fas fa-hashtag me-1"></i>S·ªë ƒë·∫∑t ph√≤ng</label>
                        <input type="text" class="form-control" id="S·ªë ƒë·∫∑t ph√≤ng" name="S·ªë ƒë·∫∑t ph√≤ng" 
                               value="{{ form_data.get('S·ªë ƒë·∫∑t ph√≤ng', '') if form_data else '' }}" 
                               placeholder="Nh·∫≠p m√£ booking ho·∫∑c ƒë·ªÉ AI t·ª± ƒëi·ªÅn">
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="col-md-4">
                        <label for="Email" class="form-label"><i class="fas fa-envelope me-1"></i>Email</label>
                        <input type="email" class="form-control" id="Email" name="Email" 
                               value="{{ form_data.get('Email', '') if form_data else '' }}" 
                               placeholder="email@example.com">
                    </div>
                    <div class="col-md-4">
                        <label for="S·ªë ƒëi·ªán tho·∫°i" class="form-label"><i class="fas fa-phone me-1"></i>S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" class="form-control" id="S·ªë ƒëi·ªán tho·∫°i" name="S·ªë ƒëi·ªán tho·∫°i" 
                               value="{{ form_data.get('S·ªë ƒëi·ªán tho·∫°i', '') if form_data else '' }}" 
                               placeholder="+84...">
                    </div>
                    <div class="col-md-4">
                        <label for="S·ªë kh√°ch" class="form-label"><i class="fas fa-users me-1"></i>S·ªë kh√°ch</label>
                        <input type="number" class="form-control" id="S·ªë kh√°ch" name="S·ªë kh√°ch" 
                               value="{{ form_data.get('S·ªë kh√°ch', '1') if form_data else '1' }}" 
                               placeholder="1" min="1" max="10">
                    </div>

                    <!-- Dates -->
                    <div class="col-md-6">
                        <label for="Ng√†y ƒë·∫øn" class="form-label"><i class="fas fa-calendar-check me-1"></i>Ng√†y ƒë·∫øn (Check-in) *</label>
                        <input type="date" class="form-control" id="Ng√†y ƒë·∫øn" name="Ng√†y ƒë·∫øn" 
                               value="{{ form_data.get('Ng√†y ƒë·∫øn', '') if form_data else '' }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="Ng√†y ƒëi" class="form-label"><i class="fas fa-calendar-times me-1"></i>Ng√†y ƒëi (Check-out) *</label>
                        <input type="date" class="form-control" id="Ng√†y ƒëi" name="Ng√†y ƒëi" 
                               value="{{ form_data.get('Ng√†y ƒëi', '') if form_data else '' }}" required>
                    </div>

                    <!-- Payment Information -->
                    <div class="col-md-6">
                        <label for="T·ªïng thanh to√°n" class="form-label"><i class="fas fa-coins me-1"></i>T·ªïng thanh to√°n (VND) *</label>
                        <input type="number" step="any" class="form-control" id="T·ªïng thanh to√°n" name="T·ªïng thanh to√°n" 
                               value="{{ form_data.get('T·ªïng thanh to√°n', '') if form_data else '' }}"
                               placeholder="0" min="0" required>
                    </div>
                    <div class="col-md-6">
                        <label for="Hoa h·ªìng" class="form-label"><i class="fas fa-percentage me-1"></i>Hoa h·ªìng (VND)</label>
                        <input type="number" step="any" class="form-control" id="Hoa h·ªìng" name="Hoa h·ªìng" 
                               value="{{ form_data.get('Hoa h·ªìng', '') if form_data else '0' }}"
                               placeholder="0" min="0">
                    </div>
                    
                    <!-- Status and Payment -->
                    <div class="col-md-6">
                        <label for="T√¨nh tr·∫°ng" class="form-label"><i class="fas fa-flag me-1"></i>T√¨nh tr·∫°ng</label>
                        <select class="form-select" id="T√¨nh tr·∫°ng" name="T√¨nh tr·∫°ng">
                            <option value="OK" {% if not form_data or form_data.get('T√¨nh tr·∫°ng') == 'OK' %}selected{% endif %}>‚úÖ OK</option>
                            <option value="ƒê√£ h·ªßy" {% if form_data and form_data.get('T√¨nh tr·∫°ng') == 'ƒê√£ h·ªßy' %}selected{% endif %}>‚ùå ƒê√£ h·ªßy</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="Ng∆∞·ªùi thu ti·ªÅn" class="form-label"><i class="fas fa-user-tie me-1"></i>Ng∆∞·ªùi thu ti·ªÅn</label>
                        <select class="form-select" id="Ng∆∞·ªùi thu ti·ªÅn" name="Ng∆∞·ªùi thu ti·ªÅn">
                            <option value="" {% if not form_data or not form_data.get('Ng∆∞·ªùi thu ti·ªÅn') %}selected{% endif %}>üö´ Ch∆∞a thu</option>
                            <option value="LOC LE" {% if form_data and form_data.get('Ng∆∞·ªùi thu ti·ªÅn') == 'LOC LE' %}selected{% endif %}>üë§ LOC LE</option>
                            <option value="THAO LE" {% if form_data and form_data.get('Ng∆∞·ªùi thu ti·ªÅn') == 'THAO LE' %}selected{% endif %}>üë§ THAO LE</option>
                        </select>
                    </div>

                    <!-- Hidden fields with default values -->
                    <input type="hidden" name="T√™n ch·ªó ngh·ªâ" value="118 Hang Bac Hostel">
                    <input type="hidden" name="ƒê∆∞·ª£c ƒë·∫∑t v√†o" value="">
                    <input type="hidden" name="Ti·ªÅn t·ªá" value="VND">
                    <input type="hidden" name="V·ªã tr√≠" value="H√† N·ªôi">
                    <input type="hidden" name="Th√†nh vi√™n Genius" value="Kh√¥ng">
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary btn-lg me-2">
                        <i class="fas fa-plus me-2"></i>Th√™m 1 ƒê·∫∑t ph√≤ng
                    </button>
                    <a href="{{ url_for('view_bookings') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Store extracted bookings for multiple booking scenario
let extractedBookings = [];

// Photo upload functionality
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('photo-upload-area');
    const photoInput = document.getElementById('photo-input');
    
    // Click to upload
    uploadArea.onclick = () => photoInput.click();
    
    // File selection
    photoInput.onchange = function(e) {
        if (e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = e => processPhoto(e.target.result);
            reader.readAsDataURL(e.target.files[0]);
        }
    };
    
    // Paste support
    document.addEventListener('paste', function(e) {
        const items = e.clipboardData.items;
        for (let item of items) {
            if (item.type.startsWith('image/')) {
                const file = item.getAsFile();
                const reader = new FileReader();
                reader.onload = e => processPhoto(e.target.result);
                reader.readAsDataURL(file);
                break;
            }
        }
    });
});

function processPhoto(imageData) {
    console.log('üîç Processing photo...');
    
    // Show processing indicator
    document.getElementById('photo-processing').style.display = 'block';
    document.getElementById('multiple-bookings-result').style.display = 'none';
    
    // Call AI processing endpoint
    fetch('/api/process_pasted_image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image_b64: imageData })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('photo-processing').style.display = 'none';
        
        console.log('üìã AI Response:', data);
        
        if (data.error) {
            alert('‚ùå L·ªói x·ª≠ l√Ω ·∫£nh: ' + data.error);
            return;
        }
        
        // Handle new smart response format - always show review table
        if (data.type === 'single') {
            // Single booking detected - show in review table
            console.log('üìù Single booking detected - showing review table');
            showReviewTable([data.booking], data.duplicate_check);
            
        } else if (data.type === 'multiple') {
            // Multiple bookings detected - show in review table
            console.log('üë• Multiple bookings detected - showing review table');
            showReviewTable(data.bookings, data.duplicate_check);
            
        } else {
            // Fallback for legacy response format
            console.log('üîÑ Using legacy response format');
            let bookings = [];
            if (Array.isArray(data)) {
                bookings = data;
            } else if (data.bookings && Array.isArray(data.bookings)) {
                bookings = data.bookings;
            } else if (data.guest_name) {
                bookings = [data];
            }
            
            const validBookings = bookings.filter(booking => !booking.error);
            
            if (validBookings.length === 0) {
                alert('‚ö†Ô∏è Kh√¥ng th·ªÉ tr√≠ch xu·∫•t th√¥ng tin booking t·ª´ ·∫£nh n√†y. Vui l√≤ng th·ª≠ ·∫£nh kh√°c ho·∫∑c nh·∫≠p th·ªß c√¥ng.');
                return;
            }
            
            // Show all bookings in review table
            showReviewTable(validBookings, null);
        }
    })
    .catch(error => {
        document.getElementById('photo-processing').style.display = 'none';
        console.error('‚ùå Photo processing error:', error);
        alert('‚ùå L·ªói k·∫øt n·ªëi khi x·ª≠ l√Ω ·∫£nh: ' + error.message);
    });
}

// Auto-fill function removed - now using review table for all scenarios

function showReviewTable(bookings, duplicateCheck) {
    console.log('üìä Showing review table for:', bookings);
    
    extractedBookings = bookings;
    
    // Update counter
    document.getElementById('extracted-count').textContent = bookings.length;
    
    // Show duplicate warning if needed
    if (duplicateCheck && duplicateCheck.has_duplicates) {
        const duplicateCount = duplicateCheck.duplicates.length;
        alert(`‚ö†Ô∏è C·∫¢NH B√ÅO: T√¨m th·∫•y ${duplicateCount} kh√°ch c√≥ th·ªÉ ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!\\n` +
              'Vui l√≤ng ki·ªÉm tra k·ªπ trong b·∫£ng xem tr∆∞·ªõc tr∆∞·ªõc khi l∆∞u.');
    }
    
    // Create editable table rows
    const tableBodyHtml = bookings.map((booking, index) => `
        <tr data-index="${index}">
            <td class="text-center fw-bold">${index + 1}</td>
            <td>
                <input type="text" class="form-control form-control-sm" 
                       value="${booking.guest_name || ''}" 
                       onchange="updateBookingData(${index}, 'guest_name', this.value)"
                       placeholder="T√™n kh√°ch h√†ng" required>
            </td>
            <td>
                <input type="text" class="form-control form-control-sm" 
                       value="${booking.booking_id || ''}" 
                       onchange="updateBookingData(${index}, 'booking_id', this.value)"
                       placeholder="T·ª± t·∫°o">
            </td>
            <td>
                <input type="date" class="form-control form-control-sm" 
                       value="${booking.checkin_date || booking.check_in_date || ''}" 
                       onchange="updateBookingData(${index}, 'checkin_date', this.value)" required>
            </td>
            <td>
                <input type="date" class="form-control form-control-sm" 
                       value="${booking.checkout_date || booking.check_out_date || ''}" 
                       onchange="updateBookingData(${index}, 'checkout_date', this.value)" required>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm" 
                       value="${booking.room_amount || booking.total_payment || ''}" 
                       onchange="updateBookingData(${index}, 'room_amount', this.value)"
                       placeholder="0" min="0" required>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm" 
                       value="${booking.commission || ''}" 
                       onchange="updateBookingData(${index}, 'commission', this.value)"
                       placeholder="0" min="0">
            </td>
            <td>
                <input type="email" class="form-control form-control-sm" 
                       value="${booking.email || ''}" 
                       onchange="updateBookingData(${index}, 'email', this.value)"
                       placeholder="email@example.com">
            </td>
            <td>
                <input type="tel" class="form-control form-control-sm" 
                       value="${booking.phone || ''}" 
                       onchange="updateBookingData(${index}, 'phone', this.value)"
                       placeholder="+84...">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm" 
                        onclick="removeBookingRow(${index})" title="X√≥a kh√°ch n√†y">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    document.getElementById('review-table-body').innerHTML = tableBodyHtml;
    document.getElementById('ai-results-review').style.display = 'block';
    
    // Hide manual form during review
    document.getElementById('manual-form-container').style.display = 'none';
}

function resetPhotoUpload() {
    document.getElementById('photo-processing').style.display = 'none';
    document.getElementById('ai-results-review').style.display = 'none';
    document.getElementById('manual-form-container').style.display = 'block';
    document.getElementById('photo-input').value = '';
    extractedBookings = [];
}

function updateBookingData(index, field, value) {
    if (extractedBookings[index]) {
        extractedBookings[index][field] = value;
        console.log(`üìù Updated booking ${index + 1} ${field}: ${value}`);
    }
}

function removeBookingRow(index) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√°ch n√†y?')) {
        extractedBookings.splice(index, 1);
        console.log(`üóëÔ∏è Removed booking at index ${index}`);
        
        // Refresh the table
        showReviewTable(extractedBookings, null);
        
        // Update counter
        document.getElementById('extracted-count').textContent = extractedBookings.length;
        
        if (extractedBookings.length === 0) {
            resetPhotoUpload();
        }
    }
}

function addManualRow() {
    const newBooking = {
        guest_name: '',
        booking_id: '',
        checkin_date: '',
        checkout_date: '',
        room_amount: '',
        commission: '',
        email: '',
        phone: ''
    };
    
    extractedBookings.push(newBooking);
    console.log('‚ûï Added manual booking row');
    
    // Refresh the table
    showReviewTable(extractedBookings, null);
}

function validateBookings() {
    const errors = [];
    
    extractedBookings.forEach((booking, index) => {
        const rowNum = index + 1;
        
        if (!booking.guest_name || booking.guest_name.trim() === '') {
            errors.push(`D√≤ng ${rowNum}: Thi·∫øu t√™n kh√°ch h√†ng`);
        }
        
        if (!booking.checkin_date) {
            errors.push(`D√≤ng ${rowNum}: Thi·∫øu ng√†y check-in`);
        }
        
        if (!booking.checkout_date) {
            errors.push(`D√≤ng ${rowNum}: Thi·∫øu ng√†y check-out`);
        }
        
        if (!booking.room_amount || booking.room_amount <= 0) {
            errors.push(`D√≤ng ${rowNum}: Thi·∫øu ho·∫∑c sai t·ªïng ti·ªÅn`);
        }
        
        // Validate dates
        if (booking.checkin_date && booking.checkout_date) {
            if (new Date(booking.checkin_date) >= new Date(booking.checkout_date)) {
                errors.push(`D√≤ng ${rowNum}: Ng√†y check-out ph·∫£i sau ng√†y check-in`);
            }
        }
    });
    
    return errors;
}

// Save all bookings functionality with validation
document.addEventListener('DOMContentLoaded', function() {
    // Add manual row button
    const addRowButton = document.getElementById('add-manual-row');
    if (addRowButton) {
        addRowButton.onclick = addManualRow;
    }
    
    // Confirm save button
    const confirmSaveButton = document.getElementById('confirm-save-all');
    if (confirmSaveButton) {
        confirmSaveButton.onclick = function() {
            if (extractedBookings.length === 0) {
                alert('Kh√¥ng c√≥ booking n√†o ƒë·ªÉ l∆∞u');
                return;
            }
            
            // Validate all bookings
            const errors = validateBookings();
            if (errors.length > 0) {
                alert('‚ùå Vui l√≤ng s·ª≠a l·ªói sau:\\n\\n' + errors.join('\\n'));
                return;
            }
            
            // Show confirmation
            const confirmMessage = `X√°c nh·∫≠n l∆∞u ${extractedBookings.length} booking:\\n\\n` +
                extractedBookings.map((b, i) => `${i + 1}. ${b.guest_name} - ${(b.room_amount || 0).toLocaleString()}ƒë`).join('\\n') +
                '\\n\\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u?';
                
            if (!confirm(confirmMessage)) {
                return;
            }
            
            console.log('üíæ Saving all bookings after validation:', extractedBookings);
            
            // Disable button and show loading
            confirmSaveButton.disabled = true;
            confirmSaveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang l∆∞u...';
            
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/bookings/save_extracted';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'extracted_json';
            input.value = JSON.stringify(extractedBookings);
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        };
    }
});

function clearForm() {
    // Clear all form fields
    document.querySelectorAll('input, select').forEach(function(element) {
        if (element.type === 'text' || element.type === 'number' || element.type === 'date' || element.type === 'email' || element.type === 'tel') {
            element.value = '';
        } else if (element.tagName === 'SELECT') {
            element.selectedIndex = 0;
        }
    });
    
    // Reset photo upload
    resetPhotoUpload();
    
    // Hide any duplicate warning
    const warning = document.querySelector('.alert-warning');
    if (warning) {
        warning.style.display = 'none';
    }
    
    // Focus on first input
    document.querySelector('input[name="T√™n ng∆∞·ªùi ƒë·∫∑t"]').focus();
}
</script>

{% endblock %}