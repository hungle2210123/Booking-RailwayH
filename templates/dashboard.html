{% extends "base.html" %}

{% block title %}Dashboard - Hotel Management{% endblock %}

{% block extra_css %}
<style>
/* Commission Guest Highlighting */
.high-commission-guest {
    border-left: 4px solid #dc3545 !important;
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%) !important;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2) !important;
    animation: subtlePulse 3s ease-in-out infinite;
}

.commission-guest {
    border-left: 4px solid #ffc107 !important;
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%) !important;
}

.no-commission-guest {
    border-left: 4px solid #28a745 !important;
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%) !important;
}

.commission-display {
    margin-top: 2px;
}

@keyframes subtlePulse {
    0% { box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2); }
    50% { box-shadow: 0 2px 12px rgba(220, 53, 69, 0.4); }
    100% { box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2); }
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Mobile Dashboard Optimizations */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 8px !important;
        padding-right: 8px !important;
    }
    
    .card {
        margin-bottom: 8px !important;
    }
    
    .card-body {
        padding: 8px !important;
    }
    
    .card-header {
        padding: 6px 8px !important;
    }
    
    .btn-group .btn {
        padding: 2px 6px !important;
        font-size: 12px !important;
    }
    
    .alert {
        margin-bottom: 8px !important;
        padding: 8px !important;
    }
    
    .row {
        margin-bottom: 8px !important;
    }
    
    /* Compact notification cards on mobile - NO HEIGHT LIMITS */
    .notification-card-mobile {
        /* Removed max-height and overflow restrictions for full visibility */
    }
    
    /* Hide some text on very small screens */
    @media (max-width: 576px) {
        .d-sm-none {
            display: none !important;
        }
        
        .btn-sm {
            padding: 1px 4px !important;
            font-size: 10px !important;
        }
        
        .card-header h6, .card-header h5 {
            font-size: 12px !important;
        }
        
        small, .small {
            font-size: 10px !important;
        }
    }
}

/* Compact layout improvements */
.compact-card {
    border-radius: 8px !important;
}

.compact-card .card-body {
    padding: 12px !important;
}

.notification-item {
    padding: 6px 8px !important;
    margin-bottom: 4px !important;
    border-radius: 6px !important;
}

/* QuickNotes Template Button Styling */
.template-btn {
    transition: all 0.2s ease;
    border: 2px solid transparent !important;
}

.template-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.template-btn.active {
    border: 2px solid currentColor !important;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
    transform: scale(1.05);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- ‚ö†Ô∏è PIN NOTIFICATION CHO NG√ÄY QU√Å T·∫¢I (FIXED TOP) -->
    {% if overcrowded_days and overcrowded_days|length > 0 %}
    {% set urgent_days = overcrowded_days | selectattr('alert_level', 'equalto', 'urgent') | list %}
    {% set today_overcrowded = overcrowded_days | selectattr('is_today', 'equalto', true) | list %}
    
    <div class="alert alert-warning border-0 shadow-lg mb-0 fixed-top" 
         style="top: 0; z-index: 1050; border-radius: 0 0 10px 10px; background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-exclamation-triangle fa-2x text-white"></i>
                </div>
                <div class="text-white">
                    <div class="fw-bold fs-6 mb-1">
                        ‚ö†Ô∏è C·∫¢NH B√ÅO QU√Å T·∫¢I: {{ overcrowded_days|length }} ng√†y c√≥ >4 kh√°ch
                    </div>
                    <div class="small">
                        {% if today_overcrowded %}
                            <span class="badge bg-danger me-2">H√îM NAY: {{ today_overcrowded[0].guest_count }} kh√°ch</span>
                        {% endif %}
                        {% if urgent_days %}
                            <span class="badge bg-warning text-dark me-2">Kh·∫©n c·∫•p: {{ urgent_days|length }} ng√†y</span>
                        {% endif %}
                        <span class="text-white-75">T·ªëi ƒëa: 4 ph√≤ng c√≥ s·∫µn</span>
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-light btn-sm me-2" onclick="scrollToOvercrowdedSection()">
                    <i class="fas fa-eye me-1"></i>Xem chi ti·∫øt
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="dismissPinNotification()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Spacer ƒë·ªÉ content kh√¥ng b·ªã che b·ªüi fixed notification -->
    <div style="height: 80px;"></div>
    {% endif %}

    <h1 class="mt-4">üìä Dashboard T·ªïng quan</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">T·ªïng quan v·ªÅ hi·ªáu su·∫•t kh√°ch s·∫°n</li>
    </ol>

    <!-- ‚ö° DASHBOARD CONTROLS - Quick Actions -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tools text-primary me-2"></i>
                            <small class="text-muted fw-bold">Dashboard Controls</small>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="refreshDashboardData()" 
                                    data-action="refresh-dashboard"
                                    title="L√†m m·ªõi d·ªØ li·ªáu overdue payment">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Data
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" 
                                    onclick="openDataSyncModal()" 
                                    data-action="data-sync"
                                    title="ƒê·ªìng b·ªô d·ªØ li·ªáu t·ª´ database local">
                                <i class="fas fa-cloud-upload-alt me-1"></i>Sync Data
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" 
                                    onclick="window.location.reload()" 
                                    title="T·∫£i l·∫°i to√†n b·ªô trang">
                                <i class="fas fa-redo me-1"></i>Reload Page
                            </button>
                            <button type="button" class="btn btn-sm btn-warning" 
                                    onclick="fixDatabaseConstraint()" 
                                    id="fixConstraintBtn"
                                    title="S·ª≠a l·ªói constraint ƒë·ªÉ cho ph√©p status ti·∫øng Vi·ªát">
                                <i class="fas fa-wrench me-1"></i>Fix DB
                            </button>
                            <button type="button" class="btn btn-sm btn-success" 
                                    onclick="importCSVData()" 
                                    id="csvImportBtn"
                                    title="Nh·∫≠p d·ªØ li·ªáu t·ª´ file CSV">
                                <i class="fas fa-upload me-1"></i>Nh·∫≠p CSV
                            </button>
                            <button type="button" class="btn btn-sm btn-info" 
                                    onclick="runDiagnostic()" 
                                    id="diagnosticBtn"
                                    title="Ki·ªÉm tra d·ªØ li·ªáu ƒë√£ nh·∫≠p">
                                <i class="fas fa-stethoscope me-1"></i>Check Data
                            </button>
                            <button type="button" class="btn btn-sm btn-primary" 
                                    onclick="runDetailedDiagnostic()" 
                                    id="detailedDiagnosticBtn"
                                    title="So s√°nh Excel vs Database chi ti·∫øt">
                                <i class="fas fa-search me-1"></i>Deep Check
                            </button>
                            <button type="button" class="btn btn-sm btn-warning" 
                                    onclick="runImportDebug()" 
                                    id="importDebugBtn"
                                    title="Debug chi ti·∫øt t·ª´ng booking b·ªã reject">
                                <i class="fas fa-bug me-1"></i>Debug Import
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" 
                                    onclick="addGuestNameColumn()" 
                                    id="addColumnBtn"
                                    title="Th√™m c·ªôt guest_name v√†o PostgreSQL">
                                <i class="fas fa-columns me-1"></i>Add Column
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" 
                                    onclick="clearImportedData()" 
                                    id="clearDataBtn"
                                    title="X√≥a d·ªØ li·ªáu ƒë√£ nh·∫≠p ƒë·ªÉ nh·∫≠p l·∫°i">
                                <i class="fas fa-trash me-1"></i>Clear & Re-import
                            </button>
                            <a href="{{ url_for('view_bookings', show_all='true') }}" 
                               class="btn btn-sm btn-outline-info" 
                               title="Xem t·∫•t c·∫£ booking">
                                <i class="fas fa-list me-1"></i>All Bookings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter"></i>
            T√πy ch·ªânh kho·∫£ng th·ªùi gian
        </div>
        <div class="card-body">
            <form method="get" action="{{ url_for('dashboard') }}" class="row g-3 align-items-center">
                <div class="col-md-5">
                    <label for="start_date" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                    <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                <div class="col-md-5">
                    <label for="end_date" class="form-label">Ng√†y k·∫øt th√∫c</label>
                    <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> L·ªçc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- üîî ARRIVAL & DEPARTURE NOTIFICATIONS (QUICKNOTES STYLE) -->
    {% if arrival_notifications or departure_notifications %}
    
    <!-- Commission Summary Alert -->
    {% set all_notifications = arrival_notifications + departure_notifications %}
    {% set high_commission_guests = [] %}
    {% set total_commission_amount = 0 %}
    {% for notification in all_notifications %}
        {% set commission = notification.get('Hoa h·ªìng', 0)|float %}
        {% if commission > 150000 %}
            {% set _ = high_commission_guests.append(notification) %}
        {% endif %}
        {% set total_commission_amount = total_commission_amount + commission %}
    {% endfor %}
    
    {% if high_commission_guests %}
    <div class="row mb-2">
        <div class="col-12">
            <div class="alert alert-warning alert-dismissible fade show" role="alert" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 2px solid #ffc107; animation: subtlePulse 3s ease-in-out infinite;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle text-danger me-2 fs-5"></i>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1">
                            <strong>üö® C·∫¢NH B√ÅO HOA H·ªíNG CAO!</strong>
                        </h6>
                        <p class="mb-1">
                            <strong>{{ high_commission_guests|length }} kh√°ch</strong> c√≥ hoa h·ªìng <strong>tr√™n 150,000ƒë</strong>:
                            {% for guest in high_commission_guests %}
                                <span class="badge bg-danger text-white me-1">
                                    {{ guest.guest_name }}: {{ "{:,.0f}".format(guest.get('Hoa h·ªìng', 0)|float) }}ƒë
                                </span>
                            {% endfor %}
                        </p>
                        <small class="text-muted">
                            üí∞ T·ªïng hoa h·ªìng h√¥m nay: <strong>{{ "{:,.0f}".format(total_commission_amount) }}ƒë</strong>
                        </small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="row mb-2">
        <!-- Arrival Notifications -->
        {% if arrival_notifications and arrival_notifications|length > 0 %}
        <div class="col-md-6 mb-2">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-white fw-bold small">
                            <i class="fas fa-plane-arrival me-1"></i>üìú Kh√°ch ƒê·∫øn ({{ arrival_notifications|length }})
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" onclick="copyArrivalTaxiMessage('Kh√°ch')" title="Copy taxi message">
                                <i class="fas fa-copy"></i>
                            </button>
                            <small class="text-white ms-2">Kh√°ch ƒê·∫øn</small>
                        </div>
                    </div>
                    <div>
                        {% for notification in arrival_notifications %}
                        {% set commission = notification.get('Hoa h·ªìng', 0)|float %}
                        {% set is_high_commission = commission > 150000 %}
                        {% set has_commission = commission > 0 %}
                        <div class="bg-white bg-opacity-90 rounded mb-1 px-2 py-1 {{ 'high-commission-guest' if is_high_commission else ('commission-guest' if has_commission else 'no-commission-guest') }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-dark small">
                                        {{ notification.guest_name }}
                                        {% if is_high_commission %}
                                        <i class="fas fa-exclamation-triangle text-danger ms-1" title="Hoa h·ªìng cao > 150k"></i>
                                        {% elif has_commission %}
                                        <i class="fas fa-percentage text-warning ms-1" title="C√≥ hoa h·ªìng"></i>
                                        {% else %}
                                        <i class="fas fa-check text-success ms-1" title="Kh√¥ng hoa h·ªìng"></i>
                                        {% endif %}
                                    </div>
                                    <div class="text-muted" style="font-size: 11px;">
                                        <i class="fas fa-calendar me-1"></i>{{ notification.checkin_date }}
                                        <button class="btn btn-sm p-0 ms-2 text-primary" onclick="editGuestArrivalTime('{{ notification.booking_id }}', '{{ notification.guest_name }}')" title="Set time">
                                            <i class="fas fa-clock me-1"></i><span id="time-{{ notification.booking_id }}">--:--</span>
                                        </button>
                                        <button class="btn btn-sm p-0 ms-1 text-danger" onclick="clearGuestArrivalTime('{{ notification.booking_id }}', '{{ notification.guest_name }}')" title="Clear time" style="display: none;" id="clear-{{ notification.booking_id }}">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% if notification.priority == 'critical' %}
                                        <span class="badge bg-danger ms-1 px-1" style="font-size: 9px; animation: pulse 2s infinite;">
                                            {% if notification.days_until == 0 %}H√îM NAY{% else %}MAI{% endif %} - HIGH COMMISSION
                                        </span>
                                        {% elif notification.priority == 'urgent' %}
                                        <span class="badge bg-danger ms-1 px-1" style="font-size: 9px;">H√îM NAY</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark ms-1 px-1" style="font-size: 9px;">MAI</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-success px-1 mb-1" onclick="copyPaymentMessage('{{ notification.guest_name }}', {{ notification.total_amount|float }}, {{ commission }})" title="Copy payment message">
                                        <i class="fas fa-dollar-sign"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary px-1 mb-1" onclick="copyArrivalTaxiMessage('{{ notification.guest_name }}')" title="Copy taxi message">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <div class="small fw-bold text-success">{{ "{:,.0f}".format(notification.total_amount|float) }}ƒë</div>
                                    {% if has_commission %}
                                    <div class="commission-display" style="font-size: 10px;">
                                        {% if is_high_commission %}
                                        <span class="badge bg-danger text-white px-1">
                                            <i class="fas fa-exclamation-triangle"></i> {{ "{:,.0f}".format(commission) }}ƒë
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark px-1">
                                            <i class="fas fa-percentage"></i> {{ "{:,.0f}".format(commission) }}ƒë
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="text-muted" style="font-size: 10px;">
                                        <span class="badge bg-success text-white px-1">
                                            <i class="fas fa-check"></i> Kh√¥ng hoa h·ªìng
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Departure Notifications -->
        {% if departure_notifications and departure_notifications|length > 0 %}
        <div class="col-md-6 mb-2">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-white fw-bold small">
                            <i class="fas fa-plane-departure me-1"></i>üöñ Kh√°ch ƒêi ({{ departure_notifications|length }})
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" onclick="copyTaxiMessage('Kh√°ch')" title="Copy taxi">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        {% for notification in departure_notifications %}
                        {% set commission = notification.get('Hoa h·ªìng', 0)|float %}
                        {% set is_high_commission = commission > 150000 %}
                        {% set has_commission = commission > 0 %}
                        <div class="bg-white bg-opacity-90 rounded mb-1 px-2 py-1 {{ 'high-commission-guest' if is_high_commission else ('commission-guest' if has_commission else 'no-commission-guest') }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-dark small">
                                        {{ notification.guest_name }}
                                        {% if is_high_commission %}
                                        <i class="fas fa-exclamation-triangle text-danger ms-1" title="Hoa h·ªìng cao > 150k"></i>
                                        {% elif has_commission %}
                                        <i class="fas fa-percentage text-warning ms-1" title="C√≥ hoa h·ªìng"></i>
                                        {% else %}
                                        <i class="fas fa-check text-success ms-1" title="Kh√¥ng hoa h·ªìng"></i>
                                        {% endif %}
                                    </div>
                                    <div class="text-muted" style="font-size: 11px;">
                                        <i class="fas fa-calendar me-1"></i>{{ notification.checkout_date }}
                                        {% if notification.priority == 'urgent' %}
                                        <span class="badge bg-danger ms-1 px-1" style="font-size: 9px;">H√îM NAY</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark ms-1 px-1" style="font-size: 9px;">MAI</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-primary px-1" onclick="copyTaxiMessage('{{ notification.guest_name }}')" title="Copy taxi">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    {% if has_commission %}
                                    <div class="commission-display" style="font-size: 10px;">
                                        {% if is_high_commission %}
                                        <span class="badge bg-danger text-white px-1">
                                            <i class="fas fa-exclamation-triangle"></i> {{ "{:,.0f}".format(commission) }}ƒë
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark px-1">
                                            <i class="fas fa-percentage"></i> {{ "{:,.0f}".format(commission) }}ƒë
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="text-muted mt-1" style="font-size: 10px;">
                                        <span class="badge bg-success text-white px-1">
                                            <i class="fas fa-check"></i> Kh√¥ng hoa h·ªìng
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Quick Notes Display (ULTRA COMPACT) -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-white fw-bold small">
                            <i class="fas fa-sticky-note me-1"></i>üìù Quick Notes
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" data-bs-toggle="modal" data-bs-target="#quickNotesModal" title="T·∫°o m·ªõi">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-outline-light btn-sm px-2" onclick="syncQuickNotes()" title="Sync">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="quickNotesContainer">
                        <div class="text-center py-1">
                            <small class="text-white">ƒêang t·∫£i...</small>
                        </div>
                    </div>
                    <input type="file" id="quickNotesFileInput" accept=".json" style="display: none;" onchange="handleQuickNotesImport(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- üí∞ MONTHLY EXPENSE TRACKER (COMPACT) -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); min-height: 60px;">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-0 text-white fw-bold small">
                                <i class="fas fa-receipt me-1"></i>üí∞ Chi Ph√≠ Th√°ng
                            </h6>
                            <div id="monthlyExpenseSummary" class="text-white-50 small">
                                <span id="currentMonthText"></span>: <span id="monthlyTotal">ƒêang t·∫£i...</span>
                            </div>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" data-bs-toggle="modal" data-bs-target="#expenseModal" title="Th√™m chi ph√≠" onclick="prepareExpenseModal()">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-outline-light btn-sm px-2" data-bs-toggle="modal" data-bs-target="#expenseReviewModal" title="Xem chi ti·∫øt">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-light btn-sm px-2" onclick="loadMonthlyExpenses()" title="T·∫£i l·∫°i">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ‚ö†Ô∏è KH√ÅCH CH∆ØA THU TI·ªÄN QU√Å H·∫†N (COMPACT) -->
    {% if overdue_unpaid_guests and overdue_unpaid_guests|length > 0 %}
    <div class="card border-0 shadow-sm mb-3" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
        <div class="card-body py-2 px-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-white fw-bold">
                    <i class="fas fa-exclamation-triangle me-1"></i>‚ö†Ô∏è CH∆ØA THU ({{ overdue_unpaid_guests|length }})
                </h6>
                <div class="text-white text-end">
                    <div class="fw-bold">{{ "{:,.0f}".format(overdue_total_amount if overdue_total_amount else 0) }}ƒë</div>
                    <small>T·ªïng ch∆∞a thu</small>
                </div>
            </div>
        
            <div class="table-responsive">
                <table class="table table-sm table-borderless mb-0">
                    <tbody>
                        {% for guest in overdue_unpaid_guests[:5] %}
                        <tr class="bg-white bg-opacity-90">
                            <td class="py-1 px-2">
                                <div class="fw-bold text-dark small">{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', 'N/A') }}</div>
                                <div class="text-muted" style="font-size: 11px;">
                                    {% if guest.get('Check-in Date') %}
                                        {% set checkin_date = guest['Check-in Date'] %}
                                        {% if checkin_date is string %}
                                            {% if checkin_date and checkin_date != '' %}
                                                {% if checkin_date|length >= 10 %}
                                                    {{ checkin_date[8:10] + '/' + checkin_date[5:7] }}
                                                {% else %}
                                                    {{ checkin_date }}
                                                {% endif %}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        {% else %}
                                            {{ checkin_date.strftime('%d/%m') if checkin_date else 'N/A' }}
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                    <span class="badge bg-danger ms-1 px-1" style="font-size: 9px;">{{ guest.get('days_overdue', 0) }}d</span>
                                </div>
                            </td>
                            <td class="py-1 px-2 text-end">
                                {% set room_amount = guest.get('calculated_room_fee', 0) or guest.get('T·ªïng thanh to√°n', 0) or 0 %}
                                {% set taxi_amount = guest.get('calculated_taxi_fee', 0) or 0 %}
                                {% set total_amount = room_amount + taxi_amount %}
                                {% set raw_collected = guest.get('S·ªë ti·ªÅn ƒë√£ thu', 0) or 0 %}
                                {% set collector = guest.get('Ng∆∞·ªùi thu ti·ªÅn', '') or '' %}
                                {% set has_valid_collector = collector in ['LOC LE', 'THAO LE'] %}
                                {% set collected = has_valid_collector and raw_collected or 0 %}
                                {% set remaining = total_amount - collected %}
                                
                                {% if has_valid_collector and collected > 0 %}
                                    <!-- Show collected amount in green (only when valid collector) -->
                                    <div class="fw-bold text-success small">
                                        <i class="fas fa-check-circle me-1"></i>{{ "{:,.0f}".format(collected) }}ƒë
                                    </div>
                                    {% if remaining > 0 %}
                                        <!-- Show remaining amount in red -->
                                        <div class="fw-bold text-danger small">
                                            <i class="fas fa-exclamation-circle me-1"></i>C√≤n: {{ "{:,.0f}".format(remaining) }}ƒë
                                        </div>
                                    {% else %}
                                        <div class="text-success small">
                                            <i class="fas fa-check me-1"></i>ƒê√£ thanh to√°n
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <!-- No valid collection yet - show total amount in red -->
                                    <div class="fw-bold text-danger small">
                                        <i class="fas fa-money-bill-wave me-1"></i>{{ "{:,.0f}".format(total_amount) }}ƒë
                                    </div>
                                    {% if not has_valid_collector and collected > 0 %}
                                        <div class="text-muted small">
                                            <i class="fas fa-info-circle me-1"></i>Ch∆∞a c√≥ ng∆∞·ªùi thu
                                        </div>
                                    {% endif %}
                                {% endif %}
                                <div class="text-muted" style="font-size: 10px;">
                                    {% set room_fee = guest.get('calculated_room_fee', 0) or 0 %}
                                    {% set taxi_fee = guest.get('calculated_taxi_fee', 0) or 0 %}
                                    {% set commission = guest.get('Hoa h·ªìng', 0) or 0 %}
                                    
                                    {% if room_fee > 0 %}
                                        <i class="fas fa-bed me-1"></i>{{ "{:,.0f}".format(room_fee) }}ƒë
                                    {% endif %}
                                    {% if taxi_fee > 0 %}
                                        {% if room_fee > 0 %}<br>{% endif %}
                                        <i class="fas fa-taxi me-1"></i>{{ "{:,.0f}".format(taxi_fee) }}ƒë
                                    {% endif %}
                                    {% if commission > 0 %}
                                        <br><i class="fas fa-percentage me-1"></i>{{ "{:,.0f}".format(commission) }}ƒë
                                    {% endif %}
                                    <br>{{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', 'N/A') }}
                                </div>
                            </td>
                            <td class="py-1 px-1">
                                <div class="btn-group-vertical btn-group-sm">
                                    {% set booking_id = guest.get('S·ªë ƒë·∫∑t ph√≤ng', '') %}
                                    {% set guest_name = guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', '') %}
                                    {% set commission = guest.get('Hoa h·ªìng', 0) or 0 %}
                                    {% set room_fee = guest.get('calculated_room_fee') or guest.get('T·ªïng thanh to√°n', 0) or 0 %}
                                    {% set taxi_fee = guest.get('calculated_taxi_fee', 0) or 0 %}
                                    {% set total_amount = room_fee + taxi_fee %}
                                    {% set raw_collected = guest.get('S·ªë ti·ªÅn ƒë√£ thu', 0) or 0 %}
                                    {% set collector = guest.get('Ng∆∞·ªùi thu ti·ªÅn', '') or '' %}
                                    {% set has_collector = collector in ['LOC LE', 'THAO LE'] %}
                                    {% set collected_amount = has_collector and raw_collected or 0 %}
                                    {% set payment_note = guest.get('Ghi ch√∫ thanh to√°n', '') or '' %}
                                    
                                    <button class="btn btn-info btn-sm py-1 px-2" style="font-size: 11px;"
                                            onclick="openCollectModal('{{ booking_id }}', '{{ guest_name }}', {{ total_amount }}, {{ commission }}, {{ room_fee }}, {{ taxi_fee }}, {{ collected_amount }}, '{{ collector }}', '{{ payment_note }}')">
                                        <i class="fas fa-eye me-1"></i>Xem
                                    </button>
                                    <button class="btn btn-success btn-sm py-1 px-2" style="font-size: 11px;"
                                            onclick="openEditCollectedModal('{{ booking_id }}', '{{ guest_name }}', {{ total_amount }}, {{ collected_amount }}, '{{ collector }}')"
                                        <i class="fas fa-dollar-sign me-1"></i>Thu
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm py-1 px-2" style="font-size: 11px;"
                                            onclick="openEditAmountModal('{{ booking_id }}', '{{ guest_name }}', {{ room_fee }}, {{ taxi_fee }}, {{ commission }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        
            {% if overdue_unpaid_guests|length > 5 %}
            <div class="text-center mt-2">
                <button class="btn btn-outline-light btn-sm" onclick="toggleMoreOverdue()">
                    <i class="fas fa-chevron-down me-1"></i>+{{ overdue_unpaid_guests|length - 5 }}
                </button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ‚ö†Ô∏è C·∫¢NH B√ÅO NG√ÄY QU√Å T·∫¢I (QU√Å 4 KH√ÅCH) -->
    {% if overcrowded_days and overcrowded_days|length > 0 %}
    <div class="alert border-0 shadow-lg mb-4" id="overcrowdedSection" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h4 class="alert-heading text-white mb-2">
                    <i class="fas fa-users me-2"></i>‚ö†Ô∏è C·∫¢NH B√ÅO NG√ÄY QU√Å T·∫¢I
                </h4>
                <p class="text-white mb-0">{{ overcrowded_days|length }} ng√†y c√≥ h∆°n 4 kh√°ch check-in (T·ªëi ƒëa: 4 ph√≤ng)</p>
            </div>
            <div class="text-end">
                <button class="btn btn-light btn-sm" onclick="toggleOvercrowdedDetails()">
                    <i class="fas fa-eye me-1"></i><span id="overcrowdToggleText">Chi ti·∫øt</span>
                </button>
            </div>
        </div>
        
        <!-- Quick Summary -->
        <div class="row mt-3">
            {% set urgent_days = overcrowded_days | selectattr('alert_level', 'equalto', 'urgent') | list %}
            {% set warning_days = overcrowded_days | selectattr('alert_level', 'equalto', 'warning') | list %}
            {% set future_days = overcrowded_days | selectattr('is_future', 'equalto', true) | list %}
            
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ urgent_days|length }}</div>
                        <small class="text-white-75">Kh·∫©n c·∫•p (‚â§3 ng√†y)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ warning_days|length }}</div>
                        <small class="text-white-75">C·∫£nh b√°o (‚â§7 ng√†y)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ future_days|length }}</div>
                        <small class="text-white-75">T∆∞∆°ng lai</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed List (Initially Hidden) -->
        <div id="overcrowdedDetails" style="display: none;" class="mt-3">
            <hr class="text-white-50 my-3">
            <div class="row">
                {% for day in overcrowded_days[:6] %}
                <div class="col-md-6 col-lg-4 mb-2">
                    <div class="card bg-white border-0">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold text-dark">
                                        {% if day.date %}
                                            {{ day.date.strftime('%d/%m/%Y') if day.date.strftime else day.date }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                        
                                        {% if day.is_today %}
                                            <span class="badge bg-danger ms-1">H√îM NAY</span>
                                        {% elif day.days_from_today == 1 %}
                                            <span class="badge bg-warning ms-1">NG√ÄY MAI</span>
                                        {% elif day.days_from_today > 0 and day.days_from_today <= 3 %}
                                            <span class="badge bg-danger ms-1">{{ day.days_from_today }} NG√ÄY N·ªÆA</span>
                                        {% elif day.days_from_today > 0 %}
                                            <span class="badge bg-info ms-1">{{ day.days_from_today }} ng√†y</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-users me-1"></i>{{ day.guest_count }} kh√°ch check-in
                                        <span class="ms-2 badge bg-{{ day.alert_color }}">
                                            {% if day.guest_count > 6 %}
                                                NGHI√äM TR·ªåNG
                                            {% elif day.guest_count > 4 %}
                                                QU√Å T·∫¢I
                                            {% endif %}
                                        </span>
                                    </small>
                                    <div class="fw-bold text-success mt-1">
                                        <i class="fas fa-coins me-1"></i>{{ "{:,.0f}".format(day.daily_total if day.daily_total else 0) }}ƒë
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="showDayDetails('{{ day.date }}', {{ day.guest_count }}, {{ day.guest_names|tojson }}, {{ day.booking_ids|tojson }}, {{ day.daily_total if day.daily_total else 0 }}, {{ day.individual_amounts|tojson if day.individual_amounts else [] }})"
                                            title="Xem chi ti·∫øt kh√°ch">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if overcrowded_days|length > 6 %}
            <div class="text-center mt-2">
                <small class="text-white-75">... v√† {{ overcrowded_days|length - 6 }} ng√†y kh√°c</small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}


    <!-- Key Metrics -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">Doanh thu</div>
                            <div class="fs-3 fw-bold">{{ "{:,.0f}".format(total_revenue) }}ƒë</div>
                        </div>
                        <i class="fas fa-coins fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">L∆∞·ª£ng kh√°ch</div>
                            <div class="fs-3 fw-bold">{{ total_guests }}</div>
                        </div>
                        <i class="fas fa-users fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- More metrics can be added here -->
    </div>

    <!-- Charts -->
    <!-- Bi·ªÉu ƒë·ªì doanh thu chuy√™n nghi·ªáp -->
    <div class="row">
        <div class="col-xl-12">
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-line me-2"></i>
                            <span class="fw-bold">üìà Doanh thu theo th√°ng (T·∫•t c·∫£ th·ªùi gian)</span>
                        </div>
                        <div class="badge bg-light text-dark">Chi ti·∫øt ƒë·∫ßy ƒë·ªß</div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="monthlyRevenueChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- B·∫£ng chi ti·∫øt v√† ph√¢n t√≠ch -->
    {% if monthly_revenue_with_unpaid %}
    <div class="row">
        <div class="col-xl-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-1 text-primary"></i> 
                        Chi ti·∫øt Doanh thu theo th√°ng (CH·ªà kh√°ch ƒë√£ check-in)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="border-0">
                                        <i class="fas fa-calendar-alt me-1"></i>Th√°ng
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-check-circle me-1 text-success"></i>ƒê√£ thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-clock me-1 text-warning"></i>Ch∆∞a thu
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-users me-1 text-info"></i>Kh√°ch ch∆∞a thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-coins me-1 text-info"></i>T·ªïng c·ªông
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-percentage me-1 text-primary"></i>T·ª∑ l·ªá thu
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-users me-1 text-success"></i>T·ªïng kh√°ch
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-money-bill-wave me-1 text-info"></i>TB/kh√°ch
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-coins me-1 text-warning"></i>T·ªïng hoa h·ªìng
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in monthly_revenue_with_unpaid %}
                                <tr class="border-bottom">
                                    <td>
                                        <div class="fw-bold text-primary">{{ row.get('Th√°ng', 'N/A') }}</div>
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-link fw-bold text-success p-0 border-0 bg-transparent" 
                                                onclick="showMonthlyGuestDetails('{{ row.get('Th√°ng', 'N/A') }}', 'collected', {{ row.get('ƒê√£ thu', 0) | float }})"
                                                title="Click ƒë·ªÉ xem chi ti·∫øt kh√°ch ƒë√£ thu">
                                            <i class="fas fa-eye me-1"></i>{{ "{:,.0f}".format(row.get('ƒê√£ thu', 0) | float) }}ƒë
                                        </button>
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-link fw-bold text-danger p-0 border-0 bg-transparent" 
                                                onclick="showMonthlyGuestDetails('{{ row.get('Th√°ng', 'N/A') }}', 'uncollected', {{ row.get('Ch∆∞a thu', 0) | float }})"
                                                title="Click ƒë·ªÉ xem chi ti·∫øt kh√°ch ch∆∞a thu">
                                            <i class="fas fa-exclamation-triangle me-1"></i>{{ "{:,.0f}".format(row.get('Ch∆∞a thu', 0) | float) }}ƒë
                                        </button>
                                    </td>
                                    <td class="text-center">
                                        {% set uncollected_count = row.get('S·ªë kh√°ch ch∆∞a thu', 0) %}
                                        {% if uncollected_count > 0 %}
                                        <span class="badge bg-warning text-dark">
                                            {{ uncollected_count }} kh√°ch
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> ƒê√£ thu h·∫øt
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% set total = (row.get('ƒê√£ thu', 0) | float) + (row.get('Ch∆∞a thu', 0) | float) %}
                                        <div class="fw-bold text-dark">
                                            {{ "{:,.0f}".format(total) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set collected = row.get('ƒê√£ thu', 0) | float %}
                                        {% set uncollected = row.get('Ch∆∞a thu', 0) | float %}
                                        {% set total = collected + uncollected %}
                                        {% set percentage = (collected / total * 100) if total > 0 else 0 %}
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if percentage >= 90 %}bg-success{% elif percentage >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ percentage }}%;" 
                                                 aria-valuenow="{{ percentage }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                <small class="fw-bold">{{ "{:.1f}%".format(percentage) }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set total_guests = row.get('T·ªïng kh√°ch', 0) %}
                                        {% set collected_guests = row.get('Kh√°ch ƒë√£ thu', 0) %}
                                        <div class="fw-bold text-info">{{ total_guests }}</div>
                                        <small class="text-muted">{{ collected_guests }} ƒë√£ thu</small>
                                    </td>
                                    <td class="text-end">
                                        {% set avg_spending = row.get('Chi ti√™u TB/kh√°ch', 0) %}
                                        <div class="fw-bold text-primary">
                                            {{ "{:,.0f}".format(avg_spending | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        {% set total_commission = row.get('T·ªïng hoa h·ªìng', 0) %}
                                        <div class="fw-bold text-warning">
                                            {{ "{:,.0f}".format(total_commission | float) }}ƒë
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Enhanced Statistics Summary -->
                    <div class="alert alert-info mt-3 mb-0">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-check-circle text-success me-1"></i>C·∫£i ti·∫øn th·ªëng k√™:</h6>
                                <ul class="mb-0 small">
                                    <li>‚úÖ <strong>Ch·ªâ t√≠nh kh√°ch ƒë√£ check-in</strong> (lo·∫°i tr·ª´ kh√°ch ch∆∞a ƒë·∫øn)</li>
                                    <li>üìä <strong>Chi ti√™u trung b√¨nh</strong> per kh√°ch chi ti·∫øt</li>
                                    <li>üí∞ <strong>Hoa h·ªìng trung b√¨nh</strong> per kh√°ch r√µ r√†ng</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle text-info me-1"></i>√ù nghƒ©a c√°c c·ªôt:</h6>
                                <ul class="mb-0 small">
                                    <li><strong>T·ªïng kh√°ch:</strong> S·ªë kh√°ch ƒë√£ check-in trong th√°ng</li>
                                    <li><strong>TB/kh√°ch:</strong> Trung b√¨nh chi ti√™u m·ªói kh√°ch</li>
                                    <li><strong>Hoa h·ªìng TB:</strong> Trung b√¨nh hoa h·ªìng m·ªói kh√°ch</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-1 text-primary"></i> 
                        Ph√¢n b·ªï theo Ng∆∞·ªùi thu (Chi ti·∫øt)
                    </h6>
                    <small class="text-muted">‚úÖ Validation: CH·ªà LOC LE & THAO LE, theo ng√†y ƒë√£ ch·ªçn</small>
                </div>
                <div class="card-body">
                    <div id="collectorChart" style="height: 320px;"></div>
                    
                    <!-- ‚úÖ ENHANCED: Detailed Collector Statistics Table -->
                    {% if monthly_revenue_with_unpaid %}
                    <div class="mt-3">
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-users me-1"></i>Chi ti·∫øt thu ti·ªÅn:
                        </h6>
                        <div id="collectorStatsTable">
                            <!-- This will be populated by JavaScript from the collector chart data -->
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th><i class="fas fa-user me-1"></i>Ng∆∞·ªùi thu</th>
                                            <th class="text-end"><i class="fas fa-money-bill me-1"></i>S·ªë ti·ªÅn</th>
                                            <th class="text-center"><i class="fas fa-calendar me-1"></i>S·ªë ƒë·∫∑t ph√≤ng</th>
                                            <th class="text-center"><i class="fas fa-percentage me-1"></i>T·ª∑ l·ªá</th>
                                        </tr>
                                    </thead>
                                    <tbody id="collectorStatsBody">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-1"></i>ƒêang t·∫£i d·ªØ li·ªáu...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Validation Info -->
                        <div class="alert alert-info mt-2 mb-0">
                            <div class="row">
                                <div class="col-6">
                                    <small>
                                        <i class="fas fa-check-circle text-success me-1"></i>
                                        <strong>Validation:</strong> Ch·ªâ LOC LE & THAO LE
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small>
                                        <i class="fas fa-calendar-check text-primary me-1"></i>
                                        <strong>L·ªçc theo ng√†y:</strong> Theo kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Thu Ti·ªÅn -->
<div class="modal fade" id="collectPaymentModal" tabindex="-1" aria-labelledby="collectPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="collectPaymentModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Th√¥ng Tin Thanh To√°n (Ch·ªâ Xem)
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="collectPaymentForm">
                    <div class="mb-3">
                        <label class="form-label">T√™n kh√°ch h√†ng:</label>
                        <div class="fw-bold text-primary" id="modalGuestName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ ƒë·∫∑t ph√≤ng:</label>
                        <div class="fw-bold text-muted" id="modalBookingId"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">T√¨nh tr·∫°ng thanh to√°n:</label>
                        <div class="row">
                            <div class="col-6">
                                <div class="text-muted small">T·ªïng c·∫ßn thu:</div>
                                <div class="fw-bold text-primary" id="modalOriginalAmount"></div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small">ƒê√£ thu:</div>
                                <div class="fw-bold text-success" id="modalCollectedAmount"></div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="text-muted small">C√≤n l·∫°i c·∫ßn thu:</div>
                            <div class="fw-bold text-danger fs-5" id="modalRemainingAmount"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hoa h·ªìng d·ª± ki·∫øn:</label>
                        <div class="fw-bold text-warning fs-6" id="modalCommissionAmount">Ch∆∞a c√≥ th√¥ng tin</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ng∆∞·ªùi thu ti·ªÅn hi·ªán t·∫°i:</label>
                        <div class="fw-bold text-info fs-6" id="modalCollectorName">Ch∆∞a c√≥ ng∆∞·ªùi thu</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi ch√∫ thanh to√°n:</label>
                        <div class="text-muted" id="modalPaymentNote">Kh√¥ng c√≥ ghi ch√∫</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Ch·ªâ hi·ªÉn th·ªã th√¥ng tin.</strong> ƒê·ªÉ th·ª±c hi·ªán thu ti·ªÅn, vui l√≤ng s·ª≠ d·ª•ng n√∫t "S·ª≠a" ri√™ng bi·ªát.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Collected Amount Modal -->
<div class="modal fade" id="editCollectedAmountModal" tabindex="-1" aria-labelledby="editCollectedAmountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="editCollectedAmountModalLabel">
                    <i class="fas fa-dollar-sign me-2"></i>Thu Ti·ªÅn Th·ª±c T·∫ø
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCollectedAmountForm">
                    <div class="mb-3">
                        <label class="form-label">T√™n kh√°ch h√†ng:</label>
                        <div class="fw-bold text-primary" id="collectedModalGuestName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ ƒë·∫∑t ph√≤ng:</label>
                        <div class="fw-bold text-muted" id="collectedModalBookingId"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">T·ªïng s·ªë ti·ªÅn c·∫ßn thu:</label>
                        <div class="fw-bold text-info fs-5" id="collectedModalTotalAmount"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">S·ªë ti·ªÅn ƒë√£ thu hi·ªán t·∫°i:</label>
                        <div class="fw-bold text-success fs-6" id="collectedModalCurrentAmount"></div>
                    </div>
                    <div class="mb-3">
                        <label for="collectedCollectorName" class="form-label">Ng∆∞·ªùi thu ti·ªÅn:</label>
                        <select class="form-select" id="collectedCollectorName" required>
                            <option value="">Ch·ªçn ng∆∞·ªùi thu ti·ªÅn</option>
                            <option value="LOC LE">LOC LE</option>
                            <option value="THAO LE">THAO LE</option>
                        </select>
                        <div class="form-text">
                            <i class="fas fa-user-check me-1"></i>
                            Ch·ªâ LOC LE v√† THAO LE ƒë∆∞·ª£c ph√©p thu ti·ªÅn
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newCollectedAmount" class="form-label">S·ªë ti·ªÅn th·ª±c t·∫ø ƒë√£ thu (VND):</label>
                        <input type="number" class="form-control" id="newCollectedAmount" 
                               placeholder="Nh·∫≠p s·ªë ti·ªÅn th·ª±c t·∫ø ƒë√£ thu" min="0" step="1000">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Nh·∫≠p s·ªë ti·ªÅn th·ª±c t·∫ø ƒë√£ thu t·ª´ kh√°ch h√†ng
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="collectedNote" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn):</label>
                        <textarea class="form-control" id="collectedNote" rows="2" 
                                  placeholder="Ghi ch√∫ v·ªÅ vi·ªác thu ti·ªÅn..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" id="confirmCollectedBtn" onclick="updateCollectedAmount();">
                    <i class="fas fa-check me-1"></i>C·∫≠p nh·∫≠t s·ªë ti·ªÅn ƒë√£ thu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Amount Modal -->
<div class="modal fade" id="editAmountModal" tabindex="-1" aria-labelledby="editAmountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editAmountModalLabel">
                    <i class="fas fa-edit me-2"></i>S·ª≠a S·ªë Ti·ªÅn Kh√°ch H√†ng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAmountForm">
                    <div class="mb-3">
                        <label class="form-label">T√™n kh√°ch h√†ng:</label>
                        <div class="fw-bold text-primary" id="editModalGuestName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ ƒë·∫∑t ph√≤ng:</label>
                        <div class="fw-bold text-muted" id="editModalBookingId"></div>
                    </div>
                    <div class="mb-3">
                        <label for="editRoomAmount" class="form-label">Ti·ªÅn ph√≤ng (VND):</label>
                        <input type="number" class="form-control" id="editRoomAmount" 
                               placeholder="Nh·∫≠p ti·ªÅn ph√≤ng" min="0" step="1000">
                        <div class="form-text">C·∫≠p nh·∫≠t s·ªë ti·ªÅn ph√≤ng c·∫ßn thu</div>
                    </div>
                    <div class="mb-3">
                        <label for="editTaxiAmount" class="form-label">Ti·ªÅn taxi (VND):</label>
                        <input type="number" class="form-control" id="editTaxiAmount" 
                               placeholder="Nh·∫≠p ti·ªÅn taxi" min="0" step="1000">
                        <div class="form-text">C·∫≠p nh·∫≠t s·ªë ti·ªÅn taxi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥)</div>
                    </div>
                    <div class="mb-3">
                        <label for="editCommissionAmount" class="form-label">Hoa h·ªìng (VND):</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="editCommissionAmount" 
                                   placeholder="Nh·∫≠p hoa h·ªìng" min="0" step="1000">
                            <button class="btn btn-outline-secondary" type="button" id="editNoCommissionBtn" 
                                    onclick="toggleEditCommission()">
                                <i class="fas fa-times"></i> Kh√¥ng c√≥
                            </button>
                        </div>
                        <div class="form-text">Hoa h·ªìng hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c gi·ªØ nguy√™n n·∫øu kh√¥ng thay ƒë·ªïi</div>
                    </div>
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <strong>T·ªïng s·ªë ti·ªÅn m·ªõi:</strong> 
                            <span id="editTotalPreview" class="fw-bold">0ƒë</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNote" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn):</label>
                        <textarea class="form-control" id="editNote" rows="2" 
                                  placeholder="L√Ω do thay ƒë·ªïi s·ªë ti·ªÅn..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-warning" id="confirmEditBtn" onclick="updateBookingAmounts()">
                    <i class="fas fa-save me-1"></i>C·∫≠p nh·∫≠t s·ªë ti·ªÅn
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Guest Details Modal -->
<div class="modal fade" id="monthlyGuestDetailsModal" tabindex="-1" aria-labelledby="monthlyGuestDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="monthlyGuestDetailsModalLabel">
                    <i class="fas fa-users me-2"></i>Chi ti·∫øt kh√°ch h√†ng theo th√°ng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading State -->
                <div id="monthlyGuestLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                    <div class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu kh√°ch h√†ng...</div>
                </div>

                <!-- Guest Details Content -->
                <div id="monthlyGuestContent" style="display: none;">
                    <!-- Summary Info -->
                    <div class="alert alert-light border-0 mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">
                                    <i class="fas fa-calendar me-1"></i><span id="modalMonth"></span> - 
                                    <span id="modalStatusLabel" class="fw-bold"></span>
                                </h6>
                                <div class="mb-2">
                                    <span class="badge bg-secondary me-2">
                                        <i class="fas fa-clock me-1"></i>Period: <span id="modalDateRange">Loading...</span>
                                    </span>
                                    <span class="badge bg-info">
                                        <i class="fas fa-filter me-1"></i>Current Filter Applied
                                    </span>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>Detailed guest breakdown with payment amounts
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="fw-bold text-primary fs-5">
                                    T·ªïng: <span id="modalTotalAmount"></span>ƒë
                                </div>
                                <small class="text-muted">
                                    <span id="modalGuestCount"></span> kh√°ch h√†ng
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Guest Table -->
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th><i class="fas fa-user me-1"></i>T√™n kh√°ch</th>
                                    <th><i class="fas fa-hashtag me-1"></i>M√£ ƒë·∫∑t ph√≤ng</th>
                                    <th class="text-end"><i class="fas fa-money-bill me-1"></i>S·ªë ti·ªÅn</th>
                                    <th class="text-center"><i class="fas fa-user-check me-1"></i>Ng∆∞·ªùi thu</th>
                                    <th class="text-center"><i class="fas fa-calendar me-1"></i>Check-in</th>
                                    <th class="text-center"><i class="fas fa-calendar-times me-1"></i>Check-out</th>
                                    <th class="text-end"><i class="fas fa-percentage me-1"></i>Hoa h·ªìng</th>
                                    <th class="text-end"><i class="fas fa-taxi me-1"></i>Taxi</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyGuestTableBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary Section for Uncollected -->
                    <div id="uncollectedSummary" style="display: none;" class="mt-4">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle me-1"></i>Ph√¢n t√≠ch ng∆∞·ªùi thu kh√¥ng h·ª£p l·ªá:</h6>
                            <div id="invalidCollectorBreakdown"></div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Nh·ªØng kh√°ch n√†y ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† "ƒë√£ thu" nh∆∞ng kh√¥ng ph·∫£i do LOC LE ho·∫∑c THAO LE thu, 
                                g√¢y ra s·ª± kh√°c bi·ªát gi·ªØa t·ªïng doanh thu v√† bi·ªÉu ƒë·ªì ng∆∞·ªùi thu.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div id="monthlyGuestError" style="display: none;" class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-1"></i>L·ªói t·∫£i d·ªØ li·ªáu</h6>
                    <p id="monthlyGuestErrorMessage"></p>
                    <button class="btn btn-sm btn-outline-danger" onclick="retryLoadMonthlyGuests()">
                        <i class="fas fa-retry me-1"></i>Th·ª≠ l·∫°i
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ƒê√≥ng
                </button>
                <button type="button" class="btn btn-primary" onclick="exportMonthlyGuestData()">
                    <i class="fas fa-download me-1"></i>Xu·∫•t Excel
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
// ==================== GLOBAL VARIABLES - MUST BE FIRST ====================
var currentEditBookingData = {};
var currentBookingData = {};

// Pass chart data from server to dashboard.js
const monthlyRevenueChartData = {{ monthly_revenue_chart_json | tojson | safe }};
const collectorChartData = {{ collector_chart_json | tojson | safe }};

// ‚úÖ ENHANCED: Populate collector statistics table from chart data
function populateCollectorStatsTable() {
    try {
        const statsBody = document.getElementById('collectorStatsBody');
        if (!statsBody || !collectorChartData || !collectorChartData.data || collectorChartData.data.length === 0) {
            return;
        }

        const chartData = collectorChartData.data[0];
        if (!chartData.labels || !chartData.values) {
            statsBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted">
                        <i class="fas fa-exclamation-triangle me-1"></i>Kh√¥ng c√≥ d·ªØ li·ªáu ng∆∞·ªùi thu
                    </td>
                </tr>
            `;
            return;
        }

        let tableRows = '';
        const total = chartData.values.reduce((sum, val) => sum + val, 0);

        for (let i = 0; i < chartData.labels.length; i++) {
            const collector = chartData.labels[i];
            const amount = chartData.values[i];
            const percentage = total > 0 ? (amount / total * 100).toFixed(1) : 0;
            const bookings = chartData.customdata ? chartData.customdata[i][0] : 'N/A';
            const commission = chartData.customdata ? chartData.customdata[i][1] : 0;

            // Color coding for collectors
            let badgeClass = collector === 'LOC LE' ? 'bg-primary' : collector === 'THAO LE' ? 'bg-success' : 'bg-secondary';

            tableRows += `
                <tr>
                    <td>
                        <span class="badge ${badgeClass} me-1"></span>
                        <strong>${collector}</strong>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-link fw-bold text-dark p-0 border-0 bg-transparent" 
                                onclick="showCollectorGuestDetails('${collector}', ${amount}, ${bookings})"
                                title="Click ƒë·ªÉ xem chi ti·∫øt kh√°ch c·ªßa ${collector}">
                            <i class="fas fa-eye me-1"></i>${amount.toLocaleString()}ƒë
                        </button>
                        ${commission > 0 ? `<small class="text-muted d-block">HH: ${commission.toLocaleString()}ƒë</small>` : ''}
                    </td>
                    <td class="text-center">
                        <span class="badge bg-light text-dark">${bookings}</span>
                    </td>
                    <td class="text-center">
                        <div class="progress" style="height: 20px; width: 60px;">
                            <div class="progress-bar ${badgeClass.replace('bg-', 'bg-')}" 
                                 style="width: ${percentage}%;"
                                 title="${percentage}%">
                                <small class="fw-bold text-white">${percentage}%</small>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Add total row
        const totalBookings = chartData.customdata ? 
            chartData.customdata.reduce((sum, item) => sum + item[0], 0) : 'N/A';
        const totalCommission = chartData.customdata ? 
            chartData.customdata.reduce((sum, item) => sum + item[1], 0) : 0;

        tableRows += `
            <tr class="table-info fw-bold">
                <td><i class="fas fa-calculator me-1"></i><strong>T·ªîNG C·ªòNG</strong></td>
                <td class="text-end">
                    <div class="fw-bold text-primary">${total.toLocaleString()}ƒë</div>
                    ${totalCommission > 0 ? `<small class="text-muted">HH: ${totalCommission.toLocaleString()}ƒë</small>` : ''}
                </td>
                <td class="text-center">
                    <span class="badge bg-primary">${totalBookings}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-success">100%</span>
                </td>
            </tr>
        `;

        statsBody.innerHTML = tableRows;
        console.log('‚úÖ [COLLECTOR_STATS] Table populated with detailed collector data');

    } catch (error) {
        console.error('‚ùå [COLLECTOR_STATS] Error populating table:', error);
        const statsBody = document.getElementById('collectorStatsBody');
        if (statsBody) {
            statsBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu
                    </td>
                </tr>
            `;
        }
    }
}

// Initialize collector stats table when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        populateCollectorStatsTable();
    }, 100);
});

// Quick Notes functionality
document.addEventListener('DOMContentLoaded', function() {
    // Load QuickNotes asynchronously to prevent blocking
    setTimeout(() => {
        try {
            loadQuickNotesOnDashboard();
        } catch (error) {
            console.error('Failed to load QuickNotes:', error);
            document.getElementById('quickNotesContainer').innerHTML = `
                <div class="text-center py-1">
                    <small class="text-white">L·ªói t·∫£i ghi ch√∫</small>
                </div>
            `;
        }
    }, 50);
});

// DISABLED: This function has been moved to /static/js/dashboard.js to avoid conflicts
// The external JS file now handles openCollectModal with proper null checks
/*
function openCollectModal(bookingId, guestName, totalAmount, commission, roomFee, taxiFee, collectedAmount) {
    // FIXED: Add debug logging and parameter validation
    console.log('[CollectModal] Called with:', {bookingId, guestName, totalAmount, commission, roomFee, taxiFee, collectedAmount});
    
    // Validate required parameters
    if (!bookingId || !guestName) {
        console.error('[CollectModal] Missing required parameters');
        alert('‚ö†Ô∏è Missing booking information. Please refresh the page.');
        return;
    }
    
    // Store booking data for later use
    currentBookingData = {
        bookingId: bookingId,
        guestName: guestName,
        totalAmount: totalAmount || 0,
        commission: commission || 0,
        roomFee: roomFee || totalAmount || 0,
        taxiFee: taxiFee || 0,
        collectedAmount: collectedAmount || 0
    };
    
    // Reset form
    document.getElementById('collectPaymentForm').reset();
    document.getElementById('noTaxi').checked = true; // Default to no taxi
    document.getElementById('hasTaxi').checked = false;
    document.getElementById('taxiAmountGroup').style.display = 'none';
    
    // Reset commission type to default
    document.getElementById('hasCommission').checked = true;
    document.getElementById('noCommission').checked = false;
    
    // Populate modal data
    document.getElementById('modalGuestName').textContent = guestName;
    document.getElementById('modalBookingId').textContent = bookingId;
    
    // Populate new payment status fields with null checks
    const collected = collectedAmount || 0;
    const remaining = Math.max(0, totalAmount - collected);
    
    const modalOriginalAmount = document.getElementById('modalOriginalAmount');
    const modalCollectedAmount = document.getElementById('modalCollectedAmount');
    const modalRemainingAmount = document.getElementById('modalRemainingAmount');
    
    if (modalOriginalAmount) {
        modalOriginalAmount.textContent = totalAmount.toLocaleString() + 'ƒë';
    } else {
        console.error('[CollectModal] modalOriginalAmount element not found');
    }
    
    if (modalCollectedAmount) {
        modalCollectedAmount.textContent = collected.toLocaleString() + 'ƒë';
    } else {
        console.error('[CollectModal] modalCollectedAmount element not found');
    }
    
    if (modalRemainingAmount) {
        modalRemainingAmount.textContent = remaining.toLocaleString() + 'ƒë';
    } else {
        console.error('[CollectModal] modalRemainingAmount element not found');
    }
    
    // Show commission info
    const commissionElement = document.getElementById('modalCommissionAmount');
    if (commission && commission > 0) {
        commissionElement.textContent = commission.toLocaleString() + 'ƒë';
        commissionElement.parentElement.style.display = 'block';
    } else {
        commissionElement.textContent = 'Ch∆∞a c√≥ th√¥ng tin';
        commissionElement.parentElement.style.display = 'block';
    }
    
    // Add event listeners for commission type changes with error handling
    try {
        const hasCommissionEl = document.getElementById('hasCommission');
        const noCommissionEl = document.getElementById('noCommission');
        
        if (hasCommissionEl) {
            hasCommissionEl.addEventListener('change', function() {
                if (this.checked) {
                    updateCommissionDisplay(commission);
                    // Restore original commission in input field
                    if (commission && commission > 0) {
                        document.getElementById('commissionAmountInput').value = commission;
                    }
                }
            });
        }
        
        if (noCommissionEl) {
            noCommissionEl.addEventListener('change', function() {
                if (this.checked) {
                    updateCommissionDisplay(0);
                }
            });
        }
    } catch (e) {
        console.error('Error setting up commission event listeners:', e);
    }
    
    // üöï Add event listeners for taxi checkboxes with error handling
    try {
        const hasTaxiCheckbox = document.getElementById('hasTaxi');
        const noTaxiCheckbox = document.getElementById('noTaxi');
        const taxiAmountGroup = document.getElementById('taxiAmountGroup');
        const taxiAmountInput = document.getElementById('taxiAmount');
        
        if (hasTaxiCheckbox && noTaxiCheckbox && taxiAmountGroup) {
            // Remove existing event listeners first (prevent duplicates)
            hasTaxiCheckbox.replaceWith(hasTaxiCheckbox.cloneNode(true));
            noTaxiCheckbox.replaceWith(noTaxiCheckbox.cloneNode(true));
            
            // Get fresh references after cloning
            const freshHasTaxiCheckbox = document.getElementById('hasTaxi');
            const freshNoTaxiCheckbox = document.getElementById('noTaxi');
            
            if (freshHasTaxiCheckbox) {
                freshHasTaxiCheckbox.addEventListener('change', function() {
                    const taxiGroup = document.getElementById('taxiAmountGroup');
                    const noTaxi = document.getElementById('noTaxi');
                    if (this.checked) {
                        if (noTaxi) noTaxi.checked = false;
                        if (taxiGroup) taxiGroup.style.display = 'block';
                    } else {
                        if (taxiGroup) taxiGroup.style.display = 'none';
                    }
                });
            }
            
            if (freshNoTaxiCheckbox) {
                freshNoTaxiCheckbox.addEventListener('change', function() {
                    const hasTaxi = document.getElementById('hasTaxi');
                    const taxiGroup = document.getElementById('taxiAmountGroup');
                    const taxiInput = document.getElementById('taxiAmount');
                    if (this.checked) {
                        if (hasTaxi) hasTaxi.checked = false;
                        if (taxiGroup) taxiGroup.style.display = 'none';
                        if (taxiInput) taxiInput.value = '';
                    }
                });
            }
            
            console.log('‚úÖ Taxi event listeners set up successfully');
        } else {
            console.warn('‚ö†Ô∏è Some taxi elements not found:', {hasTaxiCheckbox, noTaxiCheckbox, taxiAmountGroup});
        }
    } catch (e) {
        console.error('üö® Error setting up taxi event listeners:', e);
    }
    
    // Set default collected amount to total amount for room payment
    document.getElementById('collectedAmount').value = totalAmount;
    
    // Set default commission amount in input field
    if (commission && commission > 0) {
        document.getElementById('commissionAmountInput').value = commission;
        document.getElementById('commissionAmountInput').placeholder = `M·∫∑c ƒë·ªãnh: ${commission.toLocaleString()}ƒë`;
    } else {
        document.getElementById('commissionAmountInput').value = '';
        document.getElementById('commissionAmountInput').placeholder = 'Nh·∫≠p s·ªë ti·ªÅn hoa h·ªìng';
    }
    
    // Initialize commission input visibility
    toggleCommissionInput();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('collectPaymentModal'));
    modal.show();
}
*/
// END OF DISABLED FUNCTION

// Function to toggle commission input field visibility
function toggleCommissionInput() {
    const hasCommissionSelected = document.getElementById('hasCommission').checked;
    const commissionAmountGroup = document.getElementById('commissionAmountGroup');
    
    if (hasCommissionSelected) {
        commissionAmountGroup.style.display = 'block';
        // Restore original commission amount if available
        if (currentBookingData && currentBookingData.commission && currentBookingData.commission > 0) {
            document.getElementById('commissionAmountInput').value = currentBookingData.commission;
        }
    } else {
        commissionAmountGroup.style.display = 'none';
        // Don't clear the input - just hide it to preserve the value
    }
}

// Function to update commission display based on selected type
function updateCommissionDisplay(originalCommission) {
    const commissionElement = document.getElementById('modalCommissionAmount');
    const noCommissionSelected = document.getElementById('noCommission').checked;
    
    if (noCommissionSelected) {
        commissionElement.textContent = '0ƒë (Kh√¥ng c√≥ hoa h·ªìng)';
        commissionElement.className = 'fw-bold text-muted fs-6';
    } else {
        if (originalCommission && originalCommission > 0) {
            commissionElement.textContent = originalCommission.toLocaleString() + 'ƒë';
            commissionElement.className = 'fw-bold text-warning fs-6';
        } else {
            commissionElement.textContent = 'Ch∆∞a c√≥ th√¥ng tin';
            commissionElement.className = 'fw-bold text-warning fs-6';
        }
    }
}

function collectPayment() {
    try {
        console.log('collectPayment function started');
        
        // Get modal elements with null checking
        const taxiAmountElement = document.getElementById('taxiAmount');
        const collectorElement = document.getElementById('collectorName');
        const paymentNoteElement = document.getElementById('paymentNote');
        const noCommissionElement = document.getElementById('noCommission');
        const hasTaxiElement = document.getElementById('hasTaxi');
        
        if (!collectorElement) {
            alert('‚ùå Collector element not found! Please refresh.');
            return;
        }
        
        const collectorName = collectorElement.value;
        const paymentNote = paymentNoteElement ? paymentNoteElement.value.trim() : '';
        const noCommissionSelected = noCommissionElement ? noCommissionElement.checked : false;
        
        // FIXED: Taxi detection logic with radio buttons
        const taxiAmountValue = taxiAmountElement ? (parseFloat(taxiAmountElement.value) || 0) : 0;
        const hasTaxi = hasTaxiElement ? hasTaxiElement.checked : false; // Radio button: "C√≥ taxi"
        const isTaxiMode = hasTaxi && (taxiAmountValue > 0); // Must have taxi selected AND amount > 0
        
        console.log('üöï FIXED TAXI DETECTION:', {
            taxiAmountValue: taxiAmountValue,
            hasTaxiRadio: hasTaxi,
            isTaxiMode: isTaxiMode,
            note: 'Radio button logic: taxi only if "C√≥ taxi" selected AND amount > 0'
        });
    
        let collectedAmount = 0;
        let finalNote = paymentNote;
        let paymentType = 'room';
        
        // Simple commission detection
        let finalCommission = 0;
        const commissionInputElement = document.getElementById('commissionAmountInput');
        
        if (!noCommissionSelected && commissionInputElement) {
            finalCommission = parseFloat(commissionInputElement.value) || 0;
        }
        
        console.log('COMMISSION:', {
            amount: finalCommission,
            noCommission: noCommissionSelected
        });
        
        // FIXED: Always use the actual collected amount from user input
        const collectedAmountInput = document.getElementById('collectedAmount');
        collectedAmount = collectedAmountInput ? (parseFloat(collectedAmountInput.value) || 0) : 0;
        
        console.log('üí∞ COLLECTED AMOUNT FROM USER INPUT:', collectedAmount);
        
        // Payment type decision
        if (isTaxiMode && taxiAmountValue > 0) {
            // Taxi payment - update taxi amount in database
            finalNote = paymentNote || `Thu taxi ${collectedAmount.toLocaleString()}ƒë (taxi amount: ${taxiAmountValue.toLocaleString()}ƒë)`;
            paymentType = 'taxi';
            console.log('‚úÖ TAXI MODE - collected:', collectedAmount, 'taxi_amount:', taxiAmountValue);
        } else if (isTaxiMode && taxiAmountValue === 0) {
            alert('‚ùå Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn taxi!');
            return;
        } else {
            // Room payment (default)
            finalNote = paymentNote || `Thu ph√≤ng ${collectedAmount.toLocaleString()}ƒë`;
            paymentType = 'room';
            console.log('‚úÖ ROOM MODE - collected:', collectedAmount);
        }
        
        // Validation
        if (!collectorName) {
            alert('‚ùå Vui l√≤ng ch·ªçn ng∆∞·ªùi thu ti·ªÅn!');
            return;
        }
        
        if (collectedAmount <= 0) {
            alert('‚ùå S·ªë ti·ªÅn thu kh√¥ng h·ª£p l·ªá!');
            return;
        }
        
        // Validate commission amount if commission is selected
        if (!noCommissionSelected && finalCommission <= 0) {
            alert('‚ùå Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn hoa h·ªìng!');
            return;
        }
        
        // Disable button and show loading
        const confirmBtn = document.getElementById('confirmCollectBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x·ª≠ l√Ω...';
        confirmBtn.disabled = true;
        
        // Add commission info to note if no commission selected
        if (noCommissionSelected) {
            finalNote += ' (Kh√¥ng c√≥ hoa h·ªìng)';
        }
        
        // Prepare data
        const requestData = {
            booking_id: currentBookingData.bookingId,
            collected_amount: collectedAmount,
            collector_name: collectorName,
            payment_note: finalNote,
            payment_type: paymentType,
            commission_amount: finalCommission,
            commission_type: noCommissionSelected ? 'none' : 'normal'
        };
        
        // Add taxi amount for taxi payments (separate from collected amount)
        if (paymentType === 'taxi' && taxiAmountValue > 0) {
            requestData.taxi_amount = taxiAmountValue;
            console.log('üöï Added taxi_amount to request:', taxiAmountValue);
        }
        
        // Log final request data
        console.log('üì§ SENDING REQUEST:', requestData);
        
        // Call API
        fetch('/api/collect_payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showDashboardToast(`‚úÖ ${data.message}`, 'success');
                
                // Close modal first
                const modal = bootstrap.Modal.getInstance(document.getElementById('collectPaymentModal'));
                modal.hide();
                
                // Force immediate page reload to show updated data
                setTimeout(() => {
                    window.location.reload(true); // Force reload from server
                }, 800);
            } else {
                throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
            }
        })
        .catch(error => {
            console.error('Collect payment error:', error);
            showDashboardToast(`‚ùå L·ªói: ${error.message}`, 'error');
        })
        .finally(() => {
            // Restore button
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        });
        
    } catch (error) {
        console.error('üö® [ERROR] collectPayment function crashed:', error);
        alert('‚ùå L·ªói h·ªá th·ªëng: ' + error.message + '\n\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c refresh trang.');
    }
}

// Update overdue guests section after successful payment
function updateOverdueGuestsAfterPayment(bookingId, collectedAmount, paymentType) {
    // Find and remove the specific guest card
    const guestCards = document.querySelectorAll('.col-md-4');
    let removedGuestCard = null;
    
    guestCards.forEach(card => {
        const bookingIdElement = card.querySelector('small.text-muted:last-child');
        if (bookingIdElement && bookingIdElement.textContent.includes(bookingId)) {
            // Store the guest info before removing
            const guestNameElement = card.querySelector('h6.mb-1');
            const guestName = guestNameElement ? guestNameElement.textContent : 'Unknown';
            
            // Add a fade-out animation
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '0.3';
            card.style.transform = 'scale(0.95)';
            
            // Remove after animation
            setTimeout(() => {
                card.style.display = 'none';
                // Show success feedback
                showDashboardToast(`üí∞ ƒê√£ thu ${collectedAmount.toLocaleString()}ƒë t·ª´ ${guestName}`, 'success');
            }, 500);
            
            removedGuestCard = card;
        }
    });
    
    // Update the total amount and guest count
    setTimeout(() => {
        updateOverdueGuestsSummary(collectedAmount);
        
        // Check if no more overdue guests remain
        const remainingCards = document.querySelectorAll('.col-md-4:not([style*="display: none"])');
        const actualRemainingCards = Array.from(remainingCards).filter(card => {
            return card.style.display !== 'none' && !card.querySelector('h6.mb-1')?.textContent?.includes('N/A');
        });
        
        if (actualRemainingCards.length === 0) {
            // Hide the entire overdue section
            const overdueSection = document.querySelector('.alert.alert-danger');
            if (overdueSection) {
                overdueSection.style.transition = 'all 0.8s ease';
                overdueSection.style.opacity = '0';
                overdueSection.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    overdueSection.style.display = 'none';
                    showDashboardToast('üéâ Kh√¥ng c√≤n kh√°ch n√†o ch∆∞a thu ti·ªÅn!', 'success');
                }, 800);
            }
        }
    }, 600);
}

// Update the summary numbers in overdue section
function updateOverdueGuestsSummary(paidAmount) {
    // Update guest count
    const guestCountElement = document.querySelector('.alert-danger p');
    if (guestCountElement) {
        const currentText = guestCountElement.textContent;
        const currentCount = parseInt(currentText.match(/(\d+)/)?.[1] || '0');
        const newCount = Math.max(0, currentCount - 1);
        
        guestCountElement.textContent = `${newCount} kh√°ch ƒë√£ check-in nh∆∞ng ch∆∞a thu ti·ªÅn`;
    }
    
    // Update total amount
    const totalAmountElement = document.querySelector('.alert-danger .h5');
    if (totalAmountElement) {
        const currentAmountText = totalAmountElement.textContent.replace(/[^\d]/g, '');
        const currentAmount = parseInt(currentAmountText) || 0;
        const newAmount = Math.max(0, currentAmount - paidAmount);
        
        totalAmountElement.textContent = `${newAmount.toLocaleString()}ƒë`;
    }
}

// Update guest card amounts after editing (FIXED - Works with table structure)
function updateGuestCardAmounts(bookingId, newRoomAmount, newTaxiAmount) {
    // Calculate new total
    const newTotal = newRoomAmount + newTaxiAmount;
    
    // Find the guest row in the overdue table
    const overdueTable = document.querySelector('.table-responsive table tbody');
    if (overdueTable) {
        const rows = overdueTable.querySelectorAll('tr');
        
        rows.forEach(row => {
            // Find booking ID in the row (it's in the text-muted div at the end)
            const bookingIdText = row.querySelector('.text-muted');
            if (bookingIdText && bookingIdText.textContent.includes(bookingId)) {
                
                // Update the total amount display (fw-bold text-danger small)
                const totalAmountElement = row.querySelector('.fw-bold.text-danger.small');
                if (totalAmountElement) {
                    // Add update animation
                    totalAmountElement.style.transition = 'all 0.3s ease';
                    totalAmountElement.style.transform = 'scale(1.1)';
                    totalAmountElement.style.color = '#28a745'; // Green for update
                    
                    setTimeout(() => {
                        totalAmountElement.textContent = `${newTotal.toLocaleString()}ƒë`;
                        
                        setTimeout(() => {
                            totalAmountElement.style.transform = 'scale(1)';
                            totalAmountElement.style.color = '#dc3545'; // Back to red
                        }, 200);
                    }, 150);
                }
                
                // Update commission info if exists (shows in the same cell)
                const commissionElement = row.querySelector('.text-muted .fas.fa-percentage');
                if (commissionElement) {
                    const commissionContainer = commissionElement.parentElement;
                    // Keep existing commission or reset if needed
                }
                
                // Update the collect button onclick handler
                const collectButton = row.querySelector('button.btn-success');
                if (collectButton) {
                    const onclickAttr = collectButton.getAttribute('onclick');
                    if (onclickAttr) {
                        // Get guest name from the row
                        const guestNameElement = row.querySelector('.fw-bold.text-dark.small');
                        const guestName = guestNameElement ? guestNameElement.textContent : currentEditBookingData.guestName;
                        
                        // Update the onclick with new amounts
                        const updatedOnclick = onclickAttr.replace(
                            /openCollectModal\([^)]+\)/,
                            `openCollectModal('${bookingId}', '${guestName}', ${newTotal}, 0, ${newRoomAmount}, ${newTaxiAmount}, 0)`
                        );
                        collectButton.setAttribute('onclick', updatedOnclick);
                    }
                }
                
                // Update the edit button onclick handler
                const editButton = row.querySelector('button.btn-outline-primary');
                if (editButton) {
                    const onclickAttr = editButton.getAttribute('onclick');
                    if (onclickAttr) {
                        // Get guest name from the row
                        const guestNameElement = row.querySelector('.fw-bold.text-dark.small');
                        const guestName = guestNameElement ? guestNameElement.textContent : currentEditBookingData.guestName;
                        
                        // Update the onclick with new amounts
                        const updatedOnclick = onclickAttr.replace(
                            /openEditAmountModal\([^)]+\)/,
                            `openEditAmountModal('${bookingId}', '${guestName}', ${newRoomAmount}, ${newTaxiAmount})`
                        );
                        editButton.setAttribute('onclick', updatedOnclick);
                    }
                }
                
                console.log(`‚úÖ Updated amounts for ${bookingId}: Room=${newRoomAmount}ƒë, Taxi=${newTaxiAmount}ƒë, Total=${newTotal}ƒë`);
            }
        });
    }
    
    // Update the overdue total summary
    setTimeout(() => {
        recalculateOverdueTotal();
    }, 400);
    
    // Show success feedback
    showDashboardToast(`üìù ƒê√£ c·∫≠p nh·∫≠t s·ªë ti·ªÅn cho ${currentEditBookingData.guestName}`, 'success');
}

// Recalculate total overdue amount from table rows (FIXED)
function recalculateOverdueTotal() {
    const overdueTable = document.querySelector('.table-responsive table tbody');
    let totalAmount = 0;
    let totalGuests = 0;
    
    if (overdueTable) {
        const rows = overdueTable.querySelectorAll('tr');
        
        rows.forEach(row => {
            const amountElement = row.querySelector('.fw-bold.text-danger.small');
            if (amountElement) {
                const amountText = amountElement.textContent.replace(/[^\d]/g, '');
                const amount = parseInt(amountText) || 0;
                if (amount > 0) {
                    totalAmount += amount;
                    totalGuests++;
                }
            }
        });
    }
    
    // Update the header total (in the overdue section header)
    const headerTotalElement = document.querySelector('.card.border-0.shadow-sm .text-white.text-end .fw-bold');
    if (headerTotalElement) {
        headerTotalElement.textContent = `${totalAmount.toLocaleString()}ƒë`;
        console.log(`üìä Updated overdue total: ${totalAmount.toLocaleString()}ƒë for ${totalGuests} guests`);
    }
    
    // Update the guest count in the header title
    const titleElement = document.querySelector('.card.border-0.shadow-sm h6 .text-white.fw-bold');
    if (titleElement) {
        const currentText = titleElement.textContent;
        const updatedText = currentText.replace(/\(\d+\)/, `(${totalGuests})`);
        titleElement.textContent = updatedText;
    }
}

function loadQuickNotesOnDashboard() {
    const container = document.getElementById('quickNotesContainer');
    
    // Try to load from server first, fallback to localStorage
    loadQuickNotesFromServer()
        .then(serverNotes => {
            displayQuickNotes(serverNotes, container);
        })
        .catch(error => {
            console.log('Loading from localStorage as fallback...');
            const localNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            displayQuickNotes(localNotes, container);
        });
}

async function loadQuickNotesFromServer() {
    try {
        const response = await fetch('/api/quick_notes');
        const data = await response.json();
        
        // ‚úÖ CRITICAL FIX: Backend returns array directly, not wrapped object
        if (Array.isArray(data)) {
            // Convert server format to client format
            const convertedNotes = data.map(note => ({
                id: note.note_id.toString(), // ‚úÖ FIX: Use note_id not id
                type: note.note_type, // ‚úÖ FIX: Use note_type not type  
                content: note.content,
                date: note.date || new Date().toISOString().split('T')[0], // Fallback to today
                time: note.time || '12:00', // Fallback time
                guestName: note.created_by || '',
                created_at: note.created_at,
                completed: note.completed || false
            }));
            
            // Also save to localStorage for offline access
            localStorage.setItem('quickNotes', JSON.stringify(convertedNotes));
            
            return convertedNotes;
        } else {
            console.error('Unexpected response format:', data);
            throw new Error('Failed to load from server');
        }
    } catch (error) {
        console.error('Error loading from server:', error);
        throw error;
    }
}

function displayQuickNotes(notes, container) {
    // Filter active notes (not completed)
    const activeNotes = notes.filter(note => !note.completed);
    
    if (activeNotes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-2">
                <small class="text-white-50">No quick notes</small>
                <button class="btn btn-light btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#quickNotesModal">
                    <i class="fas fa-plus me-1"></i>Add Note
                </button>
            </div>
        `;
        return;
    }
    
    const typeIcons = {
        'thu-tien': 'fas fa-money-bill-wave',
        'huy-phong': 'fas fa-times-circle',
        'taxi': 'fas fa-taxi',
        'Ghi ch√∫': 'fas fa-sticky-note',
        'Thu ti·ªÅn': 'fas fa-money-bill-wave',
        'H·ªßy ph√≤ng': 'fas fa-times-circle',
        'Taxi': 'fas fa-taxi'
    };
    
    const typeNames = {
        'thu-tien': 'Thu ti·ªÅn l·∫°i',
        'huy-phong': 'H·ªßy ph√≤ng', 
        'taxi': 'Taxi',
        'Ghi ch√∫': 'Ghi ch√∫',
        'Thu ti·ªÅn': 'Thu ti·ªÅn',
        'H·ªßy ph√≤ng': 'H·ªßy ph√≤ng',
        'Taxi': 'Taxi'
    };
    
    const typeColors = {
        'thu-tien': 'success',
        'huy-phong': 'danger',
        'taxi': 'warning',
        'Ghi ch√∫': 'info',
        'Thu ti·ªÅn': 'success',
        'H·ªßy ph√≤ng': 'danger',
        'Taxi': 'warning'
    };
    
    // Sort by reminder date/time
    activeNotes.sort((a, b) => {
        const dateA = new Date(`${a.date} ${a.time}`);
        const dateB = new Date(`${b.date} ${b.time}`);
        return dateA - dateB;
    });
    
    const notesHtml = activeNotes.map(note => {
        const reminderDate = new Date(`${note.date} ${note.time}`);
        const now = new Date();
        const isOverdue = reminderDate < now;
        const isToday = reminderDate.toDateString() === now.toDateString();
        
        let timeStatus = '';
        if (isOverdue) {
            timeStatus = '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Qu√° h·∫°n</span>';
        } else if (isToday) {
            timeStatus = '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>H√¥m nay</span>';
        } else {
            const diffTime = Math.abs(reminderDate - now);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            timeStatus = `<span class="badge bg-info">${diffDays} ng√†y n·ªØa</span>`;
        }
        
        return `
            <div class="col-12 mb-1">
                <div class="bg-white rounded border p-2 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center flex-grow-1">
                        <i class="${typeIcons[note.type] || 'fas fa-sticky-note'} text-${typeColors[note.type] || 'secondary'} me-2"></i>
                        <div class="me-2">
                            <span class="fw-bold text-dark small">${typeNames[note.type] || note.type || 'Note'}</span>
                            ${timeStatus}
                        </div>
                        <div class="text-muted small flex-grow-1">${note.content || 'Kh√¥ng c√≥ ghi ch√∫'}</div>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary btn-sm px-1" onclick="editQuickNote('${note.id}', '${note.type}', '${note.content.replace(/'/g, "\\'")}', '${note.date}', '${note.time}', '${note.guestName || ""}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-success btn-sm px-1" onclick="markNoteCompleted('${note.id}')" title="Complete">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm px-1" onclick="deleteQuickNote('${note.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="row">
            ${notesHtml}
        </div>
    `;
}


async function markNoteCompleted(noteId) {
    try {
        // Delete from server immediately when marked complete
        const response = await fetch(`/api/quick_notes/${noteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove from localStorage immediately
            let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            notes = notes.filter(note => note.id !== noteId);
            localStorage.setItem('quickNotes', JSON.stringify(notes));
            
            // Show success toast
            showDashboardToast('‚úÖ ƒê√£ ho√†n th√†nh v√† x√≥a note kh·ªèi h·ªá th·ªëng!', 'success');
            
            // Reload notes display
            loadQuickNotesOnDashboard();
        } else {
            throw new Error(data.message || 'Server error');
        }
    } catch (error) {
        console.error('Error completing note:', error);
        showDashboardToast('‚ùå L·ªói khi x√≥a tr√™n server. ƒê√£ x√≥a local.', 'warning');
        
        // Fallback to localStorage only - still delete locally
        let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
        notes = notes.filter(note => note.id !== noteId);
        localStorage.setItem('quickNotes', JSON.stringify(notes));
        loadQuickNotesOnDashboard();
    }
}

async function deleteNoteFromDashboard(noteId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a note n√†y kh·ªèi Google Sheets?')) {
        try {
            // Delete from server first
            const response = await fetch(`/api/quick_notes/${noteId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Also delete from localStorage
                let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
                notes = notes.filter(note => note.id !== noteId);
                localStorage.setItem('quickNotes', JSON.stringify(notes));
                
                showDashboardToast('üóëÔ∏è ƒê√£ x√≥a note kh·ªèi Google Sheets!', 'info');
                loadQuickNotesOnDashboard();
            } else {
                throw new Error(data.message || 'Server error');
            }
        } catch (error) {
            console.error('Error deleting note:', error);
            showDashboardToast('‚ùå L·ªói khi x√≥a tr√™n server. ƒê√£ x√≥a local.', 'warning');
            
            // Fallback to localStorage only
            let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            notes = notes.filter(note => note.id !== noteId);
            localStorage.setItem('quickNotes', JSON.stringify(notes));
            loadQuickNotesOnDashboard();
        }
    }
}

// Export Quick Notes to JSON file
function exportQuickNotes() {
    const notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
    
    if (notes.length === 0) {
        showDashboardToast('‚ö†Ô∏è Kh√¥ng c√≥ notes n√†o ƒë·ªÉ export!', 'warning');
        return;
    }
    
    // Create export data
    const exportData = {
        exportDate: new Date().toISOString(),
        totalNotes: notes.length,
        quickNotes: notes
    };
    
    // Create and download file
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `quick-notes-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showDashboardToast('üì• ƒê√£ export Quick Notes th√†nh c√¥ng!', 'success');
}

// Import Quick Notes from JSON file
function importQuickNotes() {
    document.getElementById('quickNotesFileInput').click();
}

function handleQuickNotesImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.name.endsWith('.json')) {
        showDashboardToast('‚ùå Vui l√≤ng ch·ªçn file JSON!', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Validate data structure
            if (!importedData.quickNotes || !Array.isArray(importedData.quickNotes)) {
                throw new Error('Invalid file format');
            }
            
            // Get existing notes
            const existingNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            
            // Ask user how to handle import
            const choice = confirm(
                `T√¨m th·∫•y ${importedData.quickNotes.length} notes trong file.\n\n` +
                `B·∫°n c√≥ ${existingNotes.length} notes hi·ªán t·∫°i.\n\n` +
                `Nh·∫•n OK ƒë·ªÉ THAY TH·∫æ t·∫•t c·∫£ notes hi·ªán t·∫°i\n` +
                `Nh·∫•n Cancel ƒë·ªÉ H·ª¶Y import`
            );
            
            if (choice) {
                // Replace all notes
                localStorage.setItem('quickNotes', JSON.stringify(importedData.quickNotes));
                loadQuickNotesOnDashboard();
                showDashboardToast(`‚úÖ ƒê√£ import ${importedData.quickNotes.length} notes th√†nh c√¥ng!`, 'success');
            } else {
                showDashboardToast('‚ùå ƒê√£ h·ªßy import', 'info');
            }
            
        } catch (error) {
            console.error('Import error:', error);
            showDashboardToast('‚ùå L·ªói ƒë·ªçc file! Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file.', 'error');
        }
    };
    
    reader.readAsText(file);
    // Reset file input
    event.target.value = '';
}

// Sync Quick Notes from Google Sheets
async function syncQuickNotes() {
    const syncBtn = document.querySelector('button[onclick="syncQuickNotes()"]');
    const originalHtml = syncBtn.innerHTML;
    
    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang sync...';
    syncBtn.disabled = true;
    
    try {
        const serverNotes = await loadQuickNotesFromServer();
        showDashboardToast(`‚úÖ ƒê√£ t·∫£i ${serverNotes.length} ghi ch√∫ t·ª´ database!`, 'success');
        loadQuickNotesOnDashboard();
    } catch (error) {
        console.error('Sync error:', error);
        showDashboardToast('‚ùå L·ªói khi t·∫£i ghi ch√∫ t·ª´ database!', 'error');
    } finally {
        syncBtn.innerHTML = originalHtml;
        syncBtn.disabled = false;
    }
}

function refreshQuickNotes() {
    const refreshBtn = document.querySelector('button[onclick="refreshQuickNotes()"]');
    const originalHtml = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang t·∫£i...';
    refreshBtn.disabled = true;
    
    setTimeout(() => {
        loadQuickNotesOnDashboard();
        refreshBtn.innerHTML = originalHtml;
        refreshBtn.disabled = false;
        showDashboardToast('üîÑ ƒê√£ l√†m m·ªõi Quick Notes!', 'info');
    }, 500);
}

function showDashboardToast(message, type = 'success') {
    const colors = {
        success: 'bg-success',
        error: 'bg-danger', 
        info: 'bg-info',
        warning: 'bg-warning'
    };
    
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 end-0 m-3 p-3 ${colors[type]} text-white rounded`;
    toast.style.zIndex = '9999';
    toast.innerHTML = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ==================== PIN NOTIFICATION FUNCTIONS ====================
function scrollToOvercrowdedSection() {
    const section = document.getElementById('overcrowdedSection');
    if (section) {
        section.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
        
        // Highlight the section briefly
        section.style.boxShadow = '0 0 20px rgba(255, 149, 0, 0.8)';
        setTimeout(() => {
            section.style.boxShadow = '';
        }, 2000);
    }
}

function dismissPinNotification() {
    const notification = document.querySelector('.fixed-top.alert-warning');
    const spacer = notification?.nextElementSibling;
    
    if (notification) {
        notification.style.transform = 'translateY(-100%)';
        setTimeout(() => {
            notification.remove();
            if (spacer && spacer.style.height === '80px') {
                spacer.remove();
            }
        }, 300);
        
        // Save dismiss state for this session
        sessionStorage.setItem('overcrowdedPinDismissed', 'true');
        showDashboardToast('‚ÑπÔ∏è Notification ƒë√£ ƒë∆∞·ª£c ·∫©n cho phi√™n n√†y', 'info');
    }
}

// Check if pin notification should be shown
document.addEventListener('DOMContentLoaded', function() {
    const dismissed = sessionStorage.getItem('overcrowdedPinDismissed');
    const pinNotification = document.querySelector('.fixed-top.alert-warning');
    
    if (dismissed === 'true' && pinNotification) {
        pinNotification.style.display = 'none';
        const spacer = pinNotification.nextElementSibling;
        if (spacer && spacer.style.height === '80px') {
            spacer.style.display = 'none';
        }
    }
});

// Toggle overcrowded details section
function toggleOvercrowdedDetails() {
    const details = document.getElementById('overcrowdedDetails');
    const toggleText = document.getElementById('overcrowdToggleText');
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        toggleText.textContent = '·∫®n chi ti·∫øt';
    } else {
        details.style.display = 'none';
        toggleText.textContent = 'Chi ti·∫øt';
    }
}

// Show day details modal
function showDayDetails(date, guestCount, guestNames, bookingIds, dailyTotal, individualAmounts) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-calendar-day me-2"></i>Chi ti·∫øt doanh thu ng√†y: ${date}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <strong><i class="fas fa-coins me-2"></i>T·ªïng doanh thu:</strong> 
                        <span class="fs-5 fw-bold">${dailyTotal ? dailyTotal.toLocaleString() : '0'}ƒë</span>
                        <small class="text-muted ms-2">(${guestCount} kh√°ch check-in)</small>
                    </div>
                    <h6><i class="fas fa-list me-2"></i>Danh s√°ch kh√°ch v√† s·ªë ti·ªÅn:</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>T√™n kh√°ch</th>
                                    <th>S·ªë ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${guestNames.map((name, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td><strong>${name}</strong></td>
                                        <td><span class="badge bg-success fs-6">${individualAmounts && individualAmounts[index] ? individualAmounts[index].toLocaleString() : '0'}ƒë</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>Doanh thu t√≠nh theo ng√†y check-in
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

// === QUICK NOTES MODAL FUNCTIONS ===
function openQuickNotesModal() {
    document.getElementById('quickNotesModal').modal('show');
}

function saveQuickNote() {
    const noteType = document.getElementById('noteType').value;
    const noteContent = document.getElementById('noteContent').value;
    const noteDate = document.getElementById('noteDate').value;
    const noteTime = document.getElementById('noteTime').value;
    const editId = document.getElementById('quickNotesForm').getAttribute('data-edit-id');
    
    // FIXED: Debug what we're getting from the form
    console.log('[SaveQuickNote] Form values:', {
        noteType, noteContent, noteDate, noteTime, editId,
        hasNoteType: !!noteType,
        hasNoteContent: !!noteContent,
        activeButtons: document.querySelectorAll('.note-type-btn.active').length
    });
    
    if (!noteType || !noteContent || !noteDate || !noteTime) {
        console.log('‚ùå QuickNote validation failed: Missing required fields');
        console.log(`Debug: noteType="${noteType}", noteContent="${noteContent}", noteDate="${noteDate}", noteTime="${noteTime}"`);
        // Show non-blocking error feedback
        const submitBtn = document.querySelector('#quickNotesModal .btn-primary');
        if (submitBtn) {
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚ö†Ô∏è Thi·∫øu th√¥ng tin';
            submitBtn.className = 'btn btn-warning';
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.className = 'btn btn-primary';
            }, 2000);
        }
        return;
    }
    
    // FIXED: Additional validation for empty strings
    if (noteType.trim() === '' || noteContent.trim() === '') {
        console.log('‚ùå QuickNote validation failed: Empty strings');
        alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin! H√£y ch·ªçn lo·∫°i ghi ch√∫ v√† nh·∫≠p n·ªôi dung.');
        return;
    }
    
    // FIXED: Fallback - try to get note type from active button if form field is empty
    if (!noteType || noteType.trim() === '') {
        const activeButton = document.querySelector('.note-type-btn.active');
        if (activeButton) {
            const onclickAttr = activeButton.getAttribute('onclick');
            if (onclickAttr && onclickAttr.includes('selectNoteType')) {
                const match = onclickAttr.match(/selectNoteType\('([^']+)'\)/);
                if (match) {
                    document.getElementById('noteType').value = match[1];
                    console.log(`[SaveQuickNote] Fixed noteType from button: ${match[1]}`);
                }
            }
        }
    }
    
    const isEditing = !!editId;
    
    const noteData = {
        id: editId || Date.now().toString(),
        type: noteType,
        content: noteContent,
        date: noteDate,
        time: noteTime,
        guest_name: isEditing ? (document.getElementById('quickNotesForm').getAttribute('data-guest-name') || '') : '', // Use stored guest name for edits
        completed: false, // Explicitly set as not completed
        created_at: new Date().toISOString()
    };
    
    // FIXED: Add debug logging for troubleshooting
    console.log(`[QuickNote] ${isEditing ? 'Editing' : 'Creating'} note:`, noteData);
    
    // Save to localStorage
    let savedNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
    if (isEditing) {
        // Update existing note
        const noteIndex = savedNotes.findIndex(note => note.id === editId);
        if (noteIndex !== -1) {
            savedNotes[noteIndex] = noteData;
        }
    } else {
        // Add new note
        savedNotes.unshift(noteData);
    }
    localStorage.setItem('quickNotes', JSON.stringify(savedNotes));
    
    // Send to server (different endpoints for create vs edit)
    const apiUrl = isEditing ? `/api/quick_notes/${editId}` : '/api/quick_notes';
    const method = isEditing ? 'PUT' : 'POST';
    
    fetch(apiUrl, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(noteData)
    })
    .then(response => {
        console.log(`[QuickNote] API Response Status: ${response.status}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log(`[QuickNote] API Response Data:`, data);
        if (data.success) {
            console.log(`Note ${isEditing ? 'updated' : 'saved'} to database successfully`);
            
            // ‚úÖ CRITICAL FIX: Update localStorage with real database ID from server
            if (!isEditing && data.note && data.note.note_id) {
                let savedNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
                // Find the note we just created (it will have the timestamp ID)
                const noteIndex = savedNotes.findIndex(note => note.id === noteData.id);
                if (noteIndex !== -1) {
                    // Update with real database ID
                    savedNotes[noteIndex].id = data.note.note_id.toString();
                    localStorage.setItem('quickNotes', JSON.stringify(savedNotes));
                    console.log(`[QuickNote] Updated localStorage ID: ${noteData.id} ‚Üí ${data.note.note_id}`);
                }
            }
            
            showDashboardToast(`‚úÖ ƒê√£ ${isEditing ? 'c·∫≠p nh·∫≠t' : 'l∆∞u'} ghi ch√∫ th√†nh c√¥ng!`, 'success');
            
            // FIXED: Close modal and reload to show fresh data
            forceCloseModal('quickNotesModal');
            
            setTimeout(() => {
                loadQuickNotesOnDashboard();
            }, 500);
        } else {
            console.error('Server save failed:', data.message || data.error || 'Unknown error');
            showDashboardToast(`‚ùå L·ªói khi ${isEditing ? 'c·∫≠p nh·∫≠t' : 'l∆∞u'} ghi ch√∫: ${data.message || data.error || 'Unknown error'}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving to server:', error);
        showDashboardToast(`‚ùå L·ªói k·∫øt n·ªëi database: ${error.message}`, 'error');
    });
    
    // Reset form (non-blocking)
    setTimeout(() => {
        try {
            document.getElementById('quickNotesForm').reset();
            document.getElementById('noteDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('noteTime').value = new Date().toTimeString().slice(0, 5);
        } catch (e) {
            console.error('QuickNotes form reset error:', e);
        }
    }, 50);
    
    // Close modal with enhanced safety (non-blocking)
    setTimeout(() => {
        try {
            const modalElement = document.getElementById('quickNotesModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            
            if (modal) {
                modal.hide();
            } else {
                // Enhanced fallback for modal cleanup
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                
                // Clean up body and backdrop
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // Remove all backdrops
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
            }
        } catch (e) {
            console.error('QuickNotes modal close error:', e);
            // Force cleanup if all else fails
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
        }
    }, 100);
    
    // Refresh notes display (non-blocking)
    setTimeout(() => {
        try {
            loadQuickNotesOnDashboard();
        } catch (error) {
            console.error('Error refreshing QuickNotes display:', error);
        }
    }, 150);
}

// Edit Quick Note function
function editQuickNote(noteId, noteType, noteContent, noteDate, noteTime, guestName) {
    // Populate the form with existing data
    document.getElementById('noteType').value = noteType;
    document.getElementById('noteContent').value = noteContent;
    document.getElementById('noteDate').value = noteDate;
    document.getElementById('noteTime').value = noteTime;
    
    // Store the guest name and edit ID in form attributes
    document.getElementById('quickNotesForm').setAttribute('data-edit-id', noteId);
    document.getElementById('quickNotesForm').setAttribute('data-guest-name', guestName || '');
    
    // Set note type visually
    document.querySelectorAll('.note-type-btn').forEach(btn => {
        btn.classList.remove('active', 'btn-primary', 'btn-outline-success', 'btn-outline-danger', 'btn-outline-warning');
        if (btn.getAttribute('onclick').includes(noteType)) {
            btn.classList.add('active', 'btn-primary');
        } else {
            // Restore original colors
            if (noteType === 'thu-tien') btn.classList.add('btn-outline-success');
            else if (noteType === 'huy-phong') btn.classList.add('btn-outline-danger');
            else if (noteType === 'taxi') btn.classList.add('btn-outline-warning');
        }
    });
    
    // Change modal title
    document.getElementById('quickNotesModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>S·ª≠a Quick Note';
    
    // Change save button text
    const saveBtn = document.querySelector('#quickNotesModal .btn-primary');
    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>C·∫≠p nh·∫≠t Note';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('quickNotesModal'));
    modal.show();
}

// Delete Quick Note function
async function deleteQuickNote(noteId) {
    if (!confirm('‚ùå B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a note n√†y?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
        return;
    }
    
    try {
        // Delete from server first
        const response = await fetch(`/api/quick_notes/${noteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Also delete from localStorage
            let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            notes = notes.filter(note => note.id !== noteId);
            localStorage.setItem('quickNotes', JSON.stringify(notes));
            
            showDashboardToast('üóëÔ∏è ƒê√£ x√≥a note th√†nh c√¥ng!', 'success');
            loadQuickNotesOnDashboard();
        } else {
            throw new Error(data.message || 'Server error');
        }
    } catch (error) {
        console.error('Error deleting note:', error);
        showDashboardToast('‚ùå L·ªói khi x√≥a note: ' + error.message, 'error');
        
        // Fallback to localStorage only
        let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
        notes = notes.filter(note => note.id !== noteId);
        localStorage.setItem('quickNotes', JSON.stringify(notes));
        loadQuickNotesOnDashboard();
    }
}

// Reset Quick Notes modal when closed
const quickNotesModalForReset = document.getElementById('quickNotesModal');
if (quickNotesModalForReset) {
    quickNotesModalForReset.addEventListener('hidden.bs.modal', function() {
        // Reset form
        const quickNotesForm = document.getElementById('quickNotesForm');
        if (quickNotesForm) {
            quickNotesForm.reset();
            quickNotesForm.removeAttribute('data-edit-id');
            quickNotesForm.removeAttribute('data-guest-name');
        }
        
        // Reset modal title
        const quickNotesModalLabel = document.getElementById('quickNotesModalLabel');
        if (quickNotesModalLabel) {
            quickNotesModalLabel.innerHTML = '<i class="fas fa-sticky-note me-2"></i>T·∫°o Quick Note';
        }
        
        // Reset save button text
        const saveBtn = document.querySelector('#quickNotesModal .btn-primary');
        if (saveBtn) {
            saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>L∆∞u Quick Note';
        }
        
        // Reset note type buttons
        document.querySelectorAll('.note-type-btn').forEach(btn => {
            btn.classList.remove('active', 'btn-primary');
        });
        
        // Clear note type
        const noteTypeEl = document.getElementById('noteType');
        if (noteTypeEl) {
            noteTypeEl.value = '';
        }
    });
}

// New template function - more flexible and user-friendly
function useTemplate(noteType, contentTemplate) {
    // Set note type
    document.getElementById('noteType').value = noteType;
    
    // Set content template (user can modify freely)
    const contentField = document.getElementById('noteContent');
    contentField.value = contentTemplate;
    
    // Focus on content field for immediate editing
    contentField.focus();
    
    // Move cursor to end of template text
    const textLength = contentTemplate.length;
    contentField.setSelectionRange(textLength, textLength);
    
    // Visual feedback - highlight selected template
    document.querySelectorAll('.template-btn').forEach(btn => {
        btn.classList.remove('active', 'btn-success', 'btn-danger', 'btn-warning', 'btn-info');
    });
    
    // Highlight the clicked template button
    if (event && event.target) {
        const btn = event.target.closest('.template-btn');
        if (btn) {
            btn.classList.add('active');
            // Add appropriate color class
            if (noteType === 'Thu ti·ªÅn') btn.classList.add('btn-success');
            else if (noteType === 'H·ªßy ph√≤ng') btn.classList.add('btn-danger');
            else if (noteType === 'Taxi') btn.classList.add('btn-warning');
            else btn.classList.add('btn-info');
        }
    }
}

// ==================== EDIT AMOUNT MODAL FUNCTIONS ====================
// currentEditBookingData declared at top of script

function openEditAmountModal(bookingId, guestName, roomFee, taxiFee, commission) {
    // Add debug logging and parameter validation
    console.log('[EditAmount] Called with:', {bookingId, guestName, roomFee, taxiFee, commission});
    
    // Validate required parameters
    if (!bookingId || !guestName) {
        console.error('[EditAmount] Missing required parameters');
        alert('‚ö†Ô∏è Missing booking information. Please refresh the page.');
        return;
    }
    
    // Parse and validate fees
    const parsedRoomFee = parseFloat(roomFee) || 0;
    const parsedTaxiFee = parseFloat(taxiFee) || 0;
    const parsedCommission = parseFloat(commission) || 0;
    
    console.log('[EditAmount] Parsed fees:', {parsedRoomFee, parsedTaxiFee, parsedCommission});
    
    // Store booking data for editing
    currentEditBookingData = {
        bookingId: bookingId,
        guestName: guestName,
        roomFee: parsedRoomFee,
        taxiFee: parsedTaxiFee,
        commission: parsedCommission
    };
    
    // Reset form
    document.getElementById('editAmountForm').reset();
    
    // Populate modal data
    document.getElementById('editModalGuestName').textContent = guestName;
    document.getElementById('editModalBookingId').textContent = bookingId;
    document.getElementById('editRoomAmount').value = parsedRoomFee;
    document.getElementById('editTaxiAmount').value = parsedTaxiFee;
    document.getElementById('editCommissionAmount').value = parsedCommission;
    
    // Initialize commission field state
    const commissionInput = document.getElementById('editCommissionAmount');
    const noCommissionBtn = document.getElementById('editNoCommissionBtn');
    if (parsedCommission > 0) {
        commissionInput.disabled = false;
        noCommissionBtn.innerHTML = '<i class="fas fa-times"></i> Kh√¥ng c√≥';
        noCommissionBtn.classList.remove('btn-danger');
        noCommissionBtn.classList.add('btn-outline-secondary');
    } else {
        commissionInput.disabled = true;
        commissionInput.value = '';
        noCommissionBtn.innerHTML = '<i class="fas fa-check"></i> Kh√¥ng c√≥ hoa h·ªìng';
        noCommissionBtn.classList.remove('btn-outline-secondary');
        noCommissionBtn.classList.add('btn-danger');
    }
    
    // Update total preview
    updateEditTotalPreview();
    
    // Add event listeners for real-time total calculation with null checks
    const editRoomAmountEl = document.getElementById('editRoomAmount');
    const editTaxiAmountEl = document.getElementById('editTaxiAmount');
    const editCommissionAmountEl = document.getElementById('editCommissionAmount');
    
    if (editRoomAmountEl) {
        editRoomAmountEl.addEventListener('input', updateEditTotalPreview);
    } else {
        console.warn('‚ö†Ô∏è editRoomAmount element not found for event listener');
    }
    
    if (editTaxiAmountEl) {
        editTaxiAmountEl.addEventListener('input', updateEditTotalPreview);
    } else {
        console.warn('‚ö†Ô∏è editTaxiAmount element not found for event listener');
    }
    
    if (editCommissionAmountEl) {
        editCommissionAmountEl.addEventListener('input', updateEditTotalPreview);
    } else {
        console.warn('‚ö†Ô∏è editCommissionAmount element not found for event listener');
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editAmountModal'));
    modal.show();
}

function updateEditTotalPreview() {
    const roomAmount = parseFloat(document.getElementById('editRoomAmount').value) || 0;
    const taxiAmount = parseFloat(document.getElementById('editTaxiAmount').value) || 0;
    const total = roomAmount + taxiAmount;
    
    document.getElementById('editTotalPreview').textContent = total.toLocaleString() + 'ƒë';
}

function toggleTaxiAmount() {
    const hasTaxi = document.getElementById('hasTaxi').checked;
    const taxiAmountGroup = document.getElementById('taxiAmountGroup');
    const taxiAmountInput = document.getElementById('taxiAmount');
    
    if (hasTaxi) {
        taxiAmountGroup.style.display = 'block';
        taxiAmountInput.focus(); // Auto-focus for better UX
    } else {
        taxiAmountGroup.style.display = 'none';
        taxiAmountInput.value = ''; // Clear taxi amount when no taxi selected
    }
}

function toggleEditCommission() {
    const commissionInput = document.getElementById('editCommissionAmount');
    const noCommissionBtn = document.getElementById('editNoCommissionBtn');
    
    if (commissionInput.disabled) {
        // Enable commission input
        commissionInput.disabled = false;
        commissionInput.value = currentEditBookingData.commission || '';
        noCommissionBtn.innerHTML = '<i class="fas fa-times"></i> Kh√¥ng c√≥';
        noCommissionBtn.classList.remove('btn-danger');
        noCommissionBtn.classList.add('btn-outline-secondary');
    } else {
        // Disable commission input (no commission)
        commissionInput.disabled = true;
        commissionInput.value = '';
        noCommissionBtn.innerHTML = '<i class="fas fa-check"></i> Kh√¥ng c√≥ hoa h·ªìng';
        noCommissionBtn.classList.remove('btn-outline-secondary');
        noCommissionBtn.classList.add('btn-danger');
    }
    updateEditTotalPreview();
}

function updateBookingAmounts() {
    const roomAmount = parseFloat(document.getElementById('editRoomAmount').value) || 0;
    const taxiAmount = parseFloat(document.getElementById('editTaxiAmount').value) || 0;
    const editNote = document.getElementById('editNote').value.trim();
    
    // Commission handling
    const commissionInput = document.getElementById('editCommissionAmount');
    let commissionAmount = null;
    let commissionType = 'normal';
    
    if (commissionInput.disabled) {
        // No commission selected
        commissionAmount = 0;
        commissionType = 'none';
    } else if (commissionInput.value) {
        // Commission amount entered
        commissionAmount = parseFloat(commissionInput.value) || 0;
    }
    // If commissionInput is enabled but empty, keep existing commission (don't send)
    
    // Validation
    if (roomAmount < 0 || taxiAmount < 0) {
        alert('‚ùå S·ªë ti·ªÅn kh√¥ng th·ªÉ √¢m!');
        return;
    }
    
    if (commissionAmount !== null && commissionAmount < 0) {
        alert('‚ùå Hoa h·ªìng kh√¥ng th·ªÉ √¢m!');
        return;
    }
    
    if (roomAmount === 0 && taxiAmount === 0) {
        alert('‚ùå Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt kho·∫£n ti·ªÅn!');
        return;
    }
    
    // Disable button and show loading
    const confirmBtn = document.getElementById('confirmEditBtn');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang c·∫≠p nh·∫≠t...';
    confirmBtn.disabled = true;
    
    // Prepare update data for the new API endpoint
    const updateData = {
        booking_id: currentEditBookingData.bookingId,
        room_amount: roomAmount,
        taxi_amount: taxiAmount,
        edit_note: editNote
    };
    
    // Only include commission if it was modified
    if (commissionAmount !== null) {
        updateData.commission_amount = commissionAmount;
        updateData.commission_type = commissionType;
    }
    
    console.log('Sending update data:', updateData);
    
    // Call the correct API endpoint for updating guest amounts
    fetch('/api/update_guest_amounts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success - close modal and update display immediately
            showDashboardToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t s·ªë ti·ªÅn th√†nh c√¥ng!', 'success');
            
            // Update the guest card immediately
            updateGuestCardAmounts(currentEditBookingData.bookingId, roomAmount, taxiAmount);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('editAmountModal'));
            modal.hide();
            
            // FIXED: Add page reload after successful update to ensure fresh data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    })
    .catch(error => {
        console.error('Update amounts error:', error);
        showDashboardToast(`‚ùå L·ªói c·∫≠p nh·∫≠t: ${error.message}`, 'error');
    })
    .finally(() => {
        // Restore button
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// ===== ARRIVAL & DEPARTURE NOTIFICATION FUNCTIONS =====

function createArrivalNotification() {
    // Quick action for arrival notifications
    const message = prompt("Nh·∫≠p tin nh·∫Øn ch√†o m·ª´ng cho kh√°ch ƒë·∫øn:", 
                          "Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi kh√°ch s·∫°n! Ph√≤ng ƒë√£ s·∫µn s√†ng. Vui l√≤ng li√™n h·ªá reception ƒë·ªÉ check-in.");
    
    if (message) {
        // Here you could send to messaging system or create a reminder
        showDashboardToast(`‚úÖ ƒê√£ t·∫°o th√¥ng b√°o ch√†o m·ª´ng kh√°ch ƒë·∫øn!`, 'success');
        
        // Optional: You could integrate with your messaging templates here
        console.log('Arrival notification created:', message);
    }
}

// Clear guest arrival time
async function clearGuestArrivalTime(bookingId, guestName) {
    if (!confirm(`Clear arrival time for ${guestName}?`)) {
        return;
    }
    
    await saveArrivalTime(bookingId, guestName, '', '--:--');
    
    // Hide delete button
    const clearButton = document.getElementById(`clear-${bookingId}`);
    if (clearButton) {
        clearButton.style.display = 'none';
    }
}

async function editGuestArrivalTime(bookingId, guestName) {
    const currentTimeElement = document.getElementById(`time-${bookingId}`);
    const currentTime = currentTimeElement.textContent === '--:--' ? '' : currentTimeElement.textContent;
    
    // Simple input that accepts numbers like 12, 13, etc.
    const input = prompt(`Nh·∫≠p gi·ªù ƒë·∫øn cho ${guestName} (v√≠ d·ª•: 12, 13, 14):`, currentTime.split(':')[0] || '');
    
    if (input === null) return; // User cancelled
    if (input === '') {
        // Clear the time
        await saveArrivalTime(bookingId, guestName, '', '--:--');
        return;
    }
    
    // Convert simple number input to HH:MM format
    const hour = parseInt(input);
    if (isNaN(hour) || hour < 0 || hour > 23) {
        showDashboardToast('‚ùå Gi·ªù kh√¥ng h·ª£p l·ªá! Nh·∫≠p s·ªë t·ª´ 0-23', 'error');
        return;
    }
    
    const newTime = hour.toString().padStart(2, '0') + ':00';
    
    if (newTime) {
        await saveArrivalTime(bookingId, guestName, newTime, newTime);
    }
}

// Separate function to handle saving arrival time
async function saveArrivalTime(bookingId, guestName, timeValue, displayTime) {
    const currentTimeElement = document.getElementById(`time-${bookingId}`);
    
    try {
        // Save to server first with corrected API call
        const response = await fetch('/api/arrival_times', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                booking_id: bookingId,
                estimated_arrival: timeValue || null,
                notes: `Updated by user for ${guestName}`
            })
        });
        
        const result = await response.json();
        
        if (response.ok && !result.error) {
            // Update UI after successful server save
            currentTimeElement.textContent = displayTime;
            
            if (timeValue) {
                showDashboardToast(`‚è∞ ƒê√£ l∆∞u th·ªùi gian cho ${guestName}: ${displayTime}`, 'success');
                // Schedule notification check
                scheduleArrivalNotification(bookingId, guestName, timeValue);
                // Show delete button
                const clearButton = document.getElementById(`clear-${bookingId}`);
                if (clearButton) {
                    clearButton.style.display = 'inline-block';
                }
            } else {
                showDashboardToast(`‚è∞ ƒê√£ x√≥a th·ªùi gian cho ${guestName}`, 'success');
                // Hide delete button
                const clearButton = document.getElementById(`clear-${bookingId}`);
                if (clearButton) {
                    clearButton.style.display = 'none';
                }
            }
            
            // Also save to localStorage as backup
            const guestTimes = JSON.parse(localStorage.getItem('guestArrivalTimes') || '{}');
            if (timeValue) {
                guestTimes[bookingId] = timeValue;
            } else {
                delete guestTimes[bookingId];
            }
            localStorage.setItem('guestArrivalTimes', JSON.stringify(guestTimes));
        } else {
            throw new Error(result.error || 'Server save failed');
        }
    } catch (error) {
        console.error('Error saving guest time:', error);
        showDashboardToast(`‚ùå L·ªói l∆∞u server: ${error.message}. Ch·ªâ l∆∞u tr√™n thi·∫øt b·ªã n√†y.`, 'warning');
        
        // Fallback to localStorage only
        currentTimeElement.textContent = displayTime;
        const guestTimes = JSON.parse(localStorage.getItem('guestArrivalTimes') || '{}');
        if (timeValue) {
            guestTimes[bookingId] = timeValue;
        } else {
            delete guestTimes[bookingId];
        }
        localStorage.setItem('guestArrivalTimes', JSON.stringify(guestTimes));
    }
}


function copyTaxiMessage(guestName) {
    // Sample taxi message template
    const message = `Hi ${guestName}, If you need a taxi to the airport tomorrow, please don't hesitate to let me know. I can arrange one for you at a special discounted rate that our guests often appreciate.`;
    
    // Copy to clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(message).then(() => {
            showDashboardToast(`üìã ƒê√£ copy tin nh·∫Øn taxi cho ${guestName}!`, 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            // Fallback method
            fallbackCopy(message, guestName);
        });
    } else {
        // Fallback for older browsers
        fallbackCopy(message, guestName);
    }
}

function fallbackCopy(text, guestName) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showDashboardToast(`üìã ƒê√£ copy tin nh·∫Øn taxi cho ${guestName}!`, 'success');
    } catch (err) {
        console.error('Fallback copy failed:', err);
        alert(`Tin nh·∫Øn taxi cho ${guestName}:\n\n${text}`);
    }
    
    document.body.removeChild(textArea);
}

function copyArrivalTaxiMessage(guestName) {
    // Arrival taxi message template with custom content
    const message = `Hi ${guestName}, Have you arranged transportation from the airport yet? I have a driver who offers cheap taxi rates. Would you like me to book it for you? If you'd like to confirm the booking, kindly let me know. It's only 280,000 VND. That's cheaper than usual because I have my own driver ready available at the airport. You're welcome to check normal prices and compare. Please feel free to message me if you need anything, and I'll arrange a driver for you right at the airport.`;
    
    // Copy to clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(message).then(() => {
            showDashboardToast(`üöï ƒê√£ copy tin nh·∫Øn taxi ƒë√≥n s√¢n bay cho ${guestName}!`, 'success');
        }).catch(err => {
            console.error('Failed to copy arrival taxi message:', err);
            // Fallback method
            fallbackCopyArrivalTaxi(message, guestName);
        });
    } else {
        // Fallback for older browsers
        fallbackCopyArrivalTaxi(message, guestName);
    }
}

function fallbackCopyArrivalTaxi(text, guestName) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showDashboardToast(`üöï ƒê√£ copy tin nh·∫Øn taxi ƒë√≥n s√¢n bay cho ${guestName}!`, 'success');
    } catch (err) {
        console.error('Fallback copy failed:', err);
        alert(`Tin nh·∫Øn taxi ƒë√≥n s√¢n bay cho ${guestName}:\n\n${text}`);
    }
    
    document.body.removeChild(textArea);
}

// Commission calculation and payment message copy function
function calculateCommissionDiscount(totalAmount, commissionFromApp) {
    // Use the actual commission amount from app data
    const actualCommission = commissionFromApp || 0;
    
    // Calculate 35% discount FROM the actual commission
    const commissionDiscount = Math.round(actualCommission * 0.35);
    
    // Amount after commission discount
    const afterCommissionDiscount = totalAmount - commissionDiscount;
    
    // Round to nice numbers
    const roundedFinalAmount = roundToNiceAmount(afterCommissionDiscount);
    
    // Total discount = original - rounded final amount
    const totalDiscount = totalAmount - roundedFinalAmount;
    
    return {
        originalTotal: totalAmount,
        actualCommission: actualCommission,
        commissionDiscount: commissionDiscount,
        afterCommissionDiscount: afterCommissionDiscount,
        roundedFinalAmount: roundedFinalAmount,
        totalDiscount: totalDiscount
    };
}

function roundToNiceAmount(amount) {
    // ALWAYS round DOWN to give customer better discount
    // Round down to nearest 100k for clean amounts
    return Math.floor(amount / 100000) * 100000;
}

function copyPaymentMessage(guestName, totalAmount, commissionAmount) {
    try {
        // Calculate commission discount using actual app data
        const calculation = calculateCommissionDiscount(totalAmount, commissionAmount);
        
        // Format numbers with thousand separators
        const formattedDiscount = calculation.totalDiscount.toLocaleString();
        const discountUSD = (calculation.totalDiscount / 25000).toFixed(2); // Approximate VND to USD conversion
        const formattedFinalAmount = calculation.roundedFinalAmount.toLocaleString();
        
        // Create payment message template
        const message = `Hi ${guestName} Regarding payment, I can offer you a ${formattedDiscount} VND (approx. $${discountUSD} USD) discount if you're comfortable paying me directly in cash for the room, rather than through the booking platform. Your total would be ${formattedFinalAmount} VND instead. This is just an option, of course ‚Äì no pressure at all! Please let me know if you're interested. If you agree to this, I will then cancel your reservation on the booking app.`;
        
        // Copy to clipboard using the same method as taxi message
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(message).then(() => {
                showDashboardToast(`üí∞ ƒê√£ copy tin nh·∫Øn thanh to√°n cho ${guestName}! Gi·∫£m ${formattedDiscount}ƒë ‚Üí ${formattedFinalAmount}ƒë`, 'success');
            }).catch(err => {
                console.error('Failed to copy payment message:', err);
                fallbackCopyPayment(message, guestName, formattedDiscount, formattedFinalAmount);
            });
        } else {
            fallbackCopyPayment(message, guestName, formattedDiscount, formattedFinalAmount);
        }
    } catch (error) {
        console.error('Error calculating payment message:', error);
        showDashboardToast(`‚ùå L·ªói t√≠nh to√°n tin nh·∫Øn cho ${guestName}`, 'error');
    }
}

function fallbackCopyPayment(text, guestName, discountAmount, finalAmount) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showDashboardToast(`üí∞ ƒê√£ copy tin nh·∫Øn thanh to√°n cho ${guestName}! Gi·∫£m ${discountAmount}ƒë ‚Üí ${finalAmount || 'N/A'}ƒë`, 'success');
    } catch (err) {
        console.error('Fallback copy payment failed:', err);
        alert(`Tin nh·∫Øn thanh to√°n cho ${guestName}:\n\n${text}`);
    }
    
    document.body.removeChild(textArea);
}

function createDepartureNotification() {
    // Quick action for departure notifications
    const taxiNeeded = confirm("Kh√°ch c√≥ c·∫ßn h·ªó tr·ª£ ƒë·∫∑t taxi kh√¥ng?");
    
    if (taxiNeeded) {
        const message = "C·∫£m ∆°n b·∫°n ƒë√£ l∆∞u tr√∫ t·∫°i kh√°ch s·∫°n! Ch√∫ng t√¥i c√≥ th·ªÉ h·ªó tr·ª£ ƒë·∫∑t taxi ƒë·∫øn s√¢n bay v·ªõi gi√° ∆∞u ƒë√£i 280,000ƒë. Vui l√≤ng cho bi·∫øt th·ªùi gian kh·ªüi h√†nh.";
        
        // Create notification with taxi service
        showDashboardToast(`üöï ƒê√£ t·∫°o th√¥ng b√°o h·ªó tr·ª£ taxi cho kh√°ch ƒëi!`, 'success');
        console.log('Departure notification with taxi:', message);
    } else {
        const message = "C·∫£m ∆°n b·∫°n ƒë√£ l∆∞u tr√∫ t·∫°i kh√°ch s·∫°n! Ch√∫c b·∫°n c√≥ chuy·∫øn ƒëi an to√†n. N·∫øu c·∫ßn h·ªó tr·ª£ g√¨, vui l√≤ng li√™n h·ªá ch√∫ng t√¥i.";
        
        // Create standard departure notification
        showDashboardToast(`‚úÖ ƒê√£ t·∫°o th√¥ng b√°o c·∫£m ∆°n kh√°ch ƒëi!`, 'success');
        console.log('Departure notification:', message);
    }
}

// Quick notification function for mobile
function quickNotify(type, guestName) {
    const templates = {
        arrival: `Ch√†o m·ª´ng ${guestName}! Ph√≤ng ƒë√£ s·∫µn s√†ng, vui l√≤ng li√™n h·ªá reception.`,
        departure: `C·∫£m ∆°n ${guestName}! N·∫øu c·∫ßn taxi s√¢n bay (280k), vui l√≤ng cho bi·∫øt gi·ªù kh·ªüi h√†nh.`
    };
    
    const message = templates[type];
    if (message) {
        // Copy to clipboard for quick use
        navigator.clipboard.writeText(message).then(() => {
            showDashboardToast(`üìã ƒê√£ copy tin nh·∫Øn cho ${guestName}!`, 'success');
        });
    }
}
</script>

<!-- Quick Notes Modal -->
<div class="modal fade" id="quickNotesModal" tabindex="-1" aria-labelledby="quickNotesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="quickNotesModalLabel">
                    <i class="fas fa-sticky-note me-2"></i>T·∫°o Quick Note M·ªõi
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quickNotesForm">
                    <!-- Quick Selection Templates (Optional) -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-magic me-2"></i>M·∫´u nhanh (t√πy ch·ªçn):
                        </label>
                        <div class="text-muted small mb-3">
                            <i class="fas fa-info-circle me-1"></i>
                            Ch·ªçn m·∫´u ƒë·ªÉ vi·∫øt nhanh h∆°n, ho·∫∑c b·ªè qua v√† vi·∫øt t·ª± do
                        </div>
                        <div class="row g-2">
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-success btn-sm w-100 template-btn" onclick="useTemplate('Thu ti·ªÅn', 'Thu ti·ªÅn t·ª´ kh√°ch: ')">
                                    <i class="fas fa-money-bill-wave me-1"></i>Thu ti·ªÅn
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-danger btn-sm w-100 template-btn" onclick="useTemplate('H·ªßy ph√≤ng', 'H·ªßy ph√≤ng cho kh√°ch: ')">
                                    <i class="fas fa-times-circle me-1"></i>H·ªßy ph√≤ng
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-warning btn-sm w-100 template-btn" onclick="useTemplate('Taxi', 'ƒê·∫∑t taxi cho kh√°ch: ')">
                                    <i class="fas fa-taxi me-1"></i>Taxi
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-info btn-sm w-100 template-btn" onclick="useTemplate('Ghi ch√∫', '')">
                                    <i class="fas fa-sticky-note me-1"></i>T·ª± do
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Note Type (visible field) -->
                    <div class="mb-3">
                        <label for="noteType" class="form-label fw-bold">Lo·∫°i ghi ch√∫:</label>
                        <input type="text" class="form-control" id="noteType" name="noteType" 
                               placeholder="VD: Thu ti·ªÅn, Taxi, Ghi ch√∫ quan tr·ªçng..." 
                               value="Ghi ch√∫" required>
                        <div class="form-text">
                            <i class="fas fa-lightbulb me-1"></i>
                            B·∫°n c√≥ th·ªÉ nh·∫≠p b·∫•t k·ª≥ lo·∫°i ghi ch√∫ n√†o
                        </div>
                    </div>
                    
                    <!-- Note Content -->
                    <div class="mb-3">
                        <label for="noteContent" class="form-label fw-bold">N·ªôi dung ghi ch√∫:</label>
                        <textarea class="form-control" id="noteContent" name="noteContent" rows="4" 
                                  placeholder="Nh·∫≠p chi ti·∫øt ghi ch√∫..."></textarea>
                    </div>
                    
                    <!-- Date and Time -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="noteDate" class="form-label fw-bold">Ng√†y:</label>
                            <input type="date" class="form-control" id="noteDate" name="noteDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="noteTime" class="form-label fw-bold">Gi·ªù:</label>
                            <input type="time" class="form-control" id="noteTime" name="noteTime" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>H·ªßy
                </button>
                <button type="button" class="btn btn-primary" onclick="saveQuickNote()">
                    <i class="fas fa-save me-1"></i>L∆∞u Quick Note
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables already declared at top of script

// Initialize modal date and time when modal opens
const quickNotesModal = document.getElementById('quickNotesModal');
if (quickNotesModal) {
    quickNotesModal.addEventListener('show.bs.modal', function () {
        const now = new Date();
        const noteDateElement = document.getElementById('noteDate');
        const noteTimeElement = document.getElementById('noteTime');
        if (noteDateElement) {
            noteDateElement.value = now.toISOString().split('T')[0];
        }
        if (noteTimeElement) {
            noteTimeElement.value = now.toTimeString().slice(0, 5);
        }
    });
}

// Initialize arrival times from server, fallback to localStorage
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Try to load times from server first
        const response = await fetch('/api/arrival_times');
        const result = await response.json();
        
        if (result.success && result.data) {
            const serverData = result.data;
            
            // Update default time from server
            const defaultTimeElement = document.getElementById('defaultArrivalTime');
            if (defaultTimeElement && serverData.default_time) {
                defaultTimeElement.textContent = serverData.default_time;
                // Update localStorage with server data
                localStorage.setItem('defaultArrivalTime', serverData.default_time);
            }
            
            // Update guest times from server
            Object.entries(serverData.guest_times || {}).forEach(([bookingId, time]) => {
                const timeElement = document.getElementById(`time-${bookingId}`);
                if (timeElement) {
                    timeElement.textContent = time;
                }
            });
            
            // Update localStorage with server data
            localStorage.setItem('guestArrivalTimes', JSON.stringify(serverData.guest_times || {}));
            
            console.log('‚úÖ Loaded arrival times from server (synced across devices)');
        } else {
            throw new Error('Server data not available');
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Server sync failed, using local storage:', error.message);
        
        // Fallback to localStorage
        const defaultTime = localStorage.getItem('defaultArrivalTime');
        if (defaultTime) {
            const defaultTimeElement = document.getElementById('defaultArrivalTime');
            if (defaultTimeElement) {
                defaultTimeElement.textContent = defaultTime;
            }
        }
        
        // Load guest-specific arrival times from localStorage
        const guestTimes = JSON.parse(localStorage.getItem('guestArrivalTimes') || '{}');
        Object.entries(guestTimes).forEach(([bookingId, time]) => {
            const timeElement = document.getElementById(`time-${bookingId}`);
            if (timeElement) {
                timeElement.textContent = time;
            }
        });
    }
});

</script>

<!-- Expense Modal -->
<div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);">
                <h5 class="modal-title text-white" id="expenseModalLabel">
                    <i class="fas fa-receipt me-2"></i>Th√™m Chi Ph√≠
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    <div class="mb-3">
                        <label for="expenseDescription" class="form-label">N·ªôi dung chi ph√≠</label>
                        <input type="text" class="form-control" id="expenseDescription" placeholder="VD: ƒêi·ªán, n∆∞·ªõc, th·ª±c ph·∫©m..." required>
                    </div>
                    <div class="mb-3">
                        <label for="expenseAmount" class="form-label">S·ªë ti·ªÅn</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="expenseAmount" placeholder="100000" step="any" required>
                            <span class="input-group-text">ƒë</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="expenseDate" class="form-label">Ng√†y</label>
                        <input type="date" class="form-control" id="expenseDate" required>
                    </div>
                    
                    <!-- NEW: Category Selection -->
                    <div class="mb-3">
                        <label class="form-label">Ph√¢n lo·∫°i (t√πy ch·ªçn)</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="expenseCategory" id="personalCategory" value="personal">
                            <label class="btn btn-outline-success" for="personalCategory">
                                <i class="fas fa-user me-1"></i>C√° Nh√¢n
                            </label>
                            
                            <input type="radio" class="btn-check" name="expenseCategory" id="workCategory" value="work">
                            <label class="btn btn-outline-info" for="workCategory">
                                <i class="fas fa-briefcase me-1"></i>C√¥ng Vi·ªác
                            </label>
                            
                            <input type="radio" class="btn-check" name="expenseCategory" id="uncategorizedCategory" value="" checked>
                            <label class="btn btn-outline-secondary" for="uncategorizedCategory">
                                <i class="fas fa-question-circle me-1"></i>Ch∆∞a ph√¢n lo·∫°i
                            </label>
                        </div>
                        <small class="text-muted">B·∫°n c√≥ th·ªÉ ph√¢n lo·∫°i sau khi th√™m</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="addExpense()" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); border: none;">
                    <i class="fas fa-save me-1"></i>L∆∞u Chi Ph√≠
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Expense Review Modal -->
<div class="modal fade" id="expenseReviewModal" tabindex="-1" aria-labelledby="expenseReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h5 class="modal-title text-white" id="expenseReviewModalLabel">
                    <i class="fas fa-chart-pie me-2"></i>Ph√¢n Lo·∫°i Chi Ph√≠: C√° Nh√¢n & C√¥ng Vi·ªác
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Month Selection & Controls -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="reviewMonth" class="form-label">Ch·ªçn th√°ng:</label>
                        <input type="month" class="form-control" id="reviewMonth">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="loadExpenseReview()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                            <i class="fas fa-search me-1"></i>T·∫£i d·ªØ li·ªáu
                        </button>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-warning w-100" onclick="fixExpenseDescriptions()" id="fixDescBtn">
                            <i class="fas fa-tools me-1"></i>S·ª≠a N·ªôi Dung
                        </button>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-success btn-sm" onclick="categorizeSelected('personal')">
                                <i class="fas fa-user me-1"></i>C√° Nh√¢n
                            </button>
                            <button class="btn btn-info btn-sm" onclick="categorizeSelected('work')">
                                <i class="fas fa-briefcase me-1"></i>C√¥ng Vi·ªác
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Category Summary Cards -->
                <div class="row mb-3" id="categorySummary" style="display: none;">
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-header text-black" style="background-color: #d4edda;">
                                <i class="fas fa-user me-1"></i><strong>Chi Ph√≠ C√° Nh√¢n</strong>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <span>S·ªë giao d·ªãch:</span>
                                    <span id="personalCount" class="fw-bold">0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>T·ªïng ti·ªÅn:</span>
                                    <span id="personalTotal" class="fw-bold" style="color: #000000;">0ƒë</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-header text-black" style="background-color: #cce7f0;">
                                <i class="fas fa-briefcase me-1"></i><strong>Chi Ph√≠ C√¥ng Vi·ªác</strong>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <span>S·ªë giao d·ªãch:</span>
                                    <span id="workCount" class="fw-bold">0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>T·ªïng ti·ªÅn:</span>
                                    <span id="workTotal" class="fw-bold" style="color: #000000;">0ƒë</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Multi-Select Controls -->
                <div class="d-flex justify-content-between align-items-center mb-3" id="multiSelectControls" style="display: none;">
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="selectAllExpenses()">
                            <i class="fas fa-check-square me-1"></i>Ch·ªçn T·∫•t C·∫£
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearAllSelections()">
                            <i class="fas fa-square me-1"></i>B·ªè Ch·ªçn
                        </button>
                    </div>
                    <div>
                        <span class="text-muted">ƒê√£ ch·ªçn: <span id="selectedCount" class="fw-bold">0</span> giao d·ªãch</span>
                    </div>
                </div>
                
                <!-- Monthly Summary -->
                <div id="expenseReviewSummary" class="alert alert-info" style="display: none;">
                    <div class="row">
                        <div class="col-4">
                            <strong>T·ªïng giao d·ªãch:</strong> <span id="reviewTotalCount">0</span>
                        </div>
                        <div class="col-4">
                            <strong>T·ªïng chi ph√≠:</strong> <span id="reviewTotalAmount" class="text-danger">0ƒë</span>
                        </div>
                        <div class="col-4">
                            <strong>Ch∆∞a ph√¢n lo·∫°i:</strong> <span id="uncategorizedAmount" class="text-warning">0ƒë</span>
                        </div>
                    </div>
                </div>
                
                <!-- Expense List -->
                <div id="expenseReviewList">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                        <p>Ch·ªçn th√°ng ƒë·ªÉ xem chi ti·∫øt chi ph√≠</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<script>
// MODAL CLEANUP UTILITY - Fixes stuck backdrop issues
function forceCloseModal(modalId) {
    try {
        const modalElement = document.getElementById(modalId);
        if (!modalElement) return;
        
        // Get bootstrap modal instance
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
        
        // Force cleanup if modal is still stuck
        setTimeout(() => {
            // Remove modal classes
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
            modalElement.setAttribute('aria-hidden', 'true');
            modalElement.removeAttribute('aria-modal');
            
            // Clean up body classes and styles
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Remove any lingering backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                if (backdrop.parentNode) {
                    backdrop.parentNode.removeChild(backdrop);
                }
            });
            
            // Ensure scrolling is restored
            document.documentElement.style.overflow = '';
            
        }, 100);
        
    } catch (error) {
        console.warn('Modal cleanup warning:', error);
        
        // Emergency cleanup - force remove all modal artifacts
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        const allBackdrops = document.querySelectorAll('.modal-backdrop');
        allBackdrops.forEach(backdrop => backdrop.remove());
    }
}

// Emergency backdrop cleaner - call this if modals get stuck
function clearAllModalBackdrops() {
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
    document.documentElement.style.overflow = '';
    
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
    
    console.log('Cleared all modal backdrops');
}

// Add emergency escape key handler
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Double-tap escape to force close stuck modals
        setTimeout(() => {
            const visibleBackdrops = document.querySelectorAll('.modal-backdrop.show, .modal-backdrop.fade.show');
            if (visibleBackdrops.length > 0) {
                console.log('üîß Emergency modal cleanup triggered by ESC key');
                clearAllModalBackdrops();
            }
        }, 100);
    }
});

// Add console helper for users
console.log('üîß MODAL STUCK? Type: clearAllModalBackdrops() to fix it instantly!');

// Add emergency modal fix button (only shows when needed)
function addEmergencyModalButton() {
    // Check if already exists
    if (document.getElementById('emergencyModalFix')) return;
    
    const button = document.createElement('button');
    button.id = 'emergencyModalFix';
    button.innerHTML = 'üîß Fix Stuck Modal';
    button.className = 'btn btn-warning btn-sm';
    button.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 9999;
        font-size: 12px;
        display: none;
    `;
    button.onclick = function() {
        clearAllModalBackdrops();
        button.style.display = 'none';
    };
    
    document.body.appendChild(button);
    
    // Show button when backdrop is detected
    const observer = new MutationObserver(function() {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            button.style.display = 'block';
        } else {
            button.style.display = 'none';
        }
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
}

// Initialize emergency button
setTimeout(addEmergencyModalButton, 1000);

// Initialize expense modal date
const expenseModal = document.getElementById('expenseModal');
if (expenseModal) {
    expenseModal.addEventListener('show.bs.modal', function () {
        const now = new Date();
        const expenseDateElement = document.getElementById('expenseDate');
        if (expenseDateElement) {
            expenseDateElement.value = now.toISOString().split('T')[0];
        }
    });
}

// Load monthly expenses function (SIMPLIFIED - No more timeouts/aborts)
async function loadMonthlyExpenses() {
    try {
        // Add timeout to prevent freezing
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        const response = await fetch('/api/expenses', {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('üí∞ EXPENSES API Response:', result);
        
        // Update current month display
        const now = new Date();
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const currentMonthText = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        
        const monthTextElement = document.getElementById('currentMonthText');
        const monthlyTotalElement = document.getElementById('monthlyTotal');
        
        if (monthTextElement) {
            monthTextElement.textContent = currentMonthText;
        }
        
        if (result.success && result.data && result.data.length > 0) {
            console.log(`üí∞ EXPENSES PROCESSING: ${result.data.length} expenses found`);
            // Filter expenses for current month (simplified)
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            const monthlyExpenses = result.data.filter(expense => {
                if (!expense.date) return false;
                
                try {
                    // Simple date parsing - expecting YYYY-MM-DD format from API
                    const expenseDate = new Date(expense.date);
                    if (isNaN(expenseDate.getTime())) return false;
                    
                    return expenseDate.getMonth() + 1 === currentMonth && 
                           expenseDate.getFullYear() === currentYear;
                } catch (error) {
                    return false;
                }
            });
            
            console.log(`üí∞ EXPENSES FILTERED: ${monthlyExpenses.length} expenses for current month`);
            
            const monthlyTotal = monthlyExpenses.reduce((sum, expense) => {
                return sum + parseFloat(expense.amount || 0);
            }, 0);
            
            if (monthlyTotalElement) {
                if (monthlyTotal > 0) {
                    monthlyTotalElement.innerHTML = `<strong class="text-white">${monthlyTotal.toLocaleString()}ƒë</strong> (${monthlyExpenses.length} giao d·ªãch)`;
                } else {
                    monthlyTotalElement.textContent = 'Ch∆∞a c√≥ chi ph√≠ th√°ng n√†y';
                }
            }
        } else {
            console.log('üí∞ EXPENSES: No data or API error', result);
            if (monthlyTotalElement) {
                if (result.success === false) {
                    monthlyTotalElement.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu chi ph√≠';
                } else {
                    monthlyTotalElement.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu chi ph√≠';
                }
            }
        }
    } catch (error) {
        console.error('Error loading monthly expenses:', error);
        const monthlyTotalElement = document.getElementById('monthlyTotal');
        if (monthlyTotalElement) {
            monthlyTotalElement.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu';
        }
    }
}

// Prepare expense modal with default values
function prepareExpenseModal() {
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expenseDate').value = today;
    
    // Reset form to default state
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseDate').value = today; // Set again after reset
    
    // Reset category to uncategorized
    document.getElementById('uncategorizedCategory').checked = true;
    
    // Reset submit button
    const submitBtn = document.querySelector('#expenseModal .btn-primary');
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>L∆∞u Chi Ph√≠';
        submitBtn.className = 'btn btn-primary';
    }
    
    // Focus on description field after modal opens
    setTimeout(() => {
        const descField = document.getElementById('expenseDescription');
        if (descField) {
            descField.focus();
        }
    }, 300);
}

// Add expense function (FIXED - No more UI freezing)
async function addExpense() {
    const description = document.getElementById('expenseDescription').value.trim();
    const amount = document.getElementById('expenseAmount').value;
    const date = document.getElementById('expenseDate').value;
    const submitBtn = document.querySelector('#expenseModal .btn-primary');
    
    // NEW: Get selected category
    const selectedCategory = document.querySelector('input[name="expenseCategory"]:checked')?.value || '';
    
    // Validation
    if (!description || !amount || !date) {
        if (submitBtn) {
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚ö†Ô∏è Thi·∫øu th√¥ng tin';
            submitBtn.className = 'btn btn-warning';
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.className = 'btn btn-primary';
            }, 2000);
        }
        return;
    }
    
    // Prevent multiple submissions
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang l∆∞u...';
    }
    
    try {
        // Add timeout to prevent freezing
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            console.error('Expense save timeout after 15 seconds');
        }, 15000); // 15 second timeout
        
        const response = await fetch('/api/expenses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description,
                amount: parseFloat(amount),
                date: date,
                category: selectedCategory
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const result = await response.json();
        
        if (result.success) {
            console.log('‚úÖ Expense added successfully');
            
            const newExpenseId = result.expense_id;
            
            // NEW: Auto-categorize if category was selected
            if (selectedCategory && newExpenseId) {
                console.log(`üìÇ [AUTO_CATEGORIZE] Setting expense ${newExpenseId} as ${selectedCategory}`);
                
                try {
                    const categoryResponse = await fetch('/api/expense_categories', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            expense_ids: [newExpenseId],
                            category: selectedCategory
                        })
                    });
                    
                    const categoryData = await categoryResponse.json();
                    if (categoryData.success) {
                        console.log('‚úÖ [AUTO_CATEGORIZE] Category saved successfully');
                    }
                } catch (catError) {
                    console.error('‚ùå [AUTO_CATEGORIZE] Failed to save category:', catError);
                }
            }
            
            // Success feedback
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-check me-1"></i>ƒê√£ l∆∞u!';
                submitBtn.className = 'btn btn-success';
            }
            
            // Clean reset and close
            document.getElementById('expenseForm').reset();
            // Reset category selection to uncategorized
            document.getElementById('uncategorizedCategory').checked = true;
            
            // Close modal properly with force cleanup
            forceCloseModal('expenseModal');
            
            // NEW: Auto-refresh expense review if it's open
            setTimeout(async () => {
                loadMonthlyExpenses().catch(console.error);
                
                // If expense review modal is open, refresh it too
                const expenseReviewModal = document.getElementById('expenseReviewModal');
                if (expenseReviewModal && expenseReviewModal.classList.contains('show')) {
                    console.log('üîÑ [AUTO_REFRESH] Refreshing expense review after add');
                    await loadExpenseReview();
                }
            }, 500);
            
        } else {
            throw new Error(result.error || 'Cannot save expense');
        }
        
    } catch (error) {
        console.error('‚ùå Error adding expense:', error);
        
        if (submitBtn) {
            if (error.name === 'AbortError') {
                // Timeout error
                submitBtn.innerHTML = '‚è∞ Timeout - Th·ª≠ l·∫°i';
                submitBtn.className = 'btn btn-warning';
                showExpenseToast('‚è∞ L∆∞u chi ph√≠ timeout - vui l√≤ng th·ª≠ l·∫°i', 'warning');
            } else {
                // Other errors
                submitBtn.innerHTML = '‚ùå L·ªói - Th·ª≠ l·∫°i';
                submitBtn.className = 'btn btn-danger';
                showExpenseToast('‚ùå L·ªói l∆∞u chi ph√≠: ' + error.message, 'error');
            }
        }
    } finally {
        // Reset button after 2 seconds
        if (submitBtn) {
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>L∆∞u Chi Ph√≠';
                submitBtn.className = 'btn btn-primary';
            }, 2000);
        }
    }
}

// Load monthly expenses on page load (async, non-blocking) - moved after function definition
setTimeout(() => {
    loadMonthlyExpenses().catch(error => {
        console.error('Failed to load monthly expenses:', error);
        const monthlyTotalElement = document.getElementById('monthlyTotal');
        if (monthlyTotalElement) {
            monthlyTotalElement.textContent = 'L·ªói t·∫£i chi ph√≠';
        }
    });
}, 100);

// Initialize expense review modal
const expenseReviewModal = document.getElementById('expenseReviewModal');
if (expenseReviewModal) {
    expenseReviewModal.addEventListener('show.bs.modal', function () {
        const now = new Date();
        const reviewMonthElement = document.getElementById('reviewMonth');
        if (reviewMonthElement) {
            reviewMonthElement.value = now.toISOString().slice(0, 7); // YYYY-MM format
        }
    });
}

// Global variables for expense categorization
let currentExpenses = [];
let expenseCategories = {};

// Load expense review function with categorization
async function loadExpenseReview() {
    const selectedMonth = document.getElementById('reviewMonth').value;
    if (!selectedMonth) {
        alert('Vui l√≤ng ch·ªçn th√°ng ƒë·ªÉ xem chi ti·∫øt');
        return;
    }
    
    try {
        const response = await fetch('/api/expenses');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
            // Parse selected month
            const [year, month] = selectedMonth.split('-').map(Number);
            
            // Filter expenses for selected month
            currentExpenses = result.data.filter(expense => {
                if (!expense.date) return false;
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === month && 
                       expenseDate.getFullYear() === year;
            });
            
            if (currentExpenses.length > 0) {
                // LOAD EXISTING CATEGORIZATIONS FROM DATABASE
                console.log('üìÇ [LOAD_CATEGORIES] Loading existing categorizations from PostgreSQL...');
                
                try {
                    const categoryResponse = await fetch('/api/expense_categories');
                    const categoryData = await categoryResponse.json();
                    
                    if (categoryData.success) {
                        expenseCategories = categoryData.categories || {};
                        console.log(`‚úÖ [LOAD_CATEGORIES] Loaded ${Object.keys(expenseCategories).length} categorizations:`, expenseCategories);
                    } else {
                        console.log('‚ö†Ô∏è [LOAD_CATEGORIES] No existing categories found, starting fresh');
                        expenseCategories = {};
                    }
                } catch (error) {
                    console.error('‚ùå [LOAD_CATEGORIES] Error loading categories:', error);
                    expenseCategories = {};
                }
                
                // Show controls
                document.getElementById('multiSelectControls').style.display = 'flex';
                document.getElementById('categorySummary').style.display = 'block';
                
                // Generate enhanced expense list with checkboxes
                renderExpenseList();
                updateSummary();
            } else {
                showNoDataMessage(`Kh√¥ng c√≥ chi ph√≠ n√†o trong th√°ng ${selectedMonth}`);
            }
        } else {
            showNoDataMessage('Kh√¥ng c√≥ d·ªØ li·ªáu chi ph√≠');
        }
    } catch (error) {
        console.error('Error loading expense review:', error);
        showErrorMessage('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message);
    }
}

function renderExpenseList() {
    const reviewList = document.getElementById('expenseReviewList');
    
    // Sort expenses by date (newest first) and categorize
    const sortedExpenses = currentExpenses
        .sort((a, b) => new Date(b.date || b.expense_date) - new Date(a.date || a.expense_date));
    
    const personalExpenses = [];
    const workExpenses = [];
    const uncategorizedExpenses = [];
    
    sortedExpenses.forEach(expense => {
        const expenseId = expense.expense_id || expense.id || expense.created_at;
        const category = expenseCategories[expenseId] || '';
        
        if (category === 'personal') {
            personalExpenses.push(expense);
        } else if (category === 'work') {
            workExpenses.push(expense);
        } else {
            uncategorizedExpenses.push(expense);
        }
    });
    
    let html = `
        <!-- PROFESSIONAL CATEGORIZED EXPENSE DISPLAY -->
        <div class="expense-categories-container">
            
            <!-- Multi-select controls at top -->
            <div class="card border-0 mb-3">
                <div class="card-body p-2" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <input type="checkbox" class="form-check-input me-2" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            <small class="text-muted">Ch·ªçn t·∫•t c·∫£ (<span id="selectedCount">0</span> ƒë√£ ch·ªçn)</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-success btn-sm" onclick="categorizeSelected('personal')">
                                <i class="fas fa-user me-1"></i>C√° Nh√¢n
                            </button>
                            <button class="btn btn-info btn-sm" onclick="categorizeSelected('work')">
                                <i class="fas fa-briefcase me-1"></i>C√¥ng Vi·ªác
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    `;
    
    // Personal Expenses Section
    if (personalExpenses.length > 0) {
        const personalTotal = personalExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
        html += generateCategorySection('personal', 'C√° Nh√¢n', personalExpenses, personalTotal, 'success', 'user');
    }
    
    // Work Expenses Section  
    if (workExpenses.length > 0) {
        const workTotal = workExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
        html += generateCategorySection('work', 'C√¥ng Vi·ªác', workExpenses, workTotal, 'info', 'briefcase');
    }
    
    // Uncategorized Expenses Section
    if (uncategorizedExpenses.length > 0) {
        const uncategorizedTotal = uncategorizedExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
        html += generateCategorySection('uncategorized', 'Ch∆∞a Ph√¢n Lo·∫°i', uncategorizedExpenses, uncategorizedTotal, 'secondary', 'question-circle');
    }
    
    html += '</div>';
    reviewList.innerHTML = html;
}

// Generate professional category section with HIGH CONTRAST headers
function generateCategorySection(categoryKey, categoryName, expenses, total, colorClass, iconClass) {
    // FIXED: Use solid dark headers with white text for maximum visibility
    let headerStyle = '';
    let borderColor = '';
    
    if (colorClass === 'success') {
        // Personal - Light Green Background with BLACK text
        headerStyle = 'background: #d4edda; color: black;'; // Light green with black text
        borderColor = 'border-success';
    } else if (colorClass === 'info') {
        // Work - Light Blue Background with BLACK text
        headerStyle = 'background: #cce7f0; color: black;'; // Light blue with black text
        borderColor = 'border-info';
    } else {
        // Uncategorized - Light Gray Background with BLACK text
        headerStyle = 'background: #f8f9fa; color: black;'; // Light gray with black text
        borderColor = 'border-secondary';
    }
    
    let html = `
        <div class="card ${borderColor} mb-4">
            <div class="card-header d-flex justify-content-between align-items-center" style="${headerStyle}">
                <div>
                    <h6 class="mb-0 fw-bold text-black">
                        <i class="fas fa-${iconClass} me-2"></i>${categoryName}
                    </h6>
                    <small class="text-black">${expenses.length} giao d·ªãch</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold fs-5 text-black">${total.toLocaleString()}ƒë</div>
                    <small class="text-black">T·ªïng c·ªông</small>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="40px" class="text-center">
                                    <i class="fas fa-check-square text-${colorClass}"></i>
                                </th>
                                <th>Ng√†y</th>
                                <th>N·ªôi dung</th>
                                <th class="text-end">S·ªë ti·ªÅn</th>
                                <th class="text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    expenses.forEach(expense => {
        const amount = parseFloat(expense.amount || 0);
        const expenseDate = expense.date || expense.expense_date || expense.created_at;
        const date = expenseDate ? new Date(expenseDate).toLocaleDateString('vi-VN') : 'N/A';
        const expenseId = expense.expense_id || expense.id || expense.created_at;
        
        // Get description from corrected data
        let description = expense.description || expense.content || 'N/A';
        const safeDescription = String(description).replace(/'/g, '').replace(/"/g, '');
        
        html += `
            <tr class="expense-row" data-expense-id="${expenseId}">
                <td class="text-center">
                    <input type="checkbox" class="form-check-input expense-checkbox" 
                           value="${expenseId}" 
                           onchange="updateSelectedCount()">
                </td>
                <td>
                    <span class="badge bg-light text-dark">${date}</span>
                </td>
                <td>
                    <div class="fw-semibold">${description}</div>
                </td>
                <td class="text-end">
                    <span class="fw-bold text-${colorClass}">${amount.toLocaleString()}ƒë</span>
                </td>
                <td class="text-center">
                    <button class="btn btn-outline-danger btn-sm" 
                            onclick="deleteExpense(${expenseId}, '${safeDescription}', '${date}')"
                            title="X√≥a giao d·ªãch">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    return html;
}

function updateSummary() {
    // Calculate totals
    const totalAmount = currentExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
    
    let personalTotal = 0, workTotal = 0, personalCount = 0, workCount = 0;
    
    currentExpenses.forEach(expense => {
        const amount = parseFloat(expense.amount || 0);
        const expenseId = expense.expense_id || expense.id || expense.created_at;
        const category = expenseCategories[expenseId];
        
        if (category === 'personal') {
            personalTotal += amount;
            personalCount++;
        } else if (category === 'work') {
            workTotal += amount;
            workCount++;
        }
    });
    
    const uncategorizedAmount = totalAmount - personalTotal - workTotal;
    
    // Update UI
    document.getElementById('reviewTotalCount').textContent = currentExpenses.length;
    document.getElementById('reviewTotalAmount').textContent = `${totalAmount.toLocaleString()}ƒë`;
    document.getElementById('uncategorizedAmount').textContent = `${uncategorizedAmount.toLocaleString()}ƒë`;
    
    document.getElementById('personalCount').textContent = personalCount;
    document.getElementById('personalTotal').textContent = `${personalTotal.toLocaleString()}ƒë`;
    document.getElementById('workCount').textContent = workCount;
    document.getElementById('workTotal').textContent = `${workTotal.toLocaleString()}ƒë`;
    
    document.getElementById('expenseReviewSummary').style.display = 'block';
}

function showNoDataMessage(message) {
    document.getElementById('expenseReviewSummary').style.display = 'none';
    document.getElementById('multiSelectControls').style.display = 'none';
    document.getElementById('categorySummary').style.display = 'none';
    
    const reviewList = document.getElementById('expenseReviewList');
    reviewList.innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-calendar-times fa-2x mb-2"></i>
            <p>${message}</p>
        </div>
    `;
}

function showErrorMessage(message) {
    document.getElementById('expenseReviewSummary').style.display = 'none';
    document.getElementById('multiSelectControls').style.display = 'none';
    document.getElementById('categorySummary').style.display = 'none';
    
    const reviewList = document.getElementById('expenseReviewList');
    reviewList.innerHTML = `
        <div class="text-center text-danger py-4">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
            <p>${message}</p>
        </div>
    `;
}

// Categorize selected expenses (WITH POSTGRESQL PERSISTENCE)
function categorizeSelected(category) {
    const selectedCheckboxes = document.querySelectorAll('.expense-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt giao d·ªãch ƒë·ªÉ ph√¢n lo·∫°i');
        return;
    }
    
    const categoryName = category === 'personal' ? 'C√° Nh√¢n' : 'C√¥ng Vi·ªác';
    if (confirm(`üìÇ Ph√¢n lo·∫°i ${selectedCheckboxes.length} giao d·ªãch v√†o "${categoryName}"?`)) {
        
        // Get expense IDs from selected checkboxes
        const expenseIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
        
        console.log(`üíæ [CATEGORIZE] Saving ${expenseIds.length} expenses as ${category}:`, expenseIds);
        
        // SAVE TO POSTGRESQL DATABASE
        fetch('/api/expense_categories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                expense_ids: expenseIds,
                category: category
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`‚úÖ [CATEGORIZE] Successfully saved to database:`, data);
                
                // Update local storage only after successful database save
                selectedCheckboxes.forEach(checkbox => {
                    expenseCategories[checkbox.value] = category;
                });
                
                // Clear selections and refresh display
                clearAllSelections();
                renderExpenseList();
                updateSummary();
                
                showExpenseToast(`‚úÖ ƒê√£ ph√¢n lo·∫°i ${selectedCheckboxes.length} giao d·ªãch v√†o "${categoryName}" v√† l∆∞u v√†o database`, 'success');
            } else {
                console.error('‚ùå [CATEGORIZE] Database save failed:', data.message);
                showExpenseToast(`‚ùå L·ªói l∆∞u ph√¢n lo·∫°i: ${data.message}`, 'danger');
            }
        })
        .catch(error => {
            console.error('‚ùå [CATEGORIZE] Network error:', error);
            showExpenseToast(`‚ùå L·ªói k·∫øt n·ªëi database: ${error.message}`, 'danger');
        });
    }
}

// Select all expenses
function selectAllExpenses() {
    const checkboxes = document.querySelectorAll('.expense-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = true;
    }
    
    updateSelectedCount();
}

// Clear all selections
function clearAllSelections() {
    const checkboxes = document.querySelectorAll('.expense-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
    }
    
    updateSelectedCount();
}

// Toggle select all functionality
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const expenseCheckboxes = document.querySelectorAll('.expense-checkbox');
    
    if (selectAllCheckbox && selectAllCheckbox.checked) {
        selectAllExpenses();
    } else {
        clearAllSelections();
    }
}

// Update selected count display
function updateSelectedCount() {
    const selectedCheckboxes = document.querySelectorAll('.expense-checkbox:checked');
    const countElement = document.getElementById('selectedCount');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const totalCheckboxes = document.querySelectorAll('.expense-checkbox');
    
    if (countElement) {
        countElement.textContent = selectedCheckboxes.length;
    }
    
    // Update select all checkbox state
    if (selectAllCheckbox) {
        if (selectedCheckboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (selectedCheckboxes.length === totalCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }
}

// Toast notification for expense operations
function showExpenseToast(message, type = 'info') {
    // Remove existing expense toasts
    const existing = document.querySelectorAll('.expense-toast');
    existing.forEach(el => el.remove());
    
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const toast = document.createElement('div');
    toast.className = `alert ${alertClass} alert-dismissible fade show expense-toast`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 4000);
}

// Fix expense descriptions function
async function fixExpenseDescriptions() {
    const btn = document.getElementById('fixDescBtn');
    const originalText = btn.innerHTML;
    
    if (btn.disabled) return;
    
    if (!confirm('üîß S·ª≠a t·∫•t c·∫£ n·ªôi dung chi ph√≠ t·ª´ ng√†y th√†nh m√¥ t·∫£ ƒë√∫ng?\n\nV√≠ d·ª•: "2025-06-25" ‚Üí "mua d·∫ßu ƒÉn"\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?')) {
        return;
    }
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang s·ª≠a...';
        
        showExpenseToast('üîß ƒêang s·ª≠a n·ªôi dung chi ph√≠...', 'info');
        
        const response = await fetch('/api/fix_expense_descriptions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showExpenseToast(`‚úÖ ${result.message}`, 'success');
            
            // Reload expense data after fix
            setTimeout(() => {
                loadExpenseReview();
            }, 1000);
        } else {
            showExpenseToast(`‚ùå L·ªói: ${result.message}`, 'error');
        }
        
    } catch (error) {
        console.error('Fix descriptions error:', error);
        showExpenseToast(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Edit expense function
function editExpense(expenseId, currentDescription, currentAmount, currentDate) {
    // Create edit modal dynamically
    const editModal = document.createElement('div');
    editModal.className = 'modal fade';
    editModal.id = 'editExpenseModal';
    editModal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-edit me-2"></i>S·ª≠a Chi Ph√≠
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editExpenseForm">
                        <div class="mb-3">
                            <label for="editExpenseDescription" class="form-label">N·ªôi dung chi ph√≠</label>
                            <input type="text" class="form-control" id="editExpenseDescription" value="${currentDescription}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editExpenseAmount" class="form-label">S·ªë ti·ªÅn</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editExpenseAmount" value="${currentAmount}" step="any" required>
                                <span class="input-group-text">ƒë</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editExpenseDate" class="form-label">Ng√†y</label>
                            <input type="date" class="form-control" id="editExpenseDate" value="${currentDate}" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveExpenseEdit('${expenseId}')">
                        <i class="fas fa-save me-1"></i>L∆∞u thay ƒë·ªïi
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(editModal);
    const modal = new bootstrap.Modal(editModal);
    modal.show();
    
    // Clean up modal when hidden
    editModal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(editModal);
    });
}

// Save expense edit
async function saveExpenseEdit(expenseId) {
    const description = document.getElementById('editExpenseDescription').value.trim();
    const amount = document.getElementById('editExpenseAmount').value;
    const date = document.getElementById('editExpenseDate').value;
    
    if (!description || !amount || !date) {
        alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return;
    }
    
    const submitBtn = document.querySelector('#editExpenseModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang l∆∞u...';
    
    try {
        const response = await fetch(`/api/expenses/${expenseId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description,
                amount: parseFloat(amount),
                date: date
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showExpenseToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t chi ph√≠ th√†nh c√¥ng!', 'success');
            
            // Close modal
            forceCloseModal('editExpenseModal');
            
            // FIXED: Reload expense data after successful edit
            setTimeout(() => {
                loadMonthlyExpenses().catch(console.error);
                loadExpenseReview();
            }, 500);
        } else {
            throw new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    } catch (error) {
        console.error('Error editing expense:', error);
        showExpenseToast('‚ùå L·ªói c·∫≠p nh·∫≠t chi ph√≠: ' + error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// Delete expense function
async function deleteExpense(expenseId) {
    if (!confirm('‚ùå B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a chi ph√≠ n√†y?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/expenses/${expenseId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showExpenseToast('üóëÔ∏è ƒê√£ x√≥a chi ph√≠ th√†nh c√¥ng!', 'success');
            
            // Refresh expense review and monthly expenses
            await loadExpenseReview();
            await loadMonthlyExpenses();
        } else {
            throw new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    } catch (error) {
        console.error('Error deleting expense:', error);
        showExpenseToast('‚ùå L·ªói x√≥a chi ph√≠: ' + error.message, 'error');
    }
}

// Helper function for expense toast notifications
function showExpenseToast(message, type = 'success') {
    const colors = {
        success: 'bg-success',
        error: 'bg-danger',
        info: 'bg-info',
        warning: 'bg-warning'
    };
    
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 end-0 m-3 p-3 ${colors[type]} text-white rounded shadow`;
    toast.style.zIndex = '9999';
    toast.style.minWidth = '300px';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.transition = 'all 0.3s ease';
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }
    }, 4000);
}

// CSV Import Functionality
async function importCSVData() {
    const btn = document.getElementById('csvImportBtn');
    const originalText = btn.innerHTML;
    
    if (btn.disabled) return;
    
    // Confirm before import
    if (!confirm('üöÄ Nh·∫≠p d·ªØ li·ªáu t·ª´ file CSV v√†o PostgreSQL?\n\nƒêi·ªÅu n√†y s·∫Ω th√™m t·∫•t c·∫£ kh√°ch h√†ng, ƒë·∫∑t ph√≤ng, m·∫´u tin nh·∫Øn v√† chi ph√≠ t·ª´ csvtest.xlsx v√†o c∆° s·ªü d·ªØ li·ªáu.\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?')) {
        return;
    }
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang nh·∫≠p...';
        
        // Show progress notification
        showNotification('üöÄ B·∫Øt ƒë·∫ßu nh·∫≠p d·ªØ li·ªáu CSV...', 'info');
        
        const response = await fetch('/api/comprehensive_import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        
        const result = await response.json();
        
        if (result.success) {
            const summary = result.summary;
            const message = `‚úÖ Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!
            
üë• Kh√°ch h√†ng: ${summary.customers_imported}
üìã ƒê·∫∑t ph√≤ng: ${summary.bookings_imported}  
üí¨ M·∫´u tin nh·∫Øn: ${summary.templates_imported}
üí∞ Chi ph√≠: ${summary.expenses_imported}
üìà T·ªïng c·ªông: ${summary.total_imported} b·∫£n ghi

${result.message}`;
            
            showNotification(message, 'success');
            
            // Refresh page after 3 seconds
            setTimeout(() => {
                window.location.reload();
            }, 3000);
            
        } else {
            showNotification(`‚ùå L·ªói nh·∫≠p d·ªØ li·ªáu: ${result.message}`, 'error');
        }
        
    } catch (error) {
        console.error('Import error:', error);
        showNotification(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Enhanced notification function
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existing = document.querySelectorAll('.csv-import-notification');
    existing.forEach(el => el.remove());
    
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show csv-import-notification`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 350px;
        max-width: 500px;
        white-space: pre-line;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 8 seconds for success, 10 for errors
    const timeout = type === 'success' ? 8000 : 10000;
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, timeout);
}

// Fix Database Constraint Functionality
async function fixDatabaseConstraint() {
    const btn = document.getElementById('fixConstraintBtn');
    const originalText = btn.innerHTML;
    
    if (btn.disabled) return;
    
    // Confirm before fixing
    if (!confirm('üîß S·ª≠a l·ªói database constraint?\n\nƒêi·ªÅu n√†y s·∫Ω cho ph√©p booking status ti·∫øng Vi·ªát nh∆∞ "m·ªõi", "ƒë√£ h·ªßy".\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?')) {
        return;
    }
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang s·ª≠a...';
        
        showNotification('üîß ƒêang s·ª≠a database constraint...', 'info');
        
        const response = await fetch('/api/fix_constraint', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`‚úÖ ${result.message}\n\nüöÄ B√¢y gi·ªù b·∫°n c√≥ th·ªÉ nh·∫≠p CSV th√†nh c√¥ng!`, 'success');
        } else {
            showNotification(`‚ùå L·ªói s·ª≠a constraint: ${result.message}`, 'error');
        }
        
    } catch (error) {
        console.error('Constraint fix error:', error);
        showNotification(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Diagnostic Functionality
async function runDiagnostic() {
    const btn = document.getElementById('diagnosticBtn');
    const originalText = btn.innerHTML;
    
    if (btn.disabled) return;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Ki·ªÉm tra...';
        
        showNotification('üîç ƒêang ki·ªÉm tra d·ªØ li·ªáu ƒë√£ nh·∫≠p...', 'info');
        
        const response = await fetch('/api/diagnostic');
        const result = await response.json();
        
        if (result.success) {
            const d = result.diagnostic;
            
            const message = `üìä CH·∫®N ƒêO√ÅN D·ªÆ LI·ªÜU:
            
üóÉÔ∏è T·ªïng bookings: ${d.total_bookings}
üìÖ Ng√†y s·ªõm nh·∫•t: ${d.date_range.min_date || 'N/A'}  
üìÖ Ng√†y mu·ªôn nh·∫•t: ${d.date_range.max_date || 'N/A'}
üìÖ Th√°ng hi·ªán t·∫°i (${d.date_range.current_month_start}): ${d.date_range.current_month_bookings} bookings

üìà Ph√¢n b·ªë theo th√°ng:
${Object.entries(d.monthly_distribution).map(([month, count]) => `   ${month}: ${count} bookings`).join('\n')}

üîç Dashboard hi·ªÉn th·ªã t·ª´: ${d.dashboard_default_range.start} ƒë·∫øn ${d.dashboard_default_range.end}

üí° G·ª¢I √ù: N·∫øu kh√¥ng th·∫•y d·ªØ li·ªáu, th·ª≠:
1. Thay ƒë·ªïi Date Range trong dashboard
2. Click "All Bookings" ƒë·ªÉ xem t·∫•t c·∫£
3. Ki·ªÉm tra calendar th√°ng c√≥ booking`;
            
            showNotification(message, 'success');
            
            // If no current month bookings, suggest changing date range
            if (d.date_range.current_month_bookings === 0 && d.total_bookings > 0) {
                setTimeout(() => {
                    showNotification(`‚ö†Ô∏è PH√ÅT HI·ªÜN V·∫§N ƒê·ªÄ: C√≥ ${d.total_bookings} bookings nh∆∞ng 0 bookings trong th√°ng hi·ªán t·∫°i.\n\nüí° Th·ª≠: Click "All Bookings" ho·∫∑c thay ƒë·ªïi Date Range ƒë·ªÉ xem d·ªØ li·ªáu c≈© h∆°n.`, 'error');
                }, 3000);
            }
            
        } else {
            showNotification(`‚ùå L·ªói ki·ªÉm tra: ${result.message}`, 'error');
        }
        
    } catch (error) {
        console.error('Diagnostic error:', error);
        showNotification(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Detailed Diagnostic Functionality  
async function runDetailedDiagnostic() {
    const btn = document.getElementById('detailedDiagnosticBtn');
    const originalText = btn.innerHTML;
    
    if (btn.disabled) return;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Ph√¢n t√≠ch...';
        
        showNotification('üîç ƒêang so s√°nh Excel vs Database...', 'info');
        
        const response = await fetch('/api/detailed_diagnostic');
        const result = await response.json();
        
        if (result.success) {
            const d = result.diagnostic;
            
            const message = `üîç PH√ÇN T√çCH CHI TI·∫æT EXCEL vs DATABASE:

üìÇ EXCEL FILE ANALYSIS:
   - Sheets t√¨m th·∫•y: ${d.excel_file_analysis.sheets_found.join(', ')}
   - Sheet1 c√≥ ${d.excel_file_analysis.sheet1_rows} rows
   - Kh√°ch h√†ng trong Excel: ${d.excel_file_analysis.customers_extracted}
   - Bookings trong Excel: ${d.excel_file_analysis.bookings_extracted}
   - Templates trong Excel: ${d.excel_file_analysis.templates_extracted}
   - Expenses trong Excel: ${d.excel_file_analysis.expenses_extracted}

üíæ DATABASE HI·ªÜN T·∫†I:
   - Kh√°ch h√†ng trong DB: ${d.database_current_state.customers_in_db}
   - Bookings trong DB: ${d.database_current_state.bookings_in_db}
   - Templates trong DB: ${d.database_current_state.templates_in_db}
   - Expenses trong DB: ${d.database_current_state.expenses_in_db}

‚ùå KH√ÅCH H√ÄNG THI·∫æU: ${d.comparison.missing_customers_count}
‚ùå BOOKINGS THI·∫æU: ${d.comparison.missing_bookings_count}
‚ö†Ô∏è V·∫§N ƒê·ªÄ NG√ÄY TH√ÅNG: ${d.data_quality_issues.total_date_issues}

üö® KHUY·∫æN NGH·ªä:
${d.recommendations.join('\n')}`;
            
            showNotification(message, d.recommendations.length > 0 ? 'error' : 'success');
            
            // Show missing customers if any
            if (d.comparison.missing_customers_count > 0) {
                setTimeout(() => {
                    const missingCustomers = d.comparison.missing_customers_sample.join(', ');
                    showNotification(`‚ùå M·ªòT S·ªê KH√ÅCH H√ÄNG THI·∫æU:\n${missingCustomers}\n\nüí° C√≥ th·ªÉ do l·ªói validation ho·∫∑c duplicate detection`, 'error');
                }, 3000);
            }
            
        } else {
            showNotification(`‚ùå L·ªói ph√¢n t√≠ch: ${result.message}`, 'error');
        }
        
    } catch (error) {
        console.error('Detailed diagnostic error:', error);
        showNotification(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Import Debug Functionality
async function runImportDebug() {
    const btn = document.getElementById('importDebugBtn');
    const originalText = btn.innerHTML;
    
    if (btn.disabled) return;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Debug...';
        
        showNotification('üîç ƒêang debug t·ª´ng booking...', 'info');
        
        const response = await fetch('/api/import_debug', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            const d = result.debug;
            
            const message = `üîç DEBUG IMPORT RESULTS:

üìä T·ªîNG QUAN:
- T·ªïng bookings trong Excel: ${d.summary.total}
- ƒê∆∞·ª£c ch·∫•p nh·∫≠n: ${d.summary.accepted}
- B·ªã t·ª´ ch·ªëi: ${d.summary.rejected}
- T·ª∑ l·ªá th√†nh c√¥ng: ${d.summary.acceptance_rate.toFixed(1)}%

‚ùå L√ù DO T·ª™ CH·ªêI:
${Object.entries(d.rejection_reasons).map(([reason, count]) => `   - ${reason}: ${count} bookings`).join('\n')}

üîç M·ªòT S·ªê BOOKING B·ªä T·ª™ CH·ªêI:
${d.rejected_bookings.slice(0, 5).map(b => `   - ${b.booking_id} (${b.guest_name}): ${b.issues.join(', ')}`).join('\n')}`;
            
            showNotification(message, d.summary.rejected > 0 ? 'error' : 'success');
            
            // Show specific solutions
            if (d.rejection_reasons['Missing checkin/checkout dates'] > 0) {
                setTimeout(() => {
                    showNotification(`üí° GI·∫¢I PH√ÅP: ${d.rejection_reasons['Missing checkin/checkout dates']} bookings thi·∫øu ng√†y.\n\nC√≥ th·ªÉ l√†:\n1. D·ªØ li·ªáu Excel kh√¥ng ƒë·∫ßy ƒë·ªß\n2. C·ªôt ng√†y th√°ng sai format\n3. Parse l·ªói YYYY-MM-DD format`, 'error');
                }, 3000);
            }
            
            if (d.rejection_reasons['Already exists in database'] > 0) {
                setTimeout(() => {
                    showNotification(`üí° GI·∫¢I PH√ÅP: ${d.rejection_reasons['Already exists in database']} bookings ƒë√£ t·ªìn t·∫°i.\n\nClick "Clear & Re-import" ƒë·ªÉ x√≥a v√† nh·∫≠p l·∫°i t·∫•t c·∫£.`, 'error');
                }, 6000);
            }
            
        } else {
            showNotification(`‚ùå L·ªói debug: ${result.message}`, 'error');
        }
        
    } catch (error) {
        console.error('Import debug error:', error);
        showNotification(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Add Guest Name Column Functionality
async function addGuestNameColumn() {
    const btn = document.getElementById('addColumnBtn');
    const originalText = btn.innerHTML;
    
    if (btn.disabled) return;
    
    if (!confirm('üîß Th√™m c·ªôt guest_name v√†o PostgreSQL?\n\nƒêi·ªÅu n√†y s·∫Ω th√™m c·ªôt guest_name v√†o b·∫£ng bookings ƒë·ªÉ truy c·∫≠p nhanh t√™n kh√°ch h√†ng.\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?')) {
        return;
    }
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang th√™m...';
        
        showNotification('üîß ƒêang th√™m c·ªôt guest_name...', 'info');
        
        const response = await fetch('/api/add_guest_name_column', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`‚úÖ ${result.message}`, 'success');
        } else {
            showNotification(`‚ùå L·ªói: ${result.message}`, 'error');
        }
        
    } catch (error) {
        console.error('Add column error:', error);
        showNotification(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Clear Imported Data Functionality
async function clearImportedData() {
    const btn = document.getElementById('clearDataBtn');
    const originalText = btn.innerHTML;
    
    if (btn.disabled) return;
    
    if (!confirm('üóëÔ∏è X√ìA T·∫§T C·∫¢ D·ªÆ LI·ªÜU ƒê√É NH·∫¨P?\n\n‚ö†Ô∏è C·∫¢NH B√ÅO: ƒêi·ªÅu n√†y s·∫Ω x√≥a:\n- T·∫•t c·∫£ bookings ƒë√£ nh·∫≠p t·ª´ CSV\n- T·∫•t c·∫£ kh√°ch h√†ng ƒë√£ nh·∫≠p\n- T·∫•t c·∫£ templates v√† expenses\n\n(Ch·ªâ gi·ªØ l·∫°i 4 booking test ban ƒë·∫ßu)\n\nB·∫°n c√≥ CH·∫ÆC CH·∫ÆN mu·ªën ti·∫øp t·ª•c?')) {
        return;
    }
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x√≥a...';
        
        showNotification('üóëÔ∏è ƒêang x√≥a d·ªØ li·ªáu ƒë√£ nh·∫≠p...', 'info');
        
        const response = await fetch('/api/clear_imported_data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`‚úÖ ${result.message}\n\nüöÄ B√¢y gi·ªù b·∫°n c√≥ th·ªÉ nh·∫≠p CSV l·∫°i v·ªõi dates ƒë√∫ng!`, 'success');
            
            // Auto refresh after clearing
            setTimeout(() => {
                const url = new URL(window.location);
                url.searchParams.set('refresh', 'true');
                window.location.href = url.toString();
            }, 3000);
        } else {
            showNotification(`‚ùå L·ªói: ${result.message}`, 'error');
        }
        
    } catch (error) {
        console.error('Clear data error:', error);
        showNotification(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// =====================================================
// ARRIVAL TIME NOTIFICATION SYSTEM
// =====================================================

// Global notification tracking
let arrivalNotifications = new Map();
let notificationCheckInterval = null;

// Schedule notification for arrival time (2 hours in advance)
function scheduleArrivalNotification(bookingId, guestName, arrivalTime) {
    try {
        const [hour, minute] = arrivalTime.split(':').map(Number);
        const today = new Date();
        const arrivalDateTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour, minute);
        
        // Calculate notification time (2 hours before arrival)
        const notificationTime = new Date(arrivalDateTime.getTime() - (2 * 60 * 60 * 1000));
        const now = new Date();
        
        // Schedule notification or show immediately if time has passed
        if (notificationTime > now) {
            arrivalNotifications.set(bookingId, {
                guestName: guestName,
                arrivalTime: arrivalTime,
                notificationTime: notificationTime,
                shown: false
            });
            
            console.log(`üìÖ Scheduled notification for ${guestName} at ${notificationTime.toLocaleTimeString()}`);
        } else if (arrivalDateTime > now) {
            // Notification time has passed but arrival hasn't happened yet - show immediately
            arrivalNotifications.set(bookingId, {
                guestName: guestName,
                arrivalTime: arrivalTime,
                notificationTime: notificationTime,
                shown: false
            });
            
            console.log(`‚ö†Ô∏è Notification time passed, showing immediately for ${guestName}`);
            showArrivalNotification(bookingId, arrivalNotifications.get(bookingId));
            arrivalNotifications.get(bookingId).shown = true;
        } else {
            console.log(`‚è∞ Arrival time ${arrivalTime} has already passed for ${guestName}`);
        }
    } catch (error) {
        console.error('Error scheduling notification:', error);
    }
}

// Check for notifications that should be shown
function checkArrivalNotifications() {
    const now = new Date();
    
    arrivalNotifications.forEach((notification, bookingId) => {
        if (!notification.shown && now >= notification.notificationTime) {
            showArrivalNotification(bookingId, notification);
            notification.shown = true;
        }
    });
}

// Show arrival notification inline at top (like commission warning)
function showArrivalNotification(bookingId, notification) {
    // Remove any existing arrival notifications
    const existingNotif = document.querySelector('.arrival-notification-alert');
    if (existingNotif) {
        existingNotif.remove();
    }
    
    // Create notification element with same style as commission warning
    const notificationHtml = `
        <div class="row mb-2">
            <div class="col-12">
                <div class="alert alert-info alert-dismissible fade show arrival-notification-alert" role="alert" style="background: linear-gradient(135deg, #cff4fc 0%, #b6effb 100%); border: 2px solid #0dcaf0; animation: subtlePulse 3s ease-in-out infinite;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock text-info me-2 fs-5"></i>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-1">
                                <strong>‚è∞ ARRIVAL ALERT!</strong>
                            </h6>
                            <p class="mb-1">
                                <strong>${notification.guestName}</strong> arriving at <strong>${notification.arrivalTime}</strong> (in ~2 hours)
                            </p>
                            <div class="mt-2">
                                <button class="btn btn-success btn-sm me-2" onclick="confirmGuestArrival('${bookingId}', '${notification.guestName}')">
                                    <i class="fas fa-check me-1"></i>Confirm Arrival
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="openCollectModal('${bookingId}', '${notification.guestName}')">
                                    <i class="fas fa-money-bill-wave me-1"></i>Collect Payment
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn-close" onclick="dismissArrivalNotification()" aria-label="Close"></button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Find the commission warning section and insert after it
    const commissionWarning = document.querySelector('.alert-warning');
    if (commissionWarning && commissionWarning.closest('.row')) {
        // Insert after commission warning
        commissionWarning.closest('.row').insertAdjacentHTML('afterend', notificationHtml);
    } else {
        // Fallback: insert at top of notifications area
        const notificationsArea = document.querySelector('.row.mb-2');
        if (notificationsArea) {
            notificationsArea.insertAdjacentHTML('beforebegin', notificationHtml);
        }
    }
    
    // Auto-dismiss after 10 minutes
    setTimeout(() => {
        dismissArrivalNotification();
    }, 10 * 60 * 1000);
}

// Confirm guest arrival from notification
async function confirmGuestArrival(bookingId, guestName) {
    if (!confirm(`Confirm that ${guestName} has arrived?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/confirm_guest_arrival', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                booking_id: bookingId
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showDashboardToast(`‚úÖ Confirmed arrival for ${guestName}!`, 'success');
            
            // Dismiss the arrival notification
            dismissArrivalNotification();
            
            // Remove from notifications map
            arrivalNotifications.delete(bookingId);
            
        } else {
            throw new Error(result.message || 'Confirmation failed');
        }
    } catch (error) {
        console.error('Error confirming guest arrival:', error);
        showDashboardToast(`‚ùå Error confirming arrival: ${error.message}`, 'error');
    }
}

// Dismiss arrival notification
function dismissArrivalNotification() {
    const notification = document.querySelector('.arrival-notification-alert');
    if (notification) {
        // For inline notifications, use a fade out animation
        notification.style.transition = 'opacity 0.3s ease';
        notification.style.opacity = '0';
        setTimeout(() => {
            // Remove the entire row container
            const row = notification.closest('.row');
            if (row) {
                row.remove();
            } else {
                notification.remove();
            }
        }, 300);
    }
}

// Initialize arrival time system when page loads
function initializeArrivalTimeSystem() {
    console.log('üöÄ Initializing arrival time system...');
    
    // Load saved arrival times from localStorage
    const savedTimes = JSON.parse(localStorage.getItem('guestArrivalTimes') || '{}');
    console.log('üìã Saved arrival times:', savedTimes);
    
    // Update display and schedule notifications for existing times
    Object.entries(savedTimes).forEach(([bookingId, timeValue]) => {
        console.log(`üîç Processing saved time for booking ${bookingId}: ${timeValue}`);
        const timeElement = document.getElementById(`time-${bookingId}`);
        if (timeElement && timeValue) {
            timeElement.textContent = timeValue;
            console.log(`‚úÖ Updated display for ${bookingId} to show ${timeValue}`);
            
            // Show delete button for existing times
            const clearButton = document.getElementById(`clear-${bookingId}`);
            if (clearButton) {
                clearButton.style.display = 'inline-block';
            }
            
            // Extract guest name from nearby elements
            const button = timeElement.closest('button');
            const guestName = button ? button.getAttribute('onclick')?.match(/'([^']*)'.*'([^']*)'/)?.[2] || 'Guest' : 'Guest';
            
            // Schedule notification if within today
            scheduleArrivalNotification(bookingId, guestName, timeValue);
        }
    });
    
    // Start notification checking (every minute)
    if (notificationCheckInterval) {
        clearInterval(notificationCheckInterval);
    }
    notificationCheckInterval = setInterval(checkArrivalNotifications, 60000);
    
    console.log('‚úÖ Arrival time system initialized');
}

// CSS for inline notifications already handled by Bootstrap classes

// Initialize system when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeArrivalTimeSystem);
} else {
    initializeArrivalTimeSystem();
}

// ==================== MONTHLY GUEST DETAILS FUNCTIONALITY ====================
let currentMonthlyData = null;

function showMonthlyGuestDetails(month, type, totalAmount) {
    console.log(`üîç [MONTHLY_MODAL] Opening details for ${month} - ${type} - ${totalAmount}ƒë`);
    
    // Show modal and loading state
    const modal = new bootstrap.Modal(document.getElementById('monthlyGuestDetailsModal'));
    modal.show();
    
    // Reset modal state
    document.getElementById('monthlyGuestLoading').style.display = 'block';
    document.getElementById('monthlyGuestContent').style.display = 'none';
    document.getElementById('monthlyGuestError').style.display = 'none';
    
    // Store current data for export
    currentMonthlyData = { month, type, totalAmount };
    
    // Call API to get guest details
    fetch('/api/monthly_guest_details', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            month: month,
            type: type
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('üîç [MONTHLY_MODAL] API Response:', data);
        
        if (data.success) {
            displayMonthlyGuestDetails(data);
        } else {
            showMonthlyGuestError(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    })
    .catch(error => {
        console.error('üîç [MONTHLY_MODAL] Error:', error);
        showMonthlyGuestError('L·ªói k·∫øt n·ªëi: ' + error.message);
    });
}

function displayMonthlyGuestDetails(data) {
    // Hide loading, show content
    document.getElementById('monthlyGuestLoading').style.display = 'none';
    document.getElementById('monthlyGuestContent').style.display = 'block';
    
    // Update summary info
    document.getElementById('modalMonth').textContent = data.month;
    document.getElementById('modalStatusLabel').textContent = data.status_label;
    document.getElementById('modalTotalAmount').textContent = data.total_amount.toLocaleString();
    document.getElementById('modalGuestCount').textContent = data.count;
    
    // Update date range indicator - show actual month period
    if (data.month && data.month.includes('2025-')) {
        // Month format: "2025-05" -> show as "2025-05-01 to 2025-05-31"
        const yearMonth = data.month;
        const [year, month] = yearMonth.split('-');
        const lastDay = new Date(year, month, 0).getDate(); // Get last day of month
        document.getElementById('modalDateRange').textContent = `${yearMonth}-01 to ${yearMonth}-${lastDay}`;
    } else {
        // Fallback to dashboard filter for other cases
        const startDate = document.querySelector('input[name="start_date"]')?.value || 'Not set';
        const endDate = document.querySelector('input[name="end_date"]')?.value || 'Not set';
        document.getElementById('modalDateRange').textContent = `${startDate} to ${endDate}`;
    }
    
    // Populate guest table
    const tableBody = document.getElementById('monthlyGuestTableBody');
    tableBody.innerHTML = '';
    
    if (data.guests && data.guests.length > 0) {
        data.guests.forEach((guest, index) => {
            const row = createGuestTableRow(guest, index + 1);
            tableBody.appendChild(row);
        });
        
        // Show uncollected summary if this is uncollected data
        if (data.type === 'uncollected') {
            showInvalidCollectorBreakdown(data.guests);
        } else {
            document.getElementById('uncollectedSummary').style.display = 'none';
        }
    } else {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-inbox me-1"></i>Kh√¥ng c√≥ kh√°ch h√†ng n√†o trong danh m·ª•c n√†y
                </td>
            </tr>
        `;
    }
}

function createGuestTableRow(guest, index) {
    const row = document.createElement('tr');
    
    // Determine row styling based on collector validity
    const isValidCollector = guest.is_valid_collector;
    const rowClass = isValidCollector ? '' : 'table-warning';
    row.className = rowClass;
    
    row.innerHTML = `
        <td>
            <div class="fw-bold">${guest.guest_name}</div>
            <small class="text-muted">#${index}</small>
        </td>
        <td>
            <span class="font-monospace text-primary">${guest.booking_id}</span>
        </td>
        <td class="text-end">
            <div class="fw-bold ${isValidCollector ? 'text-success' : 'text-warning'}">
                ${guest.amount.toLocaleString()}ƒë
            </div>
        </td>
        <td class="text-center">
            <span class="badge ${getCollectorBadgeClass(guest.collector)}">
                ${guest.collector}
            </span>
        </td>
        <td class="text-center">
            <small>${guest.checkin_date}</small>
        </td>
        <td class="text-center">
            <small>${guest.checkout_date}</small>
        </td>
        <td class="text-end">
            <small class="text-warning">${guest.commission.toLocaleString()}ƒë</small>
        </td>
        <td class="text-end">
            <small class="text-info">${guest.taxi.toLocaleString()}ƒë</small>
        </td>
    `;
    
    return row;
}

function getCollectorBadgeClass(collector) {
    switch(collector) {
        case 'LOC LE': return 'bg-primary';
        case 'THAO LE': return 'bg-success';
        default: return 'bg-warning text-dark';
    }
}

function showInvalidCollectorBreakdown(guests) {
    const invalidCollectors = {};
    
    guests.forEach(guest => {
        if (!guest.is_valid_collector) {
            const collector = guest.collector;
            if (!invalidCollectors[collector]) {
                invalidCollectors[collector] = { count: 0, amount: 0 };
            }
            invalidCollectors[collector].count++;
            invalidCollectors[collector].amount += guest.amount;
        }
    });
    
    if (Object.keys(invalidCollectors).length > 0) {
        let breakdownHtml = '<div class="row">';
        
        Object.entries(invalidCollectors).forEach(([collector, data]) => {
            breakdownHtml += `
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span><strong>"${collector}":</strong></span>
                        <span>${data.count} kh√°ch, ${data.amount.toLocaleString()}ƒë</span>
                    </div>
                </div>
            `;
        });
        
        breakdownHtml += '</div>';
        
        document.getElementById('invalidCollectorBreakdown').innerHTML = breakdownHtml;
        document.getElementById('uncollectedSummary').style.display = 'block';
    } else {
        document.getElementById('uncollectedSummary').style.display = 'none';
    }
}

function showMonthlyGuestError(message) {
    document.getElementById('monthlyGuestLoading').style.display = 'none';
    document.getElementById('monthlyGuestContent').style.display = 'none';
    document.getElementById('monthlyGuestError').style.display = 'block';
    document.getElementById('monthlyGuestErrorMessage').textContent = message;
}

function retryLoadMonthlyGuests() {
    if (currentMonthlyData) {
        showMonthlyGuestDetails(currentMonthlyData.month, currentMonthlyData.type, currentMonthlyData.totalAmount);
    }
}

function exportMonthlyGuestData() {
    // Placeholder for Excel export functionality
    alert('Ch·ª©c nƒÉng xu·∫•t Excel s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai trong phi√™n b·∫£n ti·∫øp theo');
}

// ==================== COLLECTOR GUEST DETAILS FUNCTIONALITY ====================
let currentCollectorData = null;

function showCollectorGuestDetails(collectorName, totalAmount, bookingCount) {
    console.log(`üîç [COLLECTOR_MODAL] Opening details for ${collectorName} - ${totalAmount}ƒë - ${bookingCount} bookings`);
    
    // Reuse the monthly guest details modal with different content
    const modal = new bootstrap.Modal(document.getElementById('monthlyGuestDetailsModal'));
    modal.show();
    
    // Update modal title for collector details
    document.getElementById('monthlyGuestDetailsModalLabel').innerHTML = 
        '<i class="fas fa-user-check me-2"></i>Chi ti·∫øt kh√°ch c·ªßa ng∆∞·ªùi thu';
    
    // Reset modal state
    document.getElementById('monthlyGuestLoading').style.display = 'block';
    document.getElementById('monthlyGuestContent').style.display = 'none';
    document.getElementById('monthlyGuestError').style.display = 'none';
    
    // Store current data for export
    currentCollectorData = { collector: collectorName, amount: totalAmount, bookings: bookingCount };
    
    // Get current date filter from dashboard (if available)
    const dateRange = getSelectedDateRange();
    const startDate = dateRange?.start || null;
    const endDate = dateRange?.end || null;
    
    console.log('üîç [COLLECTOR_MODAL] Date range from dashboard:', dateRange);
    console.log('üîç [COLLECTOR_MODAL] Sending dates:', startDate, 'to', endDate);
    
    // Call API to get collector guest details
    fetch('/api/collector_guest_details', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            collector: collectorName,
            start_date: startDate,
            end_date: endDate
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('üîç [COLLECTOR_MODAL] API Response:', data);
        
        if (data.success) {
            displayCollectorGuestDetails(data);
        } else {
            showMonthlyGuestError(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    })
    .catch(error => {
        console.error('üîç [COLLECTOR_MODAL] Error:', error);
        showMonthlyGuestError('L·ªói k·∫øt n·ªëi: ' + error.message);
    });
}

function displayCollectorGuestDetails(data) {
    // Hide loading, show content
    document.getElementById('monthlyGuestLoading').style.display = 'none';
    document.getElementById('monthlyGuestContent').style.display = 'block';
    
    // Update summary info for collector details
    document.getElementById('modalMonth').textContent = data.period || 'Selected Period';
    document.getElementById('modalStatusLabel').textContent = `Collector: ${data.collector}`;
    document.getElementById('modalTotalAmount').textContent = data.total_amount.toLocaleString();
    document.getElementById('modalGuestCount').textContent = data.count;
    
    // Update date range indicator - use actual period from API response
    if (data.period && data.period.includes('t·ª´') && data.period.includes('ƒë·∫øn')) {
        // Period format: "t·ª´ 2025-05-01 ƒë·∫øn 2025-05-31"
        const periodText = data.period.replace('t·ª´ ', '').replace(' ƒë·∫øn ', ' to ');
        document.getElementById('modalDateRange').textContent = periodText;
    } else {
        // Fallback to dashboard filter if period format is different
        const startDate = document.querySelector('input[name="start_date"]')?.value || 'Not set';
        const endDate = document.querySelector('input[name="end_date"]')?.value || 'Not set';
        document.getElementById('modalDateRange').textContent = `${startDate} to ${endDate}`;
    }
    
    // Populate guest table
    const tableBody = document.getElementById('monthlyGuestTableBody');
    tableBody.innerHTML = '';
    
    if (data.guests && data.guests.length > 0) {
        data.guests.forEach((guest, index) => {
            const row = createCollectorGuestTableRow(guest, index + 1, data.collector);
            tableBody.appendChild(row);
        });
        
        // Hide uncollected summary for collector details
        document.getElementById('uncollectedSummary').style.display = 'none';
        
        // Show collector summary instead
        showCollectorSummary(data);
    } else {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-inbox me-1"></i>${data.collector} ch∆∞a thu ti·ªÅn t·ª´ kh√°ch n√†o trong kho·∫£ng th·ªùi gian n√†y
                </td>
            </tr>
        `;
    }
}

function createCollectorGuestTableRow(guest, index, collector) {
    const row = document.createElement('tr');
    
    // Color coding based on collector
    const collectorClass = collector === 'LOC LE' ? 'table-primary' : 
                          collector === 'THAO LE' ? 'table-success' : 'table-light';
    row.className = collectorClass;
    
    row.innerHTML = `
        <td>
            <div class="fw-bold">${guest.guest_name}</div>
            <small class="text-muted">#${index}</small>
        </td>
        <td>
            <span class="font-monospace text-primary">${guest.booking_id}</span>
        </td>
        <td class="text-end">
            <div class="fw-bold text-success">
                ${guest.amount.toLocaleString()}ƒë
            </div>
        </td>
        <td class="text-center">
            <span class="badge ${getCollectorBadgeClass(collector)}">
                ${collector}
            </span>
        </td>
        <td class="text-center">
            <small>${guest.checkin_date}</small>
        </td>
        <td class="text-center">
            <small>${guest.checkout_date}</small>
        </td>
        <td class="text-end">
            <small class="text-warning">${guest.commission.toLocaleString()}ƒë</small>
        </td>
        <td class="text-end">
            <small class="text-info">${guest.taxi.toLocaleString()}ƒë</small>
        </td>
    `;
    
    return row;
}

function showCollectorSummary(data) {
    const summaryDiv = document.getElementById('uncollectedSummary');
    summaryDiv.style.display = 'block';
    
    const breakdownDiv = document.getElementById('invalidCollectorBreakdown');
    breakdownDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <div class="text-center">
                    <div class="fw-bold text-primary fs-5">${data.total_amount.toLocaleString()}ƒë</div>
                    <small class="text-muted">T·ªïng doanh thu</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <div class="fw-bold text-warning fs-5">${data.total_commission.toLocaleString()}ƒë</div>
                    <small class="text-muted">T·ªïng hoa h·ªìng</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <div class="fw-bold text-info fs-5">${data.total_taxi.toLocaleString()}ƒë</div>
                    <small class="text-muted">T·ªïng taxi</small>
                </div>
            </div>
        </div>
    `;
    
    // Update the alert header
    const alertHeader = summaryDiv.querySelector('h6');
    alertHeader.innerHTML = `<i class="fas fa-user-check me-1"></i>T·ªïng k·∫øt thu ti·ªÅn c·ªßa ${data.collector}:`;
    
    // Update the description
    const alertDescription = summaryDiv.querySelector('.text-muted');
    alertDescription.innerHTML = `
        <i class="fas fa-info-circle me-1"></i>
        Danh s√°ch t·∫•t c·∫£ ${data.count} kh√°ch h√†ng m√† ${data.collector} ƒë√£ thu ti·ªÅn trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.
    `;
}

function getSelectedDateRange() {
    // Try to get date range from dashboard filter if available
    try {
        const startInput = document.querySelector('input[name="start_date"]');
        const endInput = document.querySelector('input[name="end_date"]');
        
        if (startInput && endInput && startInput.value && endInput.value) {
            console.log('üîç [DATE_RANGE] Found date inputs:', startInput.value, 'to', endInput.value);
            return {
                start: startInput.value,
                end: endInput.value
            };
        }
        
        // Fallback: Try to get from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const startDate = urlParams.get('start_date');
        const endDate = urlParams.get('end_date');
        
        if (startDate && endDate) {
            console.log('üîç [DATE_RANGE] Found URL params:', startDate, 'to', endDate);
            return {
                start: startDate,
                end: endDate
            };
        }
        
        console.log('üîç [DATE_RANGE] No date range found - using all time');
        return null;
    } catch (e) {
        console.log('üîç [DATE_RANGE] Error getting date range:', e);
        return null;
    }
    
    return null;
}

// =====================================================
// DATA SYNCHRONIZATION FUNCTIONS
// =====================================================

function openDataSyncModal() {
    const modal = new bootstrap.Modal(document.getElementById('dataSyncModal'));
    modal.show();
    
    // Check sync status immediately
    checkSyncStatus();
}

function checkSyncStatus() {
    const statusDiv = document.getElementById('syncStatus');
    const syncButton = document.getElementById('startSyncButton');
    
    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Checking database status...';
    syncButton.disabled = true;
    
    fetch('/api/sync/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySyncStatus(data);
                syncButton.disabled = !data.sync_needed;
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>${data.message}</div>`;
            }
        })
        .catch(error => {
            console.error('Sync status check failed:', error);
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Failed to check sync status</div>';
        });
}

function displaySyncStatus(data) {
    const statusDiv = document.getElementById('syncStatus');
    
    let html = '<div class="row">';
    
    // Local database status
    html += '<div class="col-md-6">';
    html += '<div class="card border-primary mb-3">';
    html += '<div class="card-header bg-primary text-white"><i class="fas fa-database me-2"></i>Local Database</div>';
    html += '<div class="card-body">';
    
    if (data.local_status) {
        html += '<div class="text-success mb-2"><i class="fas fa-check-circle me-1"></i>Connected</div>';
        html += '<table class="table table-sm">';
        Object.entries(data.differences).forEach(([table, counts]) => {
            html += `<tr><td>${table}</td><td class="text-end">${counts.local}</td></tr>`;
        });
        html += '</table>';
    } else {
        html += '<div class="text-danger"><i class="fas fa-times-circle me-1"></i>Connection Failed</div>';
        if (data.local_error) {
            html += `<small class="text-muted">${data.local_error}</small>`;
        }
    }
    
    html += '</div></div></div>';
    
    // Railway database status
    html += '<div class="col-md-6">';
    html += '<div class="card border-success mb-3">';
    html += '<div class="card-header bg-success text-white"><i class="fas fa-cloud me-2"></i>Railway Database</div>';
    html += '<div class="card-body">';
    
    if (data.railway_status) {
        html += '<div class="text-success mb-2"><i class="fas fa-check-circle me-1"></i>Connected</div>';
        html += '<table class="table table-sm">';
        Object.entries(data.differences).forEach(([table, counts]) => {
            html += `<tr><td>${table}</td><td class="text-end">${counts.railway}</td></tr>`;
        });
        html += '</table>';
    } else {
        html += '<div class="text-danger"><i class="fas fa-times-circle me-1"></i>Connection Failed</div>';
        if (data.railway_error) {
            html += `<small class="text-muted">${data.railway_error}</small>`;
        }
    }
    
    html += '</div></div></div>';
    html += '</div>';
    
    // Sync recommendation
    if (data.sync_needed) {
        html += '<div class="alert alert-warning">';
        html += '<h6><i class="fas fa-exclamation-triangle me-2"></i>Sync Recommended</h6>';
        html += '<p class="mb-2">Differences found between local and Railway databases:</p>';
        html += '<ul class="mb-0">';
        Object.entries(data.differences).forEach(([table, counts]) => {
            if (counts.difference !== 0) {
                const action = counts.difference > 0 ? 'add' : 'remove';
                const icon = counts.difference > 0 ? 'plus' : 'minus';
                html += `<li><i class="fas fa-${icon} me-1"></i>${table}: ${action} ${Math.abs(counts.difference)} records</li>`;
            }
        });
        html += '</ul></div>';
    } else {
        html += '<div class="alert alert-success">';
        html += '<i class="fas fa-check-circle me-2"></i>Databases are synchronized!';
        html += '</div>';
    }
    
    statusDiv.innerHTML = html;
}

function startDataSync() {
    const syncButton = document.getElementById('startSyncButton');
    const progressDiv = document.getElementById('syncProgress');
    
    syncButton.disabled = true;
    syncButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Syncing...';
    
    progressDiv.innerHTML = '<div class="progress mb-3"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div></div>';
    
    // Simulate progress updates
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        document.querySelector('.progress-bar').style.width = progress + '%';
        if (progress >= 90) {
            clearInterval(progressInterval);
        }
    }, 500);
    
    fetch('/api/sync/import_from_local', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        document.querySelector('.progress-bar').style.width = '100%';
        
        setTimeout(() => {
            if (data.success) {
                progressDiv.innerHTML = displaySyncResults(data);
                // Refresh the page after successful sync
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                progressDiv.innerHTML = displaySyncErrors(data);
            }
            
            syncButton.disabled = false;
            syncButton.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Start Sync';
        }, 1000);
    })
    .catch(error => {
        clearInterval(progressInterval);
        console.error('Sync failed:', error);
        progressDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Sync failed: ' + error.message + '</div>';
        
        syncButton.disabled = false;
        syncButton.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Start Sync';
    });
}

function displaySyncResults(data) {
    let html = '<div class="alert alert-success">';
    html += '<h6><i class="fas fa-check-circle me-2"></i>Sync Completed Successfully!</h6>';
    html += '<p class="mb-2">Data synchronization results:</p>';
    html += '<ul class="mb-0">';
    
    Object.entries(data.details).forEach(([table, result]) => {
        const icon = result.success ? 'check' : 'exclamation-triangle';
        const color = result.success ? 'text-success' : 'text-danger';
        html += `<li class="${color}"><i class="fas fa-${icon} me-1"></i>${table}: ${result.imported} records imported</li>`;
    });
    
    html += '</ul>';
    html += '<p class="mt-2 mb-0"><small class="text-muted">Page will refresh automatically in 3 seconds...</small></p>';
    html += '</div>';
    
    return html;
}

function displaySyncErrors(data) {
    let html = '<div class="alert alert-danger">';
    html += '<h6><i class="fas fa-exclamation-triangle me-2"></i>Sync Completed with Errors</h6>';
    html += '<p class="mb-2">' + data.message + '</p>';
    
    if (data.errors && data.errors.length > 0) {
        html += '<ul class="mb-0">';
        data.errors.forEach(error => {
            html += `<li>${error}</li>`;
        });
        html += '</ul>';
    }
    
    html += '</div>';
    return html;
}

</script>

<!-- Data Synchronization Modal -->
<div class="modal fade" id="dataSyncModal" tabindex="-1" aria-labelledby="dataSyncModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="dataSyncModalLabel">
                    <i class="fas fa-cloud-upload-alt me-2"></i>Database Synchronization
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        This tool synchronizes data from your local PostgreSQL database to the Railway PostgreSQL database.
                        It will update all tables including bookings, guests, expenses, and templates.
                    </p>
                </div>
                
                <div id="syncStatus">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="mt-2 text-muted">Loading sync status...</p>
                    </div>
                </div>
                
                <div id="syncProgress"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="startSyncButton" onclick="startDataSync()">
                    <i class="fas fa-sync-alt me-2"></i>Start Sync
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="checkSyncStatus()">
                    <i class="fas fa-refresh me-1"></i>Refresh Status
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/dashboard.js') }}">


</script>
{% endblock %}
