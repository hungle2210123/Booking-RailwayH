{% extends "base.html" %}
{% block title %}Qu·∫£n l√Ω ƒê·∫∑t ph√≤ng{% endblock %}

{% block head_extra %}
<style>
/* Enhanced Duplicate Booking Visual Markers - Strong Visual Distinction */
.duplicate-row {
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.15) 0%, rgba(255, 193, 7, 0.1) 100%) !important;
    border-left: 4px solid #dc3545 !important;
    border-right: 2px solid #ffc107 !important;
    box-shadow: inset 0 0 0 1px rgba(220, 53, 69, 0.1) !important;
}

.duplicate-row:hover {
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.25) 0%, rgba(255, 193, 7, 0.15) 100%) !important;
    transform: translateX(2px);
    transition: all 0.3s ease;
    box-shadow: 2px 2px 8px rgba(220, 53, 69, 0.2) !important;
}

/* Remove any remaining pseudo-element icons */
.duplicate-row::before,
.duplicate-row::after,
.table-warning::before,
.table-warning::after,
.border-warning::before,
.border-warning::after {
    content: none !important;
    display: none !important;
}

/* Ensure no tooltip icons appear */
.duplicate-row[data-bs-toggle="tooltip"]::before {
    content: none !important;
    display: none !important;
}

/* Enhanced duplicate guest name styling */
.duplicate-row .text-warning.fw-bold {
    color: #dc3545 !important; /* Strong red for better visibility */
    font-weight: 700 !important;
    text-shadow: 0 0 2px rgba(220, 53, 69, 0.4);
    text-decoration: underline;
    text-decoration-color: rgba(220, 53, 69, 0.5);
}

/* Add DUPLICATE badge */
.duplicate-row .fw-medium::after {
    content: " [DUPLICATE]";
    font-size: 0.7rem;
    color: #dc3545;
    font-weight: 600;
    background: rgba(220, 53, 69, 0.1);
    padding: 1px 4px;
    border-radius: 3px;
    margin-left: 5px;
}

/* Fixed table layout improvements */
.table-fixed {
    table-layout: fixed;
}

.table-fixed td, .table-fixed th {
    word-wrap: break-word;
    overflow: hidden;
}

/* Clean row styling */
.align-middle td {
    vertical-align: middle !important;
}

/* Improved text display */
.fw-medium {
    font-weight: 500 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-2">
    <!-- Enhanced Header with Tabs -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-primary">
            <i class="fas fa-tasks me-2"></i>Qu·∫£n l√Ω ƒê·∫∑t ph√≤ng T√≠ch h·ª£p 
            <small class="text-muted">({{ booking_count }} booking)</small>
        </h4>
        <div class="btn-group btn-group-sm">
            <button id="delete-selected-btn" class="btn btn-danger" style="display:none;">
                <i class="fas fa-trash-alt"></i> X√≥a
            </button>
            <button id="test-ai-api-btn" class="btn btn-info btn-sm" title="Test AI API">
                <i class="fas fa-flask"></i> Test API
            </button>
            <a href="{{ url_for('database_health') }}" class="btn btn-warning" title="Ki·ªÉm tra s·ª©c kh·ªèe d·ªØ li·ªáu">
                <i class="fas fa-heartbeat"></i> Data Health
            </a>
        </div>
    </div>

    <!-- Integrated Tab Navigation -->
    <div class="card mb-3">
        <div class="card-header p-0">
            <ul class="nav nav-tabs card-header-tabs" id="bookingTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-bookings-tab" data-bs-toggle="tab" data-bs-target="#all-bookings" type="button" role="tab">
                        <i class="fas fa-clipboard-list me-1"></i>T·∫•t c·∫£ Booking <span class="badge bg-primary ms-1">{{ booking_count }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="duplicate-management-tab" data-bs-toggle="tab" data-bs-target="#duplicate-management" type="button" role="tab">
                        <i class="fas fa-exclamation-triangle me-1 text-warning"></i>Qu·∫£n l√Ω Duplicate 
                        <span class="badge bg-warning ms-1" id="duplicate-count-badge">
                            {% if duplicate_report and duplicate_report.duplicate_booking_ids %}{{ duplicate_report.duplicate_booking_ids|length }}{% else %}0{% endif %}
                        </span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bulk-actions-tab" data-bs-toggle="tab" data-bs-target="#bulk-actions" type="button" role="tab">
                        <i class="fas fa-cogs me-1"></i>Bulk Actions
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content Container -->
    <div class="tab-content" id="bookingTabsContent">
        
        <!-- All Bookings Tab -->
        <div class="tab-pane fade show active" id="all-bookings" role="tabpanel" aria-labelledby="all-bookings-tab">
            <!-- Filter Active/All v·ªõi style ƒë·∫πp -->
            <div class="row mb-3">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <span class="text-muted me-3">
                                <i class="fas fa-filter me-1"></i>Hi·ªÉn th·ªã:
                            </span>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="show_filter" id="show_active" 
                                       autocomplete="off" {% if not show_all %}checked{% endif %}>
                                <label class="btn btn-outline-primary btn-sm" for="show_active">
                                    <i class="fas fa-users me-1"></i>Ch·ªâ kh√°ch c·∫ßn quan t√¢m
                                </label>

                                <input type="radio" class="btn-check" name="show_filter" id="show_all" 
                                       autocomplete="off" {% if show_all %}checked{% endif %}>
                                <label class="btn btn-outline-secondary btn-sm" for="show_all">
                                    <i class="fas fa-list me-1"></i>T·∫•t c·∫£ kh√°ch
                                </label>
                            </div>
                        </div>
                        <div class="text-end">
                            {% if not show_all %}
                            <small class="text-info">
                                <i class="fas fa-info-circle me-1"></i>
                                Hi·ªÉn th·ªã <strong>t·∫•t c·∫£ kh√°ch s·∫Øp ƒë·∫øn</strong> v√† <strong>kh√°ch ƒëang ·ªü ch∆∞a thu ti·ªÅn</strong>
                            </small>
                            {% else %}
                            <small class="text-muted">
                                <i class="fas fa-eye me-1"></i>Hi·ªÉn th·ªã t·∫•t c·∫£ kh√°ch (bao g·ªìm ƒë√£ ho√†n th√†nh)
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter form v·ªõi style m·ªõi -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light">
            <h6 class="mb-0">
                <i class="fas fa-filter me-1 text-primary"></i>
                T√¨m ki·∫øm v√† L·ªçc d·ªØ li·ªáu
            </h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('view_bookings') }}">
                <!-- Hidden fields ƒë·ªÉ gi·ªØ states -->
                <input type="hidden" name="show_all" value="{{ 'true' if show_all else 'false' }}">
                <input type="hidden" name="auto_filter" value="{{ 'true' if auto_filter_duplicates else 'false' }}">
                
                <div class="row g-3">
                    <!-- PROFESSIONAL SEARCH -->
                    <div class="col-md-4">
                        <label class="form-label small fw-medium">
                            <i class="fas fa-search me-1"></i>T√¨m ki·∫øm n√¢ng cao
                        </label>
                        <div class="input-group input-group-sm">
                            <input type="text" name="search_term" id="searchInput" 
                                   class="form-control" 
                                   placeholder="T√™n kh√°ch, booking ID, s·ªë ƒëi·ªán tho·∫°i, ghi ch√∫..." 
                                   value="{{ search_term }}"
                                   autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearch" 
                                    style="display: {% if search_term %}block{% else %}none{% endif %}">
                                <i class="fas fa-times"></i>
                            </button>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="searchStats" class="small text-muted mt-1" style="display: none;">
                            <i class="fas fa-info-circle"></i> <span id="searchStatsText"></span>
                        </div>
                    </div>
                    
                    <!-- PAGINATION CONTROLS -->
                    <div class="col-md-2">
                        <label class="form-label small fw-medium">
                            <i class="fas fa-list me-1"></i>Hi·ªÉn th·ªã
                        </label>
                        <select name="per_page" class="form-select form-select-sm" onchange="this.form.submit()">
                            <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25 m·ª•c</option>
                            <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50 m·ª•c</option>
                            <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100 m·ª•c</option>
                            <option value="200" {% if pagination.per_page == 200 %}selected{% endif %}>200 m·ª•c</option>
                        </select>
                    </div>
                    
                    <!-- Filter theo th√°ng -->
                    <div class="col-md-2">
                        <label class="form-label small fw-medium">Th√°ng</label>
                        <select name="filter_month" class="form-select form-select-sm">
                            <option value="">T·∫•t c·∫£</option>
                            {% for i in range(1, 13) %}
                            <option value="{{ i }}" {% if filter_month == i|string %}selected{% endif %}>
                                Th√°ng {{ i }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Filter theo nƒÉm -->
                    <div class="col-md-2">
                        <label class="form-label small fw-medium">NƒÉm</label>
                        <select name="filter_year" class="form-select form-select-sm">
                            <option value="">T·∫•t c·∫£</option>
                            {% for year in range(2023, 2026) %}
                            <option value="{{ year }}" {% if filter_year == year|string %}selected{% endif %}>
                                {{ year }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Ho·∫∑c filter theo kho·∫£ng ng√†y -->
                    <div class="col-md-2">
                        <label class="form-label small fw-medium">T·ª´ ng√†y</label>
                        <input type="date" name="start_date" class="form-control form-control-sm" value="{{ start_date }}">
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label small fw-medium">ƒê·∫øn ng√†y</label>
                        <input type="date" name="end_date" class="form-control form-control-sm" value="{{ end_date }}">
                    </div>
                    
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Th√°ng c√≥ s·∫µn -->
                {% if available_months %}
                <div class="mt-3">
                    <small class="text-muted">Th√°ng c√≥ d·ªØ li·ªáu: </small>
                    {% for period_str, year, month in available_months[:6] %}
                    <a href="{{ url_for('view_bookings', filter_month=month, filter_year=year) }}" 
                       class="badge bg-light text-dark text-decoration-none me-1">{{ period_str }}</a>
                    {% endfor %}
                    {% if available_months|length > 6 %}
                    <small class="text-muted">...</small>
                    {% endif %}
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- This section is removed - no auto-filter notification shown -->
    
    <!-- Store duplicate data in JavaScript for safe access -->
    <script type="application/json" id="duplicate-data">
        {% if duplicate_report and duplicate_report.duplicate_groups %}
            {% set groups = duplicate_report.duplicate_groups %}
            {% if groups %}
                {{ groups|tojson|safe }}
            {% else %}
                []
            {% endif %}
        {% else %}
            []
        {% endif %}
    </script>
    
    <!-- AI Duplicate Detection Notification (Always Enabled) -->
    {% if duplicate_report %}
        {% if duplicate_report.total_groups == 0 and duplicate_report.duplicate_booking_ids|length == 0 %}
        <div class="alert alert-success alert-dismissible mb-3" role="alert">
            <i class="fas fa-check-circle me-1"></i>
            <strong>No duplicates detected!</strong> All bookings appear to be unique.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% elif duplicate_report.total_groups == 0 and duplicate_report.duplicate_booking_ids|length > 0 %}
        <div class="alert alert-info alert-dismissible mb-3" role="alert">
            <i class="fas fa-info-circle me-1"></i>
            <strong>Duplicates detected but no filtering groups created.</strong> Some bookings may have similarities but don't meet automatic filtering criteria.
            <a href="#duplicate-management-tab" onclick="document.getElementById('duplicate-management-tab').click()" class="alert-link">Review in Duplicate Management tab</a>.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
    {% endif %}

    {% if not auto_filter_duplicates %}
    <div class="alert alert-info alert-dismissible mb-3" role="alert">
        <i class="fas fa-info-circle me-1"></i>
        Auto duplicate filtering is <strong>disabled</strong>. 
        <a href="{{ url_for('view_bookings', auto_filter='true', search_term=search_term, filter_month=filter_month, filter_year=filter_year, start_date=start_date, end_date=end_date, show_all=show_all) }}" 
           class="alert-link">Enable auto-filter</a> to hide duplicates automatically.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Duplicate Visual Markers Information (always show when duplicates exist) -->
    {% if duplicate_report and duplicate_report.duplicate_booking_ids and duplicate_report.duplicate_booking_ids|length > 0 %}
    <div class="duplicate-alert mb-3" role="alert">
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">
                <h6 class="alert-heading mb-1">
                    <i class="fas fa-users me-2"></i>
                    <strong>{{ duplicate_report.duplicate_booking_ids|length }} Duplicate Bookings Detected</strong>
                </h6>
                <p class="mb-1">
                    Duplicate bookings are highlighted with <span class="duplicate-badge">‚ö†Ô∏è yellow background</span> 
                    and <i class="fas fa-users duplicate-icon subtle"></i> icons in the table below.
                </p>
                <small class="text-muted">
                    üí° Use the <strong>"Qu·∫£n l√Ω Duplicate"</strong> tab above for detailed analysis and cleanup.
                </small>
            </div>
            <div class="text-end">
                <button class="btn btn-sm btn-outline-warning" onclick="document.getElementById('duplicate-management-tab').click()">
                    <i class="fas fa-cogs me-1"></i>Manage
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Table v·ªõi compact style -->
    <div class="table-responsive">
        <table class="table table-sm table-striped table-hover mb-0" style="font-size: 0.85rem; table-layout: fixed;">
            <thead class="table-primary sticky-top">
                <tr>
                    <th style="width: 30px; padding: 4px 8px;">
                        <input type="checkbox" id="select-all-bookings" class="form-check-input">
                    </th>
                    <th style="padding: 4px 8px; width: 100px;">
                        <a href="{{ url_for('view_bookings', search_term=search_term, filter_month=filter_month, filter_year=filter_year, start_date=start_date, end_date=end_date, sort_by='S·ªë ƒë·∫∑t ph√≤ng', order='asc' if current_sort_by == 'S·ªë ƒë·∫∑t ph√≤ng' and current_order == 'desc' else 'desc') }}" class="text-dark text-decoration-none fw-medium">
                            S·ªë ƒêB 
                            {% if current_sort_by == 'S·ªë ƒë·∫∑t ph√≤ng' %}
                                {% if current_order == 'asc' %}
                                    <i class="fas fa-sort-up fa-xs text-primary"></i>
                                {% else %}
                                    <i class="fas fa-sort-down fa-xs text-primary"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-sort fa-xs text-muted"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th style="padding: 4px 8px; width: 150px;">
                        <a href="{{ url_for('view_bookings', search_term=search_term, filter_month=filter_month, filter_year=filter_year, start_date=start_date, end_date=end_date, sort_by='T√™n ng∆∞·ªùi ƒë·∫∑t', order='asc' if current_sort_by == 'T√™n ng∆∞·ªùi ƒë·∫∑t' and current_order == 'desc' else 'desc') }}" class="text-dark text-decoration-none fw-medium">
                            üë§ Ng∆∞·ªùi ƒë·∫∑t 
                            {% if current_sort_by == 'T√™n ng∆∞·ªùi ƒë·∫∑t' %}
                                {% if current_order == 'asc' %}
                                    <i class="fas fa-sort-up fa-xs text-primary"></i>
                                {% else %}
                                    <i class="fas fa-sort-down fa-xs text-primary"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-sort fa-xs text-muted"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th style="padding: 4px 8px; min-width: 90px;">
                        <a href="{{ url_for('view_bookings', search_term=search_term, filter_month=filter_month, filter_year=filter_year, start_date=start_date, end_date=end_date, sort_by='Check-in Date', order='asc' if current_sort_by == 'Check-in Date' and current_order == 'desc' else 'desc') }}" class="text-dark text-decoration-none fw-medium">
                            üìÖ Check-in 
                            {% if current_sort_by == 'Check-in Date' %}
                                {% if current_order == 'asc' %}
                                    <i class="fas fa-sort-up fa-xs text-primary"></i>
                                {% else %}
                                    <i class="fas fa-sort-down fa-xs text-primary"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-sort fa-xs text-muted"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th style="padding: 4px 8px; min-width: 90px;">
                        <a href="{{ url_for('view_bookings', search_term=search_term, filter_month=filter_month, filter_year=filter_year, start_date=start_date, end_date=end_date, sort_by='Check-out Date', order='asc' if current_sort_by == 'Check-out Date' and current_order == 'desc' else 'desc') }}" class="text-dark text-decoration-none fw-medium">
                            üìÖ Check-out 
                            {% if current_sort_by == 'Check-out Date' %}
                                {% if current_order == 'asc' %}
                                    <i class="fas fa-sort-up fa-xs text-primary"></i>
                                {% else %}
                                    <i class="fas fa-sort-down fa-xs text-primary"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-sort fa-xs text-muted"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th style="padding: 4px 8px; width: 80px;">
                        <a href="{{ url_for('view_bookings', search_term=search_term, filter_month=filter_month, filter_year=filter_year, start_date=start_date, end_date=end_date, sort_by='T√¨nh tr·∫°ng', order='asc' if current_sort_by == 'T√¨nh tr·∫°ng' and current_order == 'desc' else 'desc') }}" class="text-dark text-decoration-none fw-medium">
                            ‚ö° Tr·∫°ng th√°i 
                            {% if current_sort_by == 'T√¨nh tr·∫°ng' %}
                                {% if current_order == 'asc' %}
                                    <i class="fas fa-sort-up fa-xs text-primary"></i>
                                {% else %}
                                    <i class="fas fa-sort-down fa-xs text-primary"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-sort fa-xs text-muted"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th class="text-end" style="padding: 4px 8px;">
                        <a href="{{ url_for('view_bookings', search_term=search_term, filter_month=filter_month, filter_year=filter_year, start_date=start_date, end_date=end_date, sort_by='T·ªïng thanh to√°n', order='asc' if current_sort_by == 'T·ªïng thanh to√°n' and current_order == 'desc' else 'desc') }}" class="text-dark text-decoration-none fw-medium">
                            üí∞ Thanh to√°n 
                            {% if current_sort_by == 'T·ªïng thanh to√°n' %}
                                {% if current_order == 'asc' %}
                                    <i class="fas fa-sort-up fa-xs text-primary"></i>
                                {% else %}
                                    <i class="fas fa-sort-down fa-xs text-primary"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-sort fa-xs text-muted"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th class="text-center" style="padding: 4px 8px;">
                        <span class="fw-medium">
                            ‚ö° Tr·∫°ng th√°i
                        </span>
                    </th>
                    <th style="padding: 4px 8px;">
                        <a href="{{ url_for('view_bookings', search_term=search_term, filter_month=filter_month, filter_year=filter_year, start_date=start_date, end_date=end_date, sort_by='Ng∆∞·ªùi thu ti·ªÅn', order='asc' if current_sort_by == 'Ng∆∞·ªùi thu ti·ªÅn' and current_order == 'desc' else 'desc') }}" class="text-dark text-decoration-none fw-medium">
                            üë®‚Äçüíº Ng∆∞·ªùi thu 
                            {% if current_sort_by == 'Ng∆∞·ªùi thu ti·ªÅn' %}
                                {% if current_order == 'asc' %}
                                    <i class="fas fa-sort-up fa-xs text-primary"></i>
                                {% else %}
                                    <i class="fas fa-sort-down fa-xs text-primary"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-sort fa-xs text-muted"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th class="text-end" style="padding: 4px 8px;">
                        <a href="{{ url_for('view_bookings', search_term=search_term, filter_month=filter_month, filter_year=filter_year, start_date=start_date, end_date=end_date, sort_by='Hoa h·ªìng', order='asc' if current_sort_by == 'Hoa h·ªìng' and current_order == 'desc' else 'desc') }}" class="text-dark text-decoration-none fw-medium">
                            üéØ Hoa h·ªìng 
                            {% if current_sort_by == 'Hoa h·ªìng' %}
                                {% if current_order == 'asc' %}
                                    <i class="fas fa-sort-up fa-xs text-primary"></i>
                                {% else %}
                                    <i class="fas fa-sort-down fa-xs text-primary"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-sort fa-xs text-muted"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th style="padding: 4px 8px;">
                        <a href="{{ url_for('view_bookings', search_term=search_term, filter_month=filter_month, filter_year=filter_year, start_date=start_date, end_date=end_date, sort_by='Taxi', order='asc' if current_sort_by == 'Taxi' and current_order == 'desc' else 'desc') }}" class="text-dark text-decoration-none fw-medium">
                            üöï Taxi 
                            {% if current_sort_by == 'Taxi' %}
                                {% if current_order == 'asc' %}
                                    <i class="fas fa-sort-up fa-xs text-primary"></i>
                                {% else %}
                                    <i class="fas fa-sort-down fa-xs text-primary"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-sort fa-xs text-muted"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th style="padding: 4px 8px; width: 60px;" class="text-dark fw-medium">Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                {% set is_duplicate = booking['S·ªë ƒë·∫∑t ph√≤ng'] in duplicate_report.duplicate_booking_ids if duplicate_report and duplicate_report.duplicate_booking_ids else false %}
                <tr class="align-middle {% if is_duplicate %}duplicate-row{% endif %}" 
                    {% if is_duplicate %}data-bs-toggle="tooltip" title="Booking tr√πng l·∫∑p - Click Duplicates button ƒë·ªÉ xem chi ti·∫øt"{% endif %}>
                    <td style="padding: 2px 8px;">
                        <input type="checkbox" name="booking_select" class="booking-checkbox form-check-input" value="{{ booking['S·ªë ƒë·∫∑t ph√≤ng'] }}">
                    </td>
                    <td style="padding: 2px 8px;">
                        <code class="small">{{ booking['S·ªë ƒë·∫∑t ph√≤ng'] }}</code>
                    </td>
                    <td style="padding: 2px 8px;">
                        <span class="fw-medium {% if is_duplicate %}text-warning fw-bold{% else %}text-dark{% endif %}" 
                              {% if is_duplicate %}title="Duplicate Booking - Click Duplicates button for details"{% endif %}>
                            {{ booking.get('T√™n ng∆∞·ªùi ƒë·∫∑t', 'N/A') }}
                        </span>
                    </td>
                    <td style="padding: 4px 8px; min-width: 90px;">
                        <div class="text-center">
                            {% set checkin_date = booking.get('Check-in Date') %}
                            {% if checkin_date|is_valid_date %}
                                <div class="badge bg-success-subtle text-success border border-success-subtle px-2 py-1" style="font-size: 0.8rem;">
                                    <strong>{{ checkin_date|safe_date_format('%d/%m/%y') }}</strong>
                                </div>
                                {% set day_name = checkin_date|safe_day_name %}
                                {% if day_name %}
                                <small class="text-muted d-block">{{ day_name }}</small>
                                {% endif %}
                            {% else %}
                                <div class="badge bg-warning-subtle text-warning border border-warning-subtle px-2 py-1" style="font-size: 0.8rem;">
                                    <strong>N/A</strong>
                                </div>
                                <!-- Enhanced debug info for admin -->
                                {% if dev_mode %}
                                <small class="text-danger d-block" style="font-size: 0.7rem;" title="L·ªói d·ªØ li·ªáu: C·∫ßn c·∫≠p nh·∫≠t ng√†y check-in trong Google Sheets">
                                    Missing Date
                                </small>
                                {% else %}
                                <small class="text-muted d-block" style="font-size: 0.7rem;">
                                    C·∫ßn c·∫≠p nh·∫≠t
                                </small>
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>
                    <td style="padding: 4px 8px; min-width: 90px;">
                        <div class="text-center">
                            {% set checkout_date = booking.get('Check-out Date') %}
                            {% if checkout_date|is_valid_date %}
                                <div class="badge bg-danger-subtle text-danger border border-danger-subtle px-2 py-1" style="font-size: 0.8rem;">
                                    <strong>{{ checkout_date|safe_date_format('%d/%m/%y') }}</strong>
                                </div>
                                {% set day_name = checkout_date|safe_day_name %}
                                {% if day_name %}
                                <small class="text-muted d-block">{{ day_name }}</small>
                                {% endif %}
                            {% else %}
                                <div class="badge bg-warning-subtle text-warning border border-warning-subtle px-2 py-1" style="font-size: 0.8rem;">
                                    <strong>N/A</strong>
                                </div>
                                <!-- Enhanced debug info for admin -->
                                {% if dev_mode %}
                                <small class="text-danger d-block" style="font-size: 0.7rem;" title="‚ö†Ô∏è L·ªói d·ªØ li·ªáu: C·∫ßn c·∫≠p nh·∫≠t ng√†y check-out trong Google Sheets">
                                    Missing Date
                                </small>
                                {% else %}
                                <small class="text-muted d-block" style="font-size: 0.7rem;">
                                    C·∫ßn c·∫≠p nh·∫≠t
                                </small>
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>
                    <td style="padding: 2px 8px;">
                        <span class="badge {{ 'bg-success' if booking.get('T√¨nh tr·∫°ng') == 'OK' else 'bg-danger' }} badge-sm">
                            {{ booking.get('T√¨nh tr·∫°ng', 'N/A') }}
                        </span>
                    </td>
                    <td class="text-end" style="padding: 2px 8px;">
                        <strong class="text-primary">{{ "{:,.0f}".format(booking.get('T·ªïng thanh to√°n', 0)) }}ƒë</strong>
                    </td>
                    <td class="text-center" style="padding: 2px 8px;">
                        {% set collector = booking.get('Ng∆∞·ªùi thu ti·ªÅn', '') %}
                        {% set valid_collectors = ['LOC LE', 'THAO LE'] %}
                        {% set has_valid_collector = collector in valid_collectors %}
                        {% if has_valid_collector %}
                            <span class="badge bg-success-subtle text-success">Collected</span>
                        {% else %}
                            <span class="badge bg-warning-subtle text-warning">Pending</span>
                        {% endif %}
                    </td>
                    <td style="padding: 2px 8px;">
                        <small class="text-muted">{{ booking.get('Ng∆∞·ªùi thu ti·ªÅn', 'N/A') }}</small>
                    </td>
                    <td class="text-end" style="padding: 2px 8px;">
                        {% set commission = booking.get('Hoa h·ªìng', 0) %}
                        {% set commission_value = commission|float if commission else 0 %}
                        {% if booking.get('S·ªë ƒë·∫∑t ph√≤ng') == '4792449210' %}
                        <!-- DEBUG: Show actual values for booking 4792449210 -->
                        <span class="text-info small">DEBUG: {{ commission }} ({{ commission_value }})</span><br>
                        {% endif %}
                        {% if commission_value > 0 %}
                        <strong class="text-warning">{{ "{:,.0f}".format(commission_value) }}ƒë</strong>
                        {% else %}
                        <small class="text-muted">-</small>
                        {% endif %}
                    </td>
                    <td style="padding: 2px 8px;">
                        {% set taxi = booking.get('Taxi', 0) %}
                        {% set taxi_value = taxi|float if taxi else 0 %}
                        {% if taxi_value > 0 %}
                        <span class="badge bg-info text-dark">{{ "{:,.0f}ƒë".format(taxi_value) }}</span>
                        {% else %}
                        <small class="text-muted">-</small>
                        {% endif %}
                    </td>
                    <td style="padding: 2px 8px;">
                        <a href="{{ url_for('edit_booking', booking_id=booking['S·ªë ƒë·∫∑t ph√≤ng']) }}" 
                           class="btn btn-outline-primary btn-sm py-0 px-1" 
                           title="Ch·ªânh s·ª≠a">
                            <i class="fas fa-edit fa-xs"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- PROFESSIONAL PAGINATION AND INFO -->
    <div class="row mt-3 align-items-center">
        <div class="col-md-6">
            <div class="text-muted small">
                <i class="fas fa-info-circle me-1"></i>
                {% if pagination %}
                Hi·ªÉn th·ªã <strong>{{ pagination.start_item }}-{{ pagination.end_item }}</strong> 
                trong t·ªïng s·ªë <strong>{{ pagination.total }}</strong> ƒë·∫∑t ph√≤ng
                {% if search_term %}
                (ƒë√£ l·ªçc theo: "{{ search_term }}")
                {% endif %}
                {% else %}
                Hi·ªÉn th·ªã {{ bookings|length }} ƒë·∫∑t ph√≤ng
                {% endif %}
            </div>
        </div>
        <div class="col-md-6">
            {% if pagination and pagination.total_pages > 1 %}
            <nav aria-label="Ph√¢n trang ƒë·∫∑t ph√≤ng">
                <ul class="pagination pagination-sm justify-content-end mb-0">
                    <!-- First page -->
                    {% if pagination.page > 2 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('view_bookings', page=1, per_page=pagination.per_page, search_term=search_term, show_all='true' if show_all else '', sort_by=sort_by, order=order) }}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    <!-- Previous page -->
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('view_bookings', page=pagination.prev_page, per_page=pagination.per_page, search_term=search_term, show_all='true' if show_all else '', sort_by=sort_by, order=order) }}">
                            <i class="fas fa-angle-left"></i> Tr∆∞·ªõc
                        </a>
                    </li>
                    {% endif %}
                    
                    <!-- Page numbers -->
                    {% for page_num in pagination.page_range|default([pagination.page]) %}
                    {% if page_num == pagination.page %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('view_bookings', page=page_num, per_page=pagination.per_page, search_term=search_term, show_all='true' if show_all else '', sort_by=sort_by, order=order) }}">
                            {{ page_num }}
                        </a>
                    </li>
                    {% endif %}
                    {% endfor %}
                    
                    <!-- Next page -->
                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('view_bookings', page=pagination.next_page, per_page=pagination.per_page, search_term=search_term, show_all='true' if show_all else '', sort_by=sort_by, order=order) }}">
                            Sau <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    <!-- Last page -->
                    {% if pagination.page < pagination.total_pages - 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('view_bookings', page=pagination.total_pages, per_page=pagination.per_page, search_term=search_term, show_all='true' if show_all else '', sort_by=sort_by, order=order) }}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
        </div>
        <!-- End All Bookings Tab -->
        
        <!-- Duplicate Management Tab -->
        <div class="tab-pane fade" id="duplicate-management" role="tabpanel" aria-labelledby="duplicate-management-tab">
            <!-- Information Banner -->
            <div class="alert alert-info border-0 shadow-sm mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle fa-2x me-3 text-primary"></i>
                    <div>
                        <h6 class="mb-1"><strong>Duplicate Management - T√≠ch h·ª£p ho√†n to√†n</strong></h6>
                        <p class="mb-0">
                            Ch·ª©c nƒÉng qu·∫£n l√Ω tr√πng l·∫∑p ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p tr·ª±c ti·∫øp v√†o giao di·ªán qu·∫£n l√Ω booking. 
                            D√πng tab n√†y ƒë·ªÉ ph√¢n t√≠ch v√† x·ª≠ l√Ω c√°c booking c√≥ th·ªÉ b·ªã tr√πng l·∫∑p trong h·ªá th·ªëng.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4">
                <!-- Statistics Cards -->
                <div class="col-md-3">
                    <div class="card bg-warning text-white text-center">
                        <div class="card-body">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <h4 id="integrated-total-groups">0</h4>
                            <small>Nh√≥m tr√πng l·∫∑p</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-center">
                        <div class="card-body">
                            <i class="fas fa-user-friends fa-2x mb-2"></i>
                            <h4 id="integrated-total-bookings">0</h4>
                            <small>Booking tr√πng l·∫∑p</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white text-center">
                        <div class="card-body">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <h4 id="integrated-processing-time">0s</h4>
                            <small>Th·ªùi gian ph√¢n t√≠ch</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white text-center">
                        <div class="card-body">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h4 id="integrated-processed-guests">0</h4>
                            <small>Kh√°ch ƒë√£ ki·ªÉm tra</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <button id="integrated-refresh-duplicates" class="btn btn-primary me-2">
                                <i class="fas fa-sync me-1"></i>L√†m m·ªõi ph√¢n t√≠ch
                            </button>
                            <button id="integrated-delete-all-selected" class="btn btn-danger btn-delete-selected me-2" disabled>
                                <i class="fas fa-trash me-1"></i>X√≥a ƒë√£ ch·ªçn (<span id="integrated-selected-count">0</span>)
                            </button>
                            <button id="integrated-select-all-duplicates" class="btn btn-outline-secondary">
                                <i class="fas fa-check-square me-1"></i>Ch·ªçn t·∫•t c·∫£ duplicate
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="loading-spinner" id="integrated-loading-spinner" style="display: none;">
                                <div class="spinner-border text-primary me-2"></div>
                                <span>ƒêang ph√¢n t√≠ch duplicates...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Duplicate Groups Container -->
            <div id="integrated-duplicates-container">
                <!-- Duplicate groups will be loaded here -->
            </div>

            <!-- No Duplicates Message -->
            <div id="integrated-no-duplicates" class="text-center py-5" style="display: none;">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h4 class="text-success">Kh√¥ng c√≥ booking tr√πng l·∫∑p!</h4>
                <p class="text-muted">T·∫•t c·∫£ bookings trong h·ªá th·ªëng ƒë·ªÅu l√† duy nh·∫•t.</p>
            </div>
        </div>
        <!-- End Duplicate Management Tab -->
        
        <!-- Bulk Actions Tab -->
        <div class="tab-pane fade" id="bulk-actions" role="tabpanel" aria-labelledby="bulk-actions-tab">
            <!-- Information Banner -->
            <div class="alert alert-success border-0 shadow-sm mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-rocket fa-2x me-3 text-success"></i>
                    <div>
                        <h6 class="mb-1"><strong>Bulk Actions - Thao t√°c h√†ng lo·∫°t</strong></h6>
                        <p class="mb-0">
                            S·ª≠ d·ª•ng c√°c checkbox ·ªü tab "T·∫•t c·∫£ Booking" ƒë·ªÉ ch·ªçn nhi·ªÅu booking c√πng l√∫c, 
                            sau ƒë√≥ th·ª±c hi·ªán c√°c thao t√°c h√†ng lo·∫°t t·∫°i ƒë√¢y.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-download me-2"></i>Export Data</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Xu·∫•t d·ªØ li·ªáu booking theo nhi·ªÅu ƒë·ªãnh d·∫°ng kh√°c nhau</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" disabled>
                                    <i class="fas fa-file-excel me-1"></i>Export Excel
                                    <small class="d-block">ƒê·ªãnh d·∫°ng .xlsx v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin</small>
                                </button>
                                <button class="btn btn-outline-success" disabled>
                                    <i class="fas fa-file-csv me-1"></i>Export CSV
                                    <small class="d-block">ƒê·ªãnh d·∫°ng .csv ƒë·ªÉ import v√†o tool kh√°c</small>
                                </button>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>Ch·ªçn booking ·ªü tab "T·∫•t c·∫£ Booking" ƒë·ªÉ k√≠ch ho·∫°t
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Bulk Edit</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Ch·ªânh s·ª≠a nhi·ªÅu booking c√πng l√∫c</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-warning" disabled>
                                    <i class="fas fa-user-edit me-1"></i>C·∫≠p nh·∫≠t ng∆∞·ªùi thu
                                    <small class="d-block">Thay ƒë·ªïi ng∆∞·ªùi thu ti·ªÅn h√†ng lo·∫°t</small>
                                </button>
                                <button class="btn btn-outline-warning" disabled>
                                    <i class="fas fa-calendar-alt me-1"></i>C·∫≠p nh·∫≠t tr·∫°ng th√°i
                                    <small class="d-block">ƒê√°nh d·∫•u ho√†n th√†nh/h·ªßy h√†ng lo·∫°t</small>
                                </button>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>T√≠nh nƒÉng s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai sau
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0"><i class="fas fa-trash me-2"></i>Bulk Delete</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">X√≥a nhi·ªÅu booking c√πng l√∫c (c·∫©n th·∫≠n!)</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-danger" id="bulk-delete-selected" style="display: none;">
                                    <i class="fas fa-trash-alt me-1"></i>X√≥a booking ƒë√£ ch·ªçn
                                    <small class="d-block">X√≥a c√°c booking ƒë∆∞·ª£c t√≠ch ch·ªçn</small>
                                </button>
                                <button class="btn btn-outline-danger" disabled>
                                    <i class="fas fa-broom me-1"></i>X√≥a duplicate
                                    <small class="d-block">T·ª± ƒë·ªông x√≥a booking tr√πng l·∫∑p</small>
                                </button>
                            </div>
                            <small class="text-danger mt-2 d-block">
                                <i class="fas fa-exclamation-triangle me-1"></i>Thao t√°c kh√¥ng th·ªÉ ho√†n t√°c!
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Bulk Actions Tab -->
        
    </div>
    <!-- End Tab Content Container -->
</div>

<!-- AI Duplicate Analysis Modal -->
<div class="modal fade" id="aiDuplicateModal" tabindex="-1" aria-labelledby="aiDuplicateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark" id="aiDuplicateModalLabel">
                    <i class="fas fa-robot me-2"></i>AI Duplicate Analysis Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="duplicateResults">
                <div class="text-center">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Analyzing...</span>
                    </div>
                    <p class="mt-2">ü§ñ AI ƒëang ph√¢n t√≠ch c√°c booking tr√πng l·∫∑p...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="refreshDuplicateAnalysis">
                    <i class="fas fa-sync-alt me-1"></i>Ph√¢n t√≠ch l·∫°i
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.badge-sm {
    font-size: 0.7rem;
}
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 1020;
}

/* Enhanced Tab Styling */
.nav-tabs .nav-link {
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.nav-tabs .nav-link:hover {
    background-color: rgba(0, 123, 255, 0.1);
    transform: translateY(-1px);
}

.nav-tabs .nav-link.active {
    background-color: #f8f9fa;
    border-bottom-color: #007bff;
    font-weight: 600;
}

.nav-tabs .nav-link .badge {
    transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover .badge {
    transform: scale(1.1);
}

/* Tab Content Enhancements */
.tab-pane {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Enhanced Card Styling for Tabs */
.tab-pane .card {
    transition: all 0.3s ease;
}

.tab-pane .card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

/* Enhanced Alert Styling */
.alert {
    border-radius: 0.75rem;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Button Enhancements in Tabs */
.tab-pane .btn[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
}

.tab-pane .btn:not([disabled]):hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const bookingCheckboxes = document.querySelectorAll('.booking-checkbox');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');

    // Add null checks to prevent errors
    if (!selectAllCheckbox || !deleteSelectedBtn) {
        console.log('‚ö†Ô∏è [BOOKINGS] Required elements not found, skipping bulk selection setup');
        return;
    }

    function toggleDeleteButton() {
        const anyChecked = Array.from(bookingCheckboxes).some(cb => cb.checked);
        if (deleteSelectedBtn) {
            deleteSelectedBtn.style.display = anyChecked ? 'inline-block' : 'none';
        }
    }

    selectAllCheckbox.addEventListener('change', function () {
        bookingCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        toggleDeleteButton();
    });

    bookingCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            if (!this.checked) {
                selectAllCheckbox.checked = false;
            } else {
                const allChecked = Array.from(bookingCheckboxes).every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
            }
            toggleDeleteButton();
        });
    });

    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', function () {
        const selectedIds = Array.from(bookingCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        if (selectedIds.length > 0 && confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ' + selectedIds.length + ' m·ª•c ƒë√£ ch·ªçn kh√¥ng?')) {
            // Show loading state
            const originalText = deleteSelectedBtn.innerHTML;
            deleteSelectedBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x√≥a...';
            deleteSelectedBtn.disabled = true;
            
            // Create timeout controller - longer timeout for multiple deletions
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout for multiple items
            
            fetch('/bookings/delete_multiple', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ids: selectedIds }),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                deleteSelectedBtn.disabled = false;
                deleteSelectedBtn.innerHTML = originalText;
                
                if (data.success) {
                    alert('‚úÖ ƒê√£ x√≥a c√°c m·ª•c ƒë√£ ch·ªçn th√†nh c√¥ng.');
                    window.location.reload();
                } else {
                    alert('‚ùå ƒê√£ x·∫£y ra l·ªói khi x√≥a: ' + data.message);
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                deleteSelectedBtn.disabled = false;
                deleteSelectedBtn.innerHTML = originalText;
                
                console.error('L·ªói:', error);
                if (error.name === 'AbortError') {
                    alert('‚è±Ô∏è Timeout: Vi·ªác x√≥a m·∫•t qu√° nhi·ªÅu th·ªùi gian. Vui l√≤ng ki·ªÉm tra l·∫°i sau ho·∫∑c th·ª≠ x√≥a t·ª´ng m·ª•c m·ªôt.');
                } else {
                    alert('‚ùå ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.');
                }
            });
        }
        });
    }

    toggleDeleteButton(); // Initial check
    
    // === Filter Active/All Toggle ===
    // REMOVED: Duplicate event listeners that conflict with initializeFilterToggle()
    // The filter toggle is now handled by initializeFilterToggle() function which uses updateFilterView()
    
    // REMOVED: updateFilterAndReload function - replaced by updateFilterView in initializeFilterToggle()
    
    // === AI Duplicate Analysis ===
    console.log('üîç SEARCHING FOR AI DUPLICATE ELEMENTS...');
    const aiDuplicateBtn = document.getElementById('ai-duplicate-filter-btn');
    const duplicateModalElement = document.getElementById('aiDuplicateModal');
    const duplicateResults = document.getElementById('duplicateResults');
    const refreshAnalysisBtn = document.getElementById('refreshDuplicateAnalysis');
    
    // Debug: Check if elements exist
    console.log('AI Duplicate elements found:', {
        aiDuplicateBtn: !!aiDuplicateBtn,
        duplicateModalElement: !!duplicateModalElement,
        duplicateResults: !!duplicateResults,
        refreshAnalysisBtn: !!refreshAnalysisBtn
    });
    
    // Only proceed if all elements exist
    if (!aiDuplicateBtn || !duplicateModalElement || !duplicateResults || !refreshAnalysisBtn) {
        console.error('‚ùå AI Duplicate Analysis: Required elements not found');
        console.log('Available button elements:', Array.from(document.querySelectorAll('button')).map(b => b.id || b.className));
        console.log('Available modal elements:', Array.from(document.querySelectorAll('.modal')).map(m => m.id));
        return;
    }
    
    console.log('‚úÖ All AI duplicate elements found, setting up...');
    
    const duplicateModal = new bootstrap.Modal(duplicateModalElement);
    
    // Function to perform duplicate analysis
    function performDuplicateAnalysis() {
        console.log('ü§ñ Starting AI duplicate analysis...');
        
        // Show loading state
        duplicateResults.innerHTML = '<div class="text-center">' +
            '<div class="spinner-border text-warning" role="status">' +
            '<span class="visually-hidden">Analyzing...</span>' +
            '</div>' +
            '<p class="mt-2">ü§ñ AI ƒëang ph√¢n t√≠ch c√°c booking tr√πng l·∫∑p...</p>' +
            '<small class="text-muted">ƒêang s·ª≠ d·ª•ng logic AI ƒë·ªÉ t√¨m kh√°ch c√≥ t√™n + gi√° + ng√†y t∆∞∆°ng t·ª±...</small>' +
            '</div>';
        
        // Call the API with timeout
        const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Request timeout after 45 seconds')), 45000);
        });
        
        const fetchPromise = fetch('/api/analyze_duplicates')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            });
        
        Promise.race([fetchPromise, timeoutPromise])
            .then(data => {
                console.log('AI Analysis result:', data);
                
                if (data.success) {
                    displayDuplicateResults(data.data);
                    
                    // Show processing time if available
                    if (data.processing_time) {
                        console.log(`‚úÖ Analysis completed in ${data.processing_time.toFixed(2)}s`);
                    }
                } else {
                    duplicateResults.innerHTML = '<div class="alert alert-danger">' +
                        '<h6><i class="fas fa-exclamation-triangle me-2"></i>L·ªói ph√¢n t√≠ch</h6>' +
                        '<p class="mb-0">' + (data.message || 'Unknown error') + '</p>' +
                        (data.error_type ? '<small class="text-muted d-block mt-1">Error type: ' + data.error_type + '</small>' : '') +
                        '</div>';
                }
            })
            .catch(error => {
                console.error('Error analyzing duplicates:', error);
                
                let errorMessage = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi server ƒë·ªÉ ph√¢n t√≠ch. Vui l√≤ng th·ª≠ l·∫°i.';
                let errorDetails = '';
                
                if (error.message.includes('timeout')) {
                    errorMessage = 'Ph√¢n t√≠ch m·∫•t qu√° nhi·ªÅu th·ªùi gian. C√≥ th·ªÉ do d·ªØ li·ªáu qu√° l·ªõn.';
                    errorDetails = '<small class="text-muted d-block mt-2">üí° G·ª£i √Ω: H·ªá th·ªëng c√≥ th·ªÉ ƒëang x·ª≠ l√Ω nhi·ªÅu d·ªØ li·ªáu. H√£y th·ª≠ l·∫°i sau v√†i ph√∫t.</small>';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = 'Server tr·∫£ v·ªÅ l·ªói: ' + error.message;
                }
                
                duplicateResults.innerHTML = '<div class="alert alert-danger">' +
                    '<h6><i class="fas fa-exclamation-triangle me-2"></i>L·ªói k·∫øt n·ªëi</h6>' +
                    '<p class="mb-0">' + errorMessage + '</p>' +
                    errorDetails +
                    '</div>';
            });
    }
    
    // Function to display duplicate analysis results
    function displayDuplicateResults(analysisData) {
        const { duplicate_groups, total_groups, total_duplicates } = analysisData;
        
        if (total_groups === 0) {
            duplicateResults.innerHTML = '<div class="alert alert-success text-center">' +
                '<i class="fas fa-check-circle fa-3x text-success mb-3"></i>' +
                '<h5>üéâ Kh√¥ng t√¨m th·∫•y booking tr√πng l·∫∑p!</h5>' +
                '<p class="mb-0">AI ƒë√£ ph√¢n t√≠ch t·∫•t c·∫£ booking v√† kh√¥ng t√¨m th·∫•y kh√°ch c√≥ t√™n + gi√° + ng√†y check-in/out t∆∞∆°ng t·ª±.</p>' +
                '<small class="text-muted">D·ªØ li·ªáu ƒë·∫∑t ph√≤ng c·ªßa b·∫°n r·∫•t s·∫°ch!</small>' +
                '</div>';
            return;
        }
        
        let html = '<div class="alert alert-warning">' +
            '<h6><i class="fas fa-exclamation-triangle me-2"></i>Ph√°t hi·ªán ' + total_groups + ' nh√≥m tr√πng l·∫∑p</h6>' +
            '<p class="mb-0">T·ªïng c·ªông ' + total_duplicates + ' booking c√≥ th·ªÉ tr√πng l·∫∑p ƒë∆∞·ª£c t√¨m th·∫•y. Ki·ªÉm tra v√† x·ª≠ l√Ω theo nhu c·∫ßu.</p>' +
            '</div>';
        
        duplicate_groups.forEach((group, index) => {
            const { main_booking, similar_bookings, group_size } = group;
            
            // Safely handle booking data with fallbacks
            const bookingId = main_booking.booking_id || 'N/A';
            const guestName = main_booking.guest_name || 'N/A';
            const checkIn = main_booking.check_in_date || 'N/A';
            const checkOut = main_booking.check_out_date || 'N/A';
            const totalPayment = main_booking.total_payment || 0;
            const status = main_booking.status || 'Unknown';
            
            // Build the status badge safely
            const statusClass = status === 'OK' ? 'bg-success' : 'bg-danger';
            
            html += '<div class="card mb-3 border-warning">' +
                '<div class="card-header bg-warning-subtle">' +
                '<h6 class="mb-0"><i class="fas fa-users me-2"></i>Nh√≥m ' + (index + 1) + ': ' + group_size + ' booking t∆∞∆°ng t·ª±</h6>' +
                '</div>' +
                '<div class="card-body">' +
                '<div class="row">' +
                '<div class="col-md-6">' +
                '<div class="card border-primary">' +
                '<div class="card-header bg-primary text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">' +
                '<small class="text-white fw-bold"><i class="fas fa-star me-1"></i>Booking ch√≠nh</small>' +
                '</div>' +
                '<div class="card-body bg-light">' +
                '<p class="mb-1 text-dark"><strong>ID:</strong> ' + bookingId + '</p>' +
                '<p class="mb-1 text-dark"><strong>T√™n:</strong> ' + guestName + '</p>' +
                '<p class="mb-1 text-dark"><strong>Check-in:</strong> ' + checkIn + '</p>' +
                '<p class="mb-1 text-dark"><strong>Check-out:</strong> ' + checkOut + '</p>' +
                '<p class="mb-1 text-dark"><strong>Gi√°:</strong> ' + (totalPayment || 0).toLocaleString() + 'ƒë</p>' +
                '<p class="mb-2 text-dark"><strong>Tr·∫°ng th√°i:</strong> <span class="badge ' + statusClass + '">' + status + '</span></p>' +
                '<div class="d-grid gap-2">' +
                '<button class="btn btn-danger btn-sm" onclick="deleteBooking(\'' + bookingId + '\')">' +
                '<i class="fas fa-trash me-1"></i>X√≥a Booking n√†y</button>' +
                '<button class="btn btn-info btn-sm" onclick="showBookingDetails(\'' + bookingId + '\')">' +
                '<i class="fas fa-eye me-1"></i>Xem chi ti·∫øt</button>' +
                '</div></div></div></div>' +
                '<div class="col-md-6">' +
                '<div class="card border-danger">' +
                '<div class="card-header bg-danger text-white">' +
                '<small><i class="fas fa-exclamation-triangle me-1"></i>' + similar_bookings.length + ' booking t∆∞∆°ng t·ª±</small>' +
                '</div>' +
                '<div class="card-body bg-light">';
            
            // Store main booking ID for use in inner loop (now using safe bookingId)
            const mainBookingId = bookingId;
            
            similar_bookings.forEach((similar, idx) => {
                // Safely handle similar booking data
                const similId = similar.booking_id || 'N/A';
                const similName = similar.guest_name || 'N/A';
                const similCheckIn = similar.check_in_date || 'N/A';
                const similPayment = similar.total_payment || 0;
                const similDateDiff = similar.date_diff || 0;
                const similPriceDiff = similar.price_diff || 0;
                
                html += '<div class="border-bottom pb-2 mb-2">' +
                    '<p class="mb-1 text-dark"><small><strong>ID:</strong> ' + similId + '</small></p>' +
                    '<p class="mb-1 text-dark"><small><strong>T√™n:</strong> ' + similName + '</small></p>' +
                    '<p class="mb-1 text-dark"><small><strong>Check-in:</strong> ' + similCheckIn + '</small></p>' +
                    '<p class="mb-1 text-dark"><small><strong>Gi√°:</strong> ' + (similPayment || 0).toLocaleString() + 'ƒë</small></p>' +
                    '<p class="mb-1"><small>' +
                    '<span class="badge bg-info">¬±' + similDateDiff + ' ng√†y</span> ' +
                    '<span class="badge bg-warning text-dark">¬±' + (similPriceDiff || 0).toLocaleString() + 'ƒë</span>' +
                    '</small></p>' +
                    '<div class="btn-group btn-group-sm">' +
                    '<button class="btn btn-outline-danger" onclick="deleteBooking(\'' + similId + '\')">' +
                    '<i class="fas fa-trash"></i> X√≥a</button>' +
                    '<button class="btn btn-outline-info" onclick="showBookingDetails(\'' + similId + '\')">' +
                    '<i class="fas fa-eye"></i> Chi ti·∫øt</button>' +
                    '<button class="btn btn-outline-warning" onclick="compareBookings(\'' + mainBookingId + '\', \'' + similId + '\')">' +
                    '<i class="fas fa-not-equal"></i> So s√°nh</button>' +
                    '</div></div>';
            });
            
            html += '</div></div></div></div>' +
                '<div class="mt-3">' +
                '<small class="text-muted">' +
                '<i class="fas fa-lightbulb me-1"></i>' +
                '<strong>G·ª£i √Ω:</strong> Ki·ªÉm tra c√°c booking n√†y c√≥ ph·∫£i c·ªßa c√πng m·ªôt kh√°ch kh√¥ng. ' +
                'N·∫øu c√≥, c√≥ th·ªÉ c·∫ßn x√≥a booking tr√πng l·∫∑p ho·∫∑c c·∫≠p nh·∫≠t th√¥ng tin.' +
                '</small>' +
                '</div>' +
                '</div>' +
                '</div>';
        });
        
        duplicateResults.innerHTML = html;
    }
    
    // Event listeners for AI duplicate functionality
    try {
        // Add click event listener
        aiDuplicateBtn.addEventListener('click', function() {
            console.log('üü¢ AI Duplicate Filter button clicked via addEventListener');
            try {
                console.log('üîµ Opening modal and starting analysis...');
                duplicateModal.show();
                performDuplicateAnalysis();
            } catch (error) {
                console.error('‚ùå Error in AI duplicate click handler:', error);
                alert('Error: ' + error.message);
            }
        });
        
        // Add fallback onclick handler
        aiDuplicateBtn.onclick = function() {
            console.log('üü° AI Duplicate Filter button clicked via onclick fallback');
            try {
                duplicateModal.show();
                performDuplicateAnalysis();
            } catch (error) {
                console.error('‚ùå Error in fallback onclick handler:', error);
                alert('Error: ' + error.message);
            }
        };
        
        refreshAnalysisBtn.addEventListener('click', function() {
            console.log('üîÑ Refresh Analysis button clicked');
            try {
                performDuplicateAnalysis();
            } catch (error) {
                console.error('‚ùå Error in refresh analysis handler:', error);
            }
        });
        
        console.log('AI Duplicate Analysis: Event listeners attached successfully');
        
    } catch (error) {
        console.error('‚ùå Error setting up AI duplicate analysis:', error);
    }
    
    // Add Test API button functionality
    const testApiBtn = document.getElementById('test-ai-api-btn');
    if (testApiBtn) {
        testApiBtn.addEventListener('click', function() {
            console.log('üß™ Testing AI API directly...');
            
            // Show immediate feedback
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            this.disabled = true;
            
            // Add timeout to test API call
            const testTimeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Test timeout after 30 seconds')), 30000);
            });
            
            const testFetchPromise = fetch('/api/analyze_duplicates')
                .then(response => {
                    console.log('üì° API Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                });
            
            Promise.race([testFetchPromise, testTimeoutPromise])
                .then(data => {
                    console.log('‚úÖ API Response data:', data);
                    const summary = {
                        success: data.success,
                        duplicates_found: data.data?.total_duplicates || 0,
                        processing_time: data.processing_time ? `${data.processing_time.toFixed(2)}s` : 'N/A',
                        message: data.message
                    };
                    alert('API Test Result:\n' + JSON.stringify(summary, null, 2));
                })
                .catch(error => {
                    console.error('‚ùå API Test failed:', error);
                    alert('API Test Failed: ' + error.message);
                })
                .finally(() => {
                    this.innerHTML = '<i class="fas fa-flask"></i> Test API';
                    this.disabled = false;
                });
        });
    }
        
        // Load duplicate data from script tag
        let duplicateGroups = [];
        try {
            const duplicateDataScript = document.getElementById('duplicate-data');
            if (duplicateDataScript) {
                duplicateGroups = JSON.parse(duplicateDataScript.textContent);
                console.log('Loaded duplicate groups data:', duplicateGroups);
            }
        } catch (error) {
            console.error('Error loading duplicate groups data:', error);
        }
        
        // Add event listeners for review duplicate buttons (from auto-filter)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('review-duplicate-btn') || e.target.closest('.review-duplicate-btn')) {
                const button = e.target.classList.contains('review-duplicate-btn') ? e.target : e.target.closest('.review-duplicate-btn');
                const mainBookingId = button.getAttribute('data-main-booking-id');
                const groupIndex = parseInt(button.getAttribute('data-group-index'));
                
                console.log('Review button clicked for booking:', mainBookingId, 'group index:', groupIndex);
                
                try {
                    // Get both main booking and similar bookings for comparison
                    if (duplicateGroups && duplicateGroups[groupIndex]) {
                        const group = duplicateGroups[groupIndex];
                        const mainBooking = group.main_booking;
                        const similarBookings = group.similar_bookings || [];
                        console.log('Found main booking:', mainBooking);
                        console.log('Found similar bookings:', similarBookings);
                        showDuplicateComparison(mainBooking, similarBookings);
                    } else {
                        console.warn('No duplicate group found for index:', groupIndex);
                        showDuplicateDetail(mainBookingId, []);
                    }
                } catch (error) {
                    console.error('Error accessing duplicate group data:', error);
                    showDuplicateDetail(mainBookingId, []);
                }
            }
        });
        
    // End of DOMContentLoaded
});

// Delete booking function for duplicate analysis with improved error handling
function deleteBooking(bookingId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a booking "' + bookingId + '" kh√¥ng?')) {
        console.log('Deleting booking:', bookingId);
        
        // Show loading indicator
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x√≥a...';
        button.disabled = true;
        
        // Simple timeout approach for better browser compatibility
        let timeoutId;
        const timeoutPromise = new Promise((_, reject) => {
            timeoutId = setTimeout(() => reject(new Error('Request timeout')), 15000);
        });
        
        // Try multiple delete endpoint first
        const fetchPromise = fetch('/bookings/delete_multiple', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ ids: [bookingId] })
        });
        
        Promise.race([fetchPromise, timeoutPromise])
        .then(response => {
            clearTimeout(timeoutId);
            console.log('Delete response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Delete response data:', data);
            button.disabled = false;
            button.innerHTML = originalText;
            
            if (data.success) {
                alert('‚úÖ ƒê√£ x√≥a booking th√†nh c√¥ng!');
                // Refresh duplicate analysis to show updated results
                performDuplicateAnalysis();
            } else {
                alert('‚ùå L·ªói khi x√≥a: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Primary delete failed, trying fallback:', error);
            
            // Check if it's a timeout error
            if (error.message === 'Request timeout') {
                console.log('Request timed out, trying fallback with shorter timeout');
            }
            
            // Fallback: try individual delete endpoint with shorter timeout
            let fallbackTimeoutId;
            const fallbackTimeoutPromise = new Promise((_, reject) => {
                fallbackTimeoutId = setTimeout(() => reject(new Error('Fallback timeout')), 10000);
            });
            
            const fallbackFetchPromise = fetch(`/booking/${bookingId}/delete`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            });
            
            Promise.race([fallbackFetchPromise, fallbackTimeoutPromise])
            .then(response => {
                clearTimeout(fallbackTimeoutId);
                button.disabled = false;
                button.innerHTML = originalText;
                
                if (response.ok) {
                    alert('‚úÖ ƒê√£ x√≥a booking th√†nh c√¥ng!');
                    performDuplicateAnalysis();
                } else {
                    throw new Error(`Fallback failed: ${response.status}`);
                }
            })
            .catch(fallbackError => {
                clearTimeout(fallbackTimeoutId);
                button.disabled = false;
                button.innerHTML = originalText;
                
                console.error('Both delete methods failed:', fallbackError);
                
                if (fallbackError.message === 'Fallback timeout') {
                    alert('‚è±Ô∏è Timeout: K·∫øt n·ªëi qu√° ch·∫≠m. Vui l√≤ng ki·ªÉm tra l·∫°i sau v√†i ph√∫t ho·∫∑c x√≥a t·ª´ trang qu·∫£n l√Ω booking.');
                } else {
                    alert('‚ùå L·ªói k·∫øt n·ªëi khi x√≥a booking. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c x√≥a t·ª´ trang qu·∫£n l√Ω booking.');
                }
            });
        });
    }
}

// === Auto-filter Duplicate Detail Function ===
function showDuplicateDetail(mainBookingId, similarBookings) {
    console.log('Showing duplicate detail for:', mainBookingId, similarBookings);
    
    // Create detail modal content
    let modalContent = '<div class="modal fade" id="duplicateDetailModal" tabindex="-1">' +
        '<div class="modal-dialog modal-lg">' +
        '<div class="modal-content">' +
        '<div class="modal-header bg-warning text-dark">' +
        '<h5 class="modal-title">' +
        '<i class="fas fa-exclamation-triangle me-2"></i>' +
        'Duplicate Group Details' +
        '</h5>' +
        '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
        '</div>' +
        '<div class="modal-body">' +
        '<div class="alert alert-info">' +
        '<strong>Main booking ID:</strong> ' + mainBookingId + ' (kept visible)' +
        '</div>' +
        '<h6>Filtered similar bookings:</h6>' +
        '<div class="row">';
    
    similarBookings.forEach((booking, index) => {
        modalContent += '<div class="col-md-6 mb-3">' +
            '<div class="card border-danger">' +
            '<div class="card-body">' +
            '<h6 class="card-title text-danger">' + (booking.guest_name || 'N/A') + '</h6>' +
            '<p class="card-text">' +
            '<strong>ID:</strong> ' + (booking.booking_id || 'N/A') + '<br>' +
            '<strong>Check-in:</strong> ' + (booking.check_in_date || 'N/A') + '<br>' +
            '<strong>Check-out:</strong> ' + (booking.check_out_date || 'N/A') + '<br>' +
            '<strong>Price:</strong> ' + (booking.total_payment || 0).toLocaleString() + ' VND<br>' +
            '<strong>Status:</strong> ' + (booking.status || 'Unknown') +
            '</p>' +
            '<div class="mb-2">' +
            '<span class="badge bg-info">¬±' + (booking.date_diff || 0) + ' days</span> ' +
            '<span class="badge bg-warning text-dark">¬±' + (booking.price_diff || 0).toLocaleString() + ' VND</span>' +
            '</div>' +
            '<button class="btn btn-danger btn-sm w-100" onclick="deleteDuplicateBooking(\'' + (booking.booking_id || '') + '\')">' +
            '<i class="fas fa-trash me-1"></i>Delete This Booking' +
            '</button>' +
            '</div>' +
            '</div>' +
            '</div>';
    });
    
    modalContent += '</div>' +
        '</div>' +
        '<div class="modal-footer">' +
        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>';
    
    // Remove existing modal if it exists
    const existingModal = document.getElementById('duplicateDetailModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('duplicateDetailModal'));
    modal.show();
}

// New function to show booking comparison with both main and duplicate bookings
function showDuplicateComparison(mainBooking, similarBookings) {
    console.log('Showing duplicate comparison for main booking:', mainBooking, 'and similar bookings:', similarBookings);
    
    // Build comparison modal content
    let modalContent = '<div class="modal fade" id="duplicateComparisonModal" tabindex="-1">' +
        '<div class="modal-dialog modal-xl">' +
        '<div class="modal-content">' +
        '<div class="modal-header bg-warning text-dark">' +
        '<h5 class="modal-title">' +
        '<i class="fas fa-balance-scale me-2"></i>' +
        'Compare Duplicate Bookings - Choose Which to Keep' +
        '</h5>' +
        '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
        '</div>' +
        '<div class="modal-body">' +
        '<div class="alert alert-info">' +
        '<i class="fas fa-info-circle me-2"></i>' +
        '<strong>Instructions:</strong> Compare the bookings below and delete the duplicate(s). ' +
        'Keep the booking with the most complete/accurate information.' +
        '</div>' +
        '<div class="row">';
    
    // Add main booking card
    modalContent += '<div class="col-md-6 mb-3">' +
        '<div class="card border-success">' +
        '<div class="card-header bg-success text-white">' +
        '<h6 class="mb-0"><i class="fas fa-star me-2"></i>Main Booking (Currently Kept)</h6>' +
        '</div>' +
        '<div class="card-body">' +
        '<table class="table table-sm">' +
        '<tr><td><strong>ID:</strong></td><td>' + (mainBooking.booking_id || 'N/A') + '</td></tr>' +
        '<tr><td><strong>Guest Name:</strong></td><td>' + (mainBooking.guest_name || 'N/A') + '</td></tr>' +
        '<tr><td><strong>Check-in:</strong></td><td>' + (mainBooking.check_in_date || 'N/A') + '</td></tr>' +
        '<tr><td><strong>Check-out:</strong></td><td>' + (mainBooking.check_out_date || 'N/A') + '</td></tr>' +
        '<tr><td><strong>Total Payment:</strong></td><td>' + (mainBooking.total_payment || 0).toLocaleString() + ' VND</td></tr>' +
        '<tr><td><strong>Status:</strong></td><td><span class="badge ' + (mainBooking.status === 'OK' ? 'bg-success' : 'bg-danger') + '">' + (mainBooking.status || 'Unknown') + '</span></td></tr>' +
        '<tr><td><strong>Commission:</strong></td><td>' + (mainBooking.commission || 0).toLocaleString() + ' VND</td></tr>' +
        '<tr><td><strong>Accommodation:</strong></td><td>' + (mainBooking.accommodation_name || 'N/A') + '</td></tr>' +
        '</table>' +
        '<div class="d-grid mt-3">' +
        '<button class="btn btn-danger" onclick="deleteDuplicateBooking(\'' + (mainBooking.booking_id || '') + '\')">' +
        '<i class="fas fa-trash me-2"></i>Delete This Main Booking' +
        '</button>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>';
    
    // Add similar bookings
    similarBookings.forEach((booking, index) => {
        modalContent += '<div class="col-md-6 mb-3">' +
            '<div class="card border-danger">' +
            '<div class="card-header bg-danger text-white">' +
            '<h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Duplicate #' + (index + 1) + '</h6>' +
            '</div>' +
            '<div class="card-body">' +
            '<table class="table table-sm">' +
            '<tr><td><strong>ID:</strong></td><td>' + (booking.booking_id || 'N/A') + '</td></tr>' +
            '<tr><td><strong>Guest Name:</strong></td><td>' + (booking.guest_name || 'N/A') + '</td></tr>' +
            '<tr><td><strong>Check-in:</strong></td><td>' + (booking.check_in_date || 'N/A') + '</td></tr>' +
            '<tr><td><strong>Check-out:</strong></td><td>' + (booking.check_out_date || 'N/A') + '</td></tr>' +
            '<tr><td><strong>Total Payment:</strong></td><td>' + (booking.total_payment || 0).toLocaleString() + ' VND</td></tr>' +
            '<tr><td><strong>Status:</strong></td><td><span class="badge ' + (booking.status === 'OK' ? 'bg-success' : 'bg-danger') + '">' + (booking.status || 'Unknown') + '</span></td></tr>' +
            '<tr><td><strong>Commission:</strong></td><td>' + (booking.commission || 0).toLocaleString() + ' VND</td></tr>' +
            '<tr><td><strong>Accommodation:</strong></td><td>' + (booking.accommodation_name || 'N/A') + '</td></tr>' +
            '</table>';
        
        // Add differences highlighting
        if (booking.date_diff !== undefined || booking.price_diff !== undefined) {
            modalContent += '<div class="alert alert-warning alert-sm">' +
                '<small><strong>Differences:</strong> ';
            if (booking.date_diff !== undefined) {
                modalContent += '¬±' + booking.date_diff + ' days ';
            }
            if (booking.price_diff !== undefined) {
                modalContent += '¬±' + (booking.price_diff || 0).toLocaleString() + ' VND';
            }
            modalContent += '</small></div>';
        }
        
        modalContent += '<div class="d-grid mt-3">' +
            '<button class="btn btn-danger" onclick="deleteDuplicateBooking(\'' + (booking.booking_id || '') + '\')">' +
            '<i class="fas fa-trash me-2"></i>Delete This Duplicate' +
            '</button>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';
    });
    
    modalContent += '</div>' +
        '</div>' +
        '<div class="modal-footer">' +
        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">' +
        '<i class="fas fa-times me-2"></i>Close Without Changes' +
        '</button>' +
        '<button type="button" class="btn btn-info" onclick="refreshDuplicateAnalysis()">' +
        '<i class="fas fa-sync me-2"></i>Refresh Analysis' +
        '</button>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>';
    
    // Remove existing modal if it exists
    const existingModal = document.getElementById('duplicateComparisonModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('duplicateComparisonModal'));
    modal.show();
}

function deleteDuplicateBooking(bookingId) {
    if (!confirm('Are you sure you want to delete booking ' + bookingId + '?')) {
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    
    fetch('/api/delete_booking/' + bookingId, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        button.disabled = false;
        button.innerHTML = originalText;
        
        if (data.success) {
            // Show success message without alert (less intrusive)
            showToast('‚úÖ Booking deleted successfully!', 'success');
            
            // Close any open modals
            const detailModal = bootstrap.Modal.getInstance(document.getElementById('duplicateDetailModal'));
            const comparisonModal = bootstrap.Modal.getInstance(document.getElementById('duplicateComparisonModal'));
            if (detailModal) detailModal.hide();
            if (comparisonModal) comparisonModal.hide();
            
            // Remove the booking from the DOM dynamically instead of page reload
            removeDynamicallyBookingFromDisplay(bookingId);
            
            // Update booking counts and statistics
            updateBookingStatistics();
        } else {
            alert('‚ùå Error deleting booking: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        button.disabled = false;
        button.innerHTML = originalText;
        console.error('Error deleting booking:', error);
        alert('‚ùå Network error deleting booking. Please try again.');
    });
}

// Helper function to dynamically remove booking from display
function removeDynamicallyBookingFromDisplay(bookingId) {
    // Find and remove the booking row from the table
    const bookingRows = document.querySelectorAll('tbody tr');
    bookingRows.forEach(row => {
        // Check if this row contains the booking ID
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
            if (cell.textContent.includes(bookingId)) {
                // Add fade out animation
                row.style.transition = 'all 0.3s ease';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';
                
                // Remove the row after animation
                setTimeout(() => {
                    row.remove();
                    console.log(`‚úÖ Removed booking ${bookingId} from display`);
                }, 300);
            }
        });
    });
}

// Helper function to update booking statistics after deletion
function updateBookingStatistics() {
    // Update the total booking count in the header
    const remainingRows = document.querySelectorAll('tbody tr').length;
    const headerElement = document.querySelector('.d-flex.justify-content-between h2');
    if (headerElement) {
        // Update the count in parentheses
        headerElement.innerHTML = headerElement.innerHTML.replace(/\(\d+\)/, `(${remainingRows})`);
    }
    
    // Trigger duplicate analysis refresh if the analyze button is visible
    const analyzeBtn = document.querySelector('button[onclick="performDuplicateAnalysis()"]');
    if (analyzeBtn && !analyzeBtn.disabled) {
        console.log('üîÑ Refreshing duplicate analysis after deletion...');
        setTimeout(() => {
            performDuplicateAnalysis();
        }, 500);
    }
}

// Helper function to show toast notifications (non-blocking)
function showToast(message, type = 'success') {
    const colors = {
        success: 'bg-success',
        error: 'bg-danger', 
        info: 'bg-info',
        warning: 'bg-warning'
    };
    
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 end-0 m-3 p-3 ${colors[type]} text-white rounded shadow`;
    toast.style.zIndex = '9999';
    toast.style.minWidth = '300px';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.transition = 'all 0.3s ease';
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// Show booking details function
function showBookingDetails(bookingId) {
    console.log('Showing details for booking:', bookingId);
    
    // Create a simple alert for now - can be enhanced later
    alert(`üìã Chi ti·∫øt booking ${bookingId}\n\nCh·ª©c nƒÉng n√†y s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn th√™m ƒë·ªÉ hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt booking trong modal popup.`);
}

// Compare two bookings function
function compareBookings(mainBookingId, similarBookingId) {
    console.log('Comparing bookings:', mainBookingId, 'vs', similarBookingId);
    
    // For now, show a simple comparison alert
    if (confirm('üîç So s√°nh booking ' + mainBookingId + ' v·ªõi ' + similarBookingId + '\n\nB·∫°n c√≥ mu·ªën m·ªü c·∫£ 2 booking trong tab m·ªõi ƒë·ªÉ so s√°nh kh√¥ng?')) {
        // Open both bookings in new tabs for manual comparison
        window.open('/booking/' + mainBookingId + '/edit', '_blank');
        window.open('/booking/' + similarBookingId + '/edit', '_blank');
    }
}

function refreshDuplicateAnalysis() {
    console.log('Refreshing duplicate analysis...');
    // Close any open modals
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // Reload the page to get fresh data
    window.location.reload();
}

// ============================================================================
// PROFESSIONAL SEARCH & UX ENHANCEMENTS
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    initializeProfessionalSearch();
    initializeProfessionalPagination();
    displaySearchStats();
});

function initializeProfessionalSearch() {
    const searchInput = document.getElementById('searchInput');
    const clearButton = document.getElementById('clearSearch');
    const searchStats = document.getElementById('searchStats');
    
    if (!searchInput) return;
    
    // Professional search input handling
    searchInput.addEventListener('input', function() {
        const hasValue = this.value.trim().length > 0;
        clearButton.style.display = hasValue ? 'block' : 'none';
        
        // Show real-time feedback
        if (hasValue && this.value.length >= 2) {
            searchStats.style.display = 'block';
            document.getElementById('searchStatsText').textContent = 
                `Nh·∫•n Enter ƒë·ªÉ t√¨m ki·∫øm "${this.value.trim()}"`;
        } else {
            searchStats.style.display = 'none';
        }
    });
    
    // Clear search functionality
    clearButton.addEventListener('click', function() {
        searchInput.value = '';
        this.style.display = 'none';
        searchStats.style.display = 'none';
        
        // Auto-submit to clear results
        const form = searchInput.closest('form');
        if (form) {
            // Remove search_term parameter and submit
            const url = new URL(window.location);
            url.searchParams.delete('search_term');
            url.searchParams.set('page', '1'); // Reset to first page
            window.location.href = url.toString();
        }
    });
    
    // Professional keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.blur();
            if (this.value) {
                clearButton.click();
            }
        }
    });
}

function initializeProfessionalPagination() {
    // Add loading states to pagination links
    const paginationLinks = document.querySelectorAll('.pagination .page-link');
    
    paginationLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            // Add loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            this.style.pointerEvents = 'none';
            
            // Restore if navigation doesn't happen (in case of errors)
            setTimeout(() => {
                this.innerHTML = originalText;
                this.style.pointerEvents = 'auto';
            }, 5000);
        });
    });
}

function displaySearchStats() {
    {% if search_term and pagination %}
    // Show search results summary
    const searchStats = document.getElementById('searchStats');
    const searchStatsText = document.getElementById('searchStatsText');
    
    if (searchStats && searchStatsText) {
        searchStats.style.display = 'block';
        const totalResults = {{ pagination.total }};
        const currentPage = {{ pagination.page }};
        const totalPages = {{ pagination.total_pages }};
        
        if (totalResults === 0) {
            searchStatsText.innerHTML = '<span class="text-warning">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o</span>';
        } else {
            searchStatsText.innerHTML = 
                `T√¨m th·∫•y <strong>${totalResults}</strong> k·∫øt qu·∫£` +
                (totalPages > 1 ? ` (trang ${currentPage}/${totalPages})` : '');
        }
    }
    {% endif %}
}

// Professional table enhancements
function enhanceTableExperience() {
    // Add row hover effects
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
}

// Initialize table enhancements
document.addEventListener('DOMContentLoaded', enhanceTableExperience);

// ============================================================================
// DELETE MULTIPLE BOOKINGS FUNCTIONALITY
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    initializeDeleteFunctionality();
    initializeFilterToggle();
});

function initializeDeleteFunctionality() {
    const deleteBtn = document.getElementById('delete-selected-btn');
    const selectAllCheckbox = document.getElementById('select-all-bookings');
    
    if (!deleteBtn) return;
    
    // Handle delete button click
    deleteBtn.addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('input[name="booking_select"]:checked');
        
        if (selectedCheckboxes.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt booking ƒë·ªÉ x√≥a');
            return;
        }
        
        const bookingIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${bookingIds.length} booking ƒë√£ ch·ªçn kh√¥ng?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
            deleteMultipleBookings(bookingIds);
        }
    });
    
    // Handle individual checkbox changes
    document.addEventListener('change', function(e) {
        if (e.target.name === 'booking_select') {
            updateDeleteButtonVisibility();
        }
    });
    
    // Handle select all checkbox
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const individualCheckboxes = document.querySelectorAll('input[name="booking_select"]');
            individualCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            updateDeleteButtonVisibility();
        });
    }
}

function updateDeleteButtonVisibility() {
    const selectedCheckboxes = document.querySelectorAll('input[name="booking_select"]:checked');
    const deleteBtn = document.getElementById('delete-selected-btn');
    const selectAllCheckbox = document.getElementById('select-all-bookings');
    
    if (deleteBtn) {
        if (selectedCheckboxes.length > 0) {
            deleteBtn.style.display = 'inline-block';
            deleteBtn.innerHTML = `<i class="fas fa-trash-alt"></i> X√≥a (${selectedCheckboxes.length})`;
        } else {
            deleteBtn.style.display = 'none';
        }
    }
    
    // Update select all checkbox state
    if (selectAllCheckbox) {
        const allCheckboxes = document.querySelectorAll('input[name="booking_select"]');
        if (allCheckboxes.length > 0) {
            selectAllCheckbox.checked = selectedCheckboxes.length === allCheckboxes.length;
            selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < allCheckboxes.length;
        }
    }
}

function deleteMultipleBookings(bookingIds) {
    const deleteBtn = document.getElementById('delete-selected-btn');
    
    // Show loading state
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x√≥a...';
    deleteBtn.disabled = true;
    
    fetch('/bookings/delete_multiple', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            booking_ids: bookingIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            
            // Reload page after short delay to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast(data.message, 'error');
            
            // Restore button state
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showToast('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
        
        // Restore button state
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
    });
}

// ============================================================================
// FILTER TOGGLE FUNCTIONALITY
// ============================================================================

function initializeFilterToggle() {
    console.log('üîç Initializing filter toggle...');
    const showActiveRadio = document.getElementById('show_active');
    const showAllRadio = document.getElementById('show_all');
    
    console.log('Filter elements found:', {
        showActiveRadio: !!showActiveRadio,
        showAllRadio: !!showAllRadio
    });
    
    if (showActiveRadio) {
        showActiveRadio.addEventListener('change', function() {
            console.log('üü¢ Show Active radio clicked, checked:', this.checked, 'ID:', this.id);
            if (this.checked && this.id === 'show_active') {
                console.log('üéØ Switching to ACTIVE filter (show_all=false)');
                window.updateFilterView(false); // Show interested guests
            }
        });
    } else {
        console.error('‚ùå show_active radio button not found');
    }
    
    if (showAllRadio) {
        showAllRadio.addEventListener('change', function() {
            console.log('üü¢ Show All radio clicked, checked:', this.checked, 'ID:', this.id);
            if (this.checked && this.id === 'show_all') {
                console.log('üéØ Switching to ALL filter (show_all=true)');
                window.updateFilterView(true); // Show all guests
            }
        });
    } else {
        console.error('‚ùå show_all radio button not found');
    }
    
    console.log('‚úÖ Filter toggle initialization complete');
}

// Local reference for use within DOMContentLoaded
function updateFilterView(showAll) {
    return window.updateFilterView(showAll);
}
</script>

<!-- Global AI Test Functions (Outside DOMContentLoaded) -->
<script>
// Make updateFilterView globally accessible (MUST be outside DOMContentLoaded)
window.updateFilterView = function(showAll) {
    console.log('üîÑ window.updateFilterView called with showAll:', showAll);
    
    // Get current URL parameters
    const url = new URL(window.location);
    console.log('Current URL:', url.toString());
    
    // Update show_all parameter
    url.searchParams.set('show_all', showAll ? 'true' : 'false');
    console.log('Updated URL will be:', url.toString());
    
    // Reset to first page when changing filter
    url.searchParams.set('page', '1');
    
    // Show loading state
    const filterButtons = document.querySelectorAll('input[name="show_filter"]');
    console.log('Found filter buttons:', filterButtons.length);
    filterButtons.forEach(btn => btn.disabled = true);
    
    // Add loading indicator
    const loadingIndicator = document.createElement('div');
    loadingIndicator.className = 'position-fixed top-50 start-50 translate-middle bg-primary text-white p-3 rounded shadow';
    loadingIndicator.style.zIndex = '9999';
    loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang t·∫£i d·ªØ li·ªáu...';
    document.body.appendChild(loadingIndicator);
    
    console.log('üöÄ Navigating to:', url.toString());
    // Navigate to new URL
    window.location.href = url.toString();
};

// Global function to test AI button (can be called from console)
window.testAIDuplicateButton = function() {
    console.log('üß™ Manual AI Duplicate Button Test');
    const btn = document.getElementById('ai-duplicate-filter-btn');
    const modal = document.getElementById('aiDuplicateModal');
    
    console.log('Button found:', !!btn);
    console.log('Modal found:', !!modal);
    
    if (btn) {
        console.log('üî• Clicking button programmatically...');
        btn.click();
    } else {
        console.log('‚ùå Button not found!');
    }
};

// Global function to test filter buttons
window.testShowAllFilter = function() {
    console.log('üß™ Testing Show All Filter');
    const showAllRadio = document.getElementById('show_all');
    console.log('Show All radio found:', !!showAllRadio);
    if (showAllRadio) {
        console.log('Current checked state:', showAllRadio.checked);
        console.log('üî• Manually calling window.updateFilterView(true)...');
        window.updateFilterView(true);
    }
};

window.testShowActiveFilter = function() {
    console.log('üß™ Testing Show Active Filter');
    const showActiveRadio = document.getElementById('show_active');
    console.log('Show Active radio found:', !!showActiveRadio);
    if (showActiveRadio) {
        console.log('Current checked state:', showActiveRadio.checked);
        console.log('üî• Manually calling window.updateFilterView(false)...');
        window.updateFilterView(false);
    }
};

// Global function to test API directly (can be called from console)  
window.testAIAPI = function() {
    console.log('üî• Testing AI API directly...');
    
    const globalTimeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Global test timeout after 30 seconds')), 30000);
    });
    
    const globalFetchPromise = fetch('/api/analyze_duplicates')
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        });
    
    Promise.race([globalFetchPromise, globalTimeoutPromise])
        .then(data => {
            console.log('API Response:', data);
            alert('API works! Check console for details.');
        })
        .catch(error => {
            console.error('API Error:', error);
            alert('API failed: ' + error.message);
        });
};

// Global function to force AI modal open
window.forceOpenAIModal = function() {
    console.log('üîß Force opening AI modal...');
    const modal = document.getElementById('aiDuplicateModal');
    if (modal) {
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        console.log('‚úÖ Modal opened');
    } else {
        console.log('‚ùå Modal not found');
    }
};

console.log('‚úÖ Global AI test functions loaded');

// Debug function to check AI button setup
window.checkAIButtonSetup = function() {
    console.log('üîç Checking AI Button Setup...');
    
    const btn = document.getElementById('ai-duplicate-filter-btn');
    const modal = document.getElementById('aiDuplicateModal');
    const results = document.getElementById('duplicateResults');
    
    console.log('Elements found:');
    console.log('  Button:', !!btn, btn);
    console.log('  Modal:', !!modal, modal);
    console.log('  Results div:', !!results, results);
    
    if (btn) {
        console.log('Button properties:');
        console.log('  ID:', btn.id);
        console.log('  Classes:', btn.className);
        console.log('  Disabled:', btn.disabled);
        console.log('  OnClick:', btn.onclick);
        console.log('  Event listeners:', getEventListeners ? getEventListeners(btn) : 'getEventListeners not available');
    }
    
    return {
        button: !!btn,
        modal: !!modal,
        results: !!results
    };
};
</script>

<!-- AI Duplicate Analysis Modal -->
<div class="modal fade" id="aiDuplicateModal" tabindex="-1" aria-labelledby="aiDuplicateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="aiDuplicateModalLabel">
                    <i class="fas fa-robot me-2"></i>AI Duplicate Analysis
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="duplicateResults">
                    <div class="text-center">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">ü§ñ AI ƒëang ph√¢n t√≠ch c√°c booking tr√πng l·∫∑p...</p>
                        <small class="text-muted">ƒêang s·ª≠ d·ª•ng logic AI ƒë·ªÉ t√¨m kh√°ch c√≥ t√™n + gi√° + ng√†y t∆∞∆°ng t·ª±...</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="refreshDuplicateAnalysis">
                    <i class="fas fa-sync-alt me-1"></i>Ph√¢n t√≠ch l·∫°i
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Integrated Duplicate Management JavaScript -->
<script>
// Integrated duplicate management functionality
let integratedDuplicatesData = [];
let integratedSelectedBookings = new Set();

// Load integrated duplicates when tab is shown
document.getElementById('duplicate-management-tab').addEventListener('shown.bs.tab', function() {
    loadIntegratedDuplicates();
});

// Event listeners for integrated duplicate management
document.addEventListener('DOMContentLoaded', function() {
    // Integrated duplicate management buttons
    const refreshBtn = document.getElementById('integrated-refresh-duplicates');
    const deleteBtn = document.getElementById('integrated-delete-all-selected');
    const selectAllBtn = document.getElementById('integrated-select-all-duplicates');
    
    if (refreshBtn) refreshBtn.addEventListener('click', loadIntegratedDuplicates);
    if (deleteBtn) deleteBtn.addEventListener('click', deleteIntegratedSelectedBookings);
    if (selectAllBtn) selectAllBtn.addEventListener('click', selectAllIntegratedDuplicates);
});

async function loadIntegratedDuplicates() {
    const spinner = document.getElementById('integrated-loading-spinner');
    const container = document.getElementById('integrated-duplicates-container');
    const noDataMsg = document.getElementById('integrated-no-duplicates');
    
    if (!spinner || !container) return;
    
    spinner.style.display = 'block';
    container.innerHTML = '';
    if (noDataMsg) noDataMsg.style.display = 'none';
    
    try {
        const response = await fetch('/api/duplicate_management');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
            integratedDuplicatesData = result.duplicates || [];
            updateIntegratedStatistics(result);
            
            if (integratedDuplicatesData.length === 0) {
                if (noDataMsg) noDataMsg.style.display = 'block';
            } else {
                renderIntegratedDuplicateGroups();
            }
        } else {
            throw new Error(result.error || 'Failed to load duplicates');
        }
    } catch (error) {
        console.error('Error loading integrated duplicates:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>L·ªói khi t·∫£i d·ªØ li·ªáu duplicate:</strong> ${error.message}
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-danger" onclick="loadIntegratedDuplicates()">
                        <i class="fas fa-redo me-1"></i>Th·ª≠ l·∫°i
                    </button>
                </div>
            </div>
        `;
        integratedDuplicatesData = [];
        integratedSelectedBookings.clear();
        updateIntegratedSelectedCount();
    } finally {
        spinner.style.display = 'none';
    }
}

function updateIntegratedStatistics(result) {
    const elements = {
        'integrated-total-groups': result.total_groups || 0,
        'integrated-processing-time': (result.processing_info?.processing_time || 0).toFixed(2) + 's',
        'integrated-processed-guests': result.processing_info?.processed_guests || 0
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    });
    
    // Count total duplicate bookings
    let totalBookings = 0;
    if (result.duplicates && Array.isArray(result.duplicates)) {
        result.duplicates.forEach(group => {
            if (group.bookings && Array.isArray(group.bookings)) {
                totalBookings += group.bookings.length;
            }
        });
    }
    
    const totalBookingsEl = document.getElementById('integrated-total-bookings');
    if (totalBookingsEl) totalBookingsEl.textContent = totalBookings;
    
    // Update tab badge
    const tabBadge = document.getElementById('duplicate-count-badge');
    if (tabBadge) tabBadge.textContent = totalBookings;
}

function renderIntegratedDuplicateGroups() {
    const container = document.getElementById('integrated-duplicates-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    integratedDuplicatesData.forEach((group, groupIndex) => {
        if (!group || !group.guest_name || !Array.isArray(group.bookings)) return;
        
        const groupHtml = `
            <div class="duplicate-group p-4 mb-3" data-group="${groupIndex}">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-user-friends text-warning me-2"></i>
                        ${group.guest_name}
                        <small class="text-muted">(${group.bookings.length} bookings)</small>
                    </h5>
                    <div>
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-calendar-alt me-1"></i>
                            Ch√™nh l·ªách: ${Math.abs(group.date_difference_days || 0)} ng√†y
                        </span>
                    </div>
                </div>
                
                <div class="row">
                    ${group.bookings.map((booking, bookingIndex) => `
                        <div class="col-md-6 mb-3">
                            <div class="booking-card p-3 ${integratedSelectedBookings.has(booking.booking_id) ? 'selected' : ''}" 
                                 data-booking-id="${booking.booking_id}" 
                                 onclick="toggleIntegratedBookingSelection('${booking.booking_id}')">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">
                                        <i class="fas fa-bookmark me-1"></i>
                                        ${booking.booking_id}
                                    </h6>
                                    <div>
                                        <input type="checkbox" class="form-check-input me-2" 
                                               ${integratedSelectedBookings.has(booking.booking_id) ? 'checked' : ''}
                                               onchange="toggleIntegratedBookingSelection('${booking.booking_id}')">
                                        <span class="badge ${booking.booking_status === 'confirmed' ? 'bg-success' : 'bg-warning'}">
                                            ${booking.booking_status || 'N/A'}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="row text-sm">
                                    <div class="col-6">
                                        <strong>Check-in:</strong><br>
                                        <i class="fas fa-calendar-check text-success"></i> ${booking.checkin_date || 'N/A'}
                                    </div>
                                    <div class="col-6">
                                        <strong>Check-out:</strong><br>
                                        <i class="fas fa-calendar-times text-danger"></i> ${booking.checkout_date || 'N/A'}
                                    </div>
                                </div>
                                
                                <hr class="my-2">
                                
                                <div class="row text-sm">
                                    <div class="col-6">
                                        <strong>T·ªïng ti·ªÅn:</strong><br>
                                        <span class="text-success fw-bold">${(booking.room_amount || 0).toLocaleString()}ƒë</span>
                                    </div>
                                    <div class="col-6">
                                        <strong>Hoa h·ªìng:</strong><br>
                                        <span class="text-warning fw-bold">${(booking.commission || 0).toLocaleString()}ƒë</span>
                                    </div>
                                </div>
                                
                                ${booking.collected_amount > 0 ? `
                                    <div class="mt-2">
                                        <small class="text-success">
                                            <i class="fas fa-check-circle"></i> 
                                            ƒê√£ thu: ${(booking.collected_amount || 0).toLocaleString()}ƒë
                                            ${booking.collector ? `(${booking.collector})` : ''}
                                        </small>
                                    </div>
                                ` : ''}
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> T·∫°o: ${booking.created_at || 'N/A'}
                                    </small>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        container.innerHTML += groupHtml;
    });
    
    updateIntegratedSelectedCount();
}

function toggleIntegratedBookingSelection(bookingId) {
    if (integratedSelectedBookings.has(bookingId)) {
        integratedSelectedBookings.delete(bookingId);
    } else {
        integratedSelectedBookings.add(bookingId);
    }
    
    const card = document.querySelector(`[data-booking-id="${bookingId}"]`);
    const checkbox = card?.querySelector('input[type="checkbox"]');
    
    if (card && checkbox) {
        if (integratedSelectedBookings.has(bookingId)) {
            card.classList.add('selected');
            checkbox.checked = true;
        } else {
            card.classList.remove('selected');
            checkbox.checked = false;
        }
    }
    
    updateIntegratedSelectedCount();
}

function updateIntegratedSelectedCount() {
    const count = integratedSelectedBookings.size;
    const countEl = document.getElementById('integrated-selected-count');
    const deleteBtn = document.getElementById('integrated-delete-all-selected');
    
    if (countEl) countEl.textContent = count;
    if (deleteBtn) {
        deleteBtn.disabled = count === 0;
        deleteBtn.innerHTML = `<i class="fas fa-trash me-1"></i>X√≥a ƒë√£ ch·ªçn (${count})`;
    }
}

function selectAllIntegratedDuplicates() {
    integratedDuplicatesData.forEach(group => {
        for (let i = 1; i < group.bookings.length; i++) {
            integratedSelectedBookings.add(group.bookings[i].booking_id);
        }
    });
    renderIntegratedDuplicateGroups();
}

async function deleteIntegratedSelectedBookings() {
    if (integratedSelectedBookings.size === 0) return;
    
    const confirmed = confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${integratedSelectedBookings.size} booking ƒë√£ ch·ªçn?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`);
    if (!confirmed) return;
    
    const deleteBtn = document.getElementById('integrated-delete-all-selected');
    if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x√≥a...';
    }
    
    let successCount = 0;
    let failCount = 0;
    
    for (const bookingId of integratedSelectedBookings) {
        try {
            const response = await fetch('/api/delete_duplicate_booking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ booking_id: bookingId })
            });
            
            const result = await response.json();
            if (result.success) {
                successCount++;
            } else {
                failCount++;
                console.error(`Failed to delete ${bookingId}:`, result.error);
            }
        } catch (error) {
            failCount++;
            console.error(`Error deleting ${bookingId}:`, error);
        }
    }
    
    if (successCount > 0) {
        alert(`‚úÖ ƒê√£ x√≥a th√†nh c√¥ng ${successCount} booking!${failCount > 0 ? `\n‚ùå L·ªói: ${failCount} booking` : ''}`);
        integratedSelectedBookings.clear();
        loadIntegratedDuplicates();
        
        // Refresh main booking list if visible
        if (document.getElementById('all-bookings').classList.contains('show')) {
            window.location.reload();
        }
    } else {
        alert('‚ùå Kh√¥ng th·ªÉ x√≥a booking n√†o. Vui l√≤ng th·ª≠ l·∫°i.');
    }
    
    if (deleteBtn) {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>X√≥a ƒë√£ ch·ªçn (0)';
    }
}
</script>

{% endblock %} 