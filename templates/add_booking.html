{% extends "base.html" %}
{% block title %}Th√™m ƒê·∫∑t ph√≤ng{% endblock %}

{% block content %}
<style>
.apartment-card {
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.apartment-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.apartment-card.selected {
    transform: scale(1.02);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

#selected-apartment-info {
    animation: slideDown 0.5s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-control-sm:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

#generated-url {
    background-color: #f8f9fa;
    font-family: 'Courier New', monospace;
    font-size: 10px !important;
}

.alert-info {
    background: linear-gradient(135deg, #d1ecf1 0%, #b8daff 100%);
    border: none;
}

.alert-primary {
    background: linear-gradient(135deg, #cce7ff 0%, #b3d9ff 100%);
    border: none;
}

.alert-warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: none;
}
</style>
<h1 class="mb-4"><i class="fas fa-plus-circle me-2"></i>Th√™m ƒê·∫∑t ph√≤ng <small class="text-muted">Photo AI + Manual</small></h1>

<!-- Duplicate Warning Modal -->
{% if duplicate_warning %}
<div class="alert alert-warning border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%); color: white;">
    <h4 class="alert-heading">
        <i class="fas fa-exclamation-triangle me-2"></i>‚ö†Ô∏è Ph√°t hi·ªán kh√°ch c√≥ th·ªÉ tr√πng l·∫∑p!
    </h4>
    
    {% for duplicate in duplicate_warning.duplicates %}
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="card bg-white bg-opacity-20 border-0">
                <div class="card-body">
                    <h6 class="text-white">üìù Booking M·ªöI (ƒëang th√™m)</h6>
                    <div class="text-white-75">
                        <strong>T√™n:</strong> {{ duplicate.new_booking.guest_name }}<br>
                        <strong>Check-in:</strong> {{ duplicate.new_booking.check_in_date }}<br>
                        <strong>Check-out:</strong> {{ duplicate.new_booking.check_out_date }}<br>
                        <strong>Ph√≤ng:</strong> {{ duplicate.new_booking.room_type }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-white bg-opacity-20 border-0">
                <div class="card-body">
                    <h6 class="text-white">üóÉÔ∏è Booking HI·ªÜN T·∫†I (trong h·ªá th·ªëng)</h6>
                    <div class="text-white-75">
                        <strong>ID:</strong> {{ duplicate.existing_booking.booking_id }}<br>
                        <strong>T√™n:</strong> {{ duplicate.existing_booking.guest_name }}<br>
                        <strong>Check-in:</strong> {{ duplicate.existing_booking.check_in_date }}<br>
                        <strong>Check-out:</strong> {{ duplicate.existing_booking.check_out_date }}<br>
                        <strong>Tr·∫°ng th√°i:</strong> {{ duplicate.existing_booking.status }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <div class="mt-3">
        <h6>üí° L·ª±a ch·ªçn c·ªßa b·∫°n:</h6>
        <div class="d-flex gap-3">
            <form method="POST" action="{{ url_for('add_booking') }}" style="display: inline;">
                {% for key, value in form_data.items() %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endfor %}
                <input type="hidden" name="force_add" value="1">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>‚úÖ V·∫´n th√™m booking m·ªõi
                </button>
            </form>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">
                <i class="fas fa-times me-1"></i>‚ùå H·ªßy v√† ki·ªÉm tra l·∫°i
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Smart Photo Upload Section -->
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
        <h6 class="mb-0 text-white fw-bold">
            <i class="fas fa-camera me-2"></i>
            <span class="text-white">üì∏ AI Smart Upload - T·ª± ƒë·ªông nh·∫≠n di·ªán 1 kh√°ch ho·∫∑c nhi·ªÅu kh√°ch</span>
        </h6>
    </div>
    <div class="card-body">
        <div id="photo-upload-area" class="border-2 border-dashed border-primary rounded p-4 text-center photo-upload-zone" 
             style="cursor: pointer; background-color: #f8f9ff; transition: all 0.3s ease;">
            <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
            <p class="mb-2"><strong>D√°n ·∫£nh (Ctrl+V) ho·∫∑c click ƒë·ªÉ ch·ªçn file</strong></p>
            <small class="text-muted">AI s·∫Ω t·ª± ƒë·ªông ph√¢n t√≠ch v√† quy·∫øt ƒë·ªãnh: ƒëi·ªÅn form (1 kh√°ch) ho·∫∑c l∆∞u nhi·ªÅu kh√°ch</small>
            <input type="file" id="photo-input" accept="image/*" style="display: none;">
        </div>

        <!-- OR DIVIDER -->
        <div class="text-center my-3">
            <span class="badge bg-secondary px-3 py-2">HO·∫∂C</span>
        </div>

        <!-- PROFESSIONAL APARTMENT MANAGEMENT SECTION -->
        <div class="border-2 border-dashed border-success rounded p-4" style="background-color: #f8fff8;">
            <div class="text-center mb-4">
                <i class="fas fa-building fa-2x text-success mb-2"></i>
                <h5 class="text-success mb-0"><strong>üè¢ Qu·∫£n l√Ω CƒÉn h·ªô & Crawl Booking.com</strong></h5>
                <small class="text-muted">H·ªá th·ªëng crawl chuy√™n nghi·ªáp cho 2 cƒÉn h·ªô c·ªßa b·∫°n</small>
            </div>
            
            <!-- Apartment Selection Cards -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card apartment-card" id="apartment-1" onclick="selectApartment(1)" style="cursor: pointer; border: 2px solid #e9ecef;">
                        <div class="card-body text-center">
                            <i class="fas fa-home fa-2x text-primary mb-2"></i>
                            <h6 class="card-title text-primary">üè† CƒÉn h·ªô 1</h6>
                            <small class="text-muted">Hotel ID: 14171449</small>
                            <div class="mt-2">
                                <span class="badge bg-light text-dark">M·∫∑c ƒë·ªãnh: 01/07 ‚Üí 31/08</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card apartment-card" id="apartment-2" onclick="selectApartment(2)" style="cursor: pointer; border: 2px solid #e9ecef;">
                        <div class="card-body text-center">
                            <i class="fas fa-building fa-2x text-warning mb-2"></i>
                            <h6 class="card-title text-warning">üè¢ CƒÉn h·ªô 2</h6>
                            <small class="text-muted">Hotel ID: 14174292</small>
                            <div class="mt-2">
                                <span class="badge bg-light text-dark">M·∫∑c ƒë·ªãnh: 27/06 ‚Üí 31/08</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Selected Apartment Info -->
            <div id="selected-apartment-info" class="alert alert-info" style="display: none;">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <strong id="selected-apartment-name">Ch∆∞a ch·ªçn cƒÉn h·ªô</strong>
                        <br><small id="selected-apartment-id" class="text-muted">Hotel ID: ---</small>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small">T·ª´ ng√†y:</label>
                                <input type="date" id="crawl-date-from" class="form-control form-control-sm">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">ƒê·∫øn ng√†y:</label>
                                <input type="date" id="crawl-date-to" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <button id="start-crawl-btn" class="btn btn-success w-100" disabled>
                            <i class="fas fa-spider me-2"></i>B·∫Øt ƒë·∫ßu Crawl
                        </button>
                    </div>
                </div>
                
                <!-- Advanced Options -->
                <div class="mt-3 pt-3 border-top">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label class="form-label small">Browser Profile:</label>
                            <select id="crawl-profile-select" class="form-select form-select-sm">
                                <option value="booking_fixed_profile">booking_fixed_profile (Recommended)</option>
                                <option value="booking_manual_profile">booking_manual_profile</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Generated URL:</label>
                            <input type="text" id="generated-url" class="form-control form-control-sm" readonly style="font-size: 11px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Crawl Processing Status -->
        <div id="crawl-processing" class="mt-3" style="display: none;">
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                    <small class="text-primary"><strong>üï∑Ô∏è ƒêang crawl admin panel v√† ph√¢n t√≠ch b·∫±ng AI...</strong></small>
                </div>
            </div>
        </div>
        
        <!-- Processing Status -->
        <div id="photo-processing" class="mt-3" style="display: none;">
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                    <small class="text-primary"><strong>AI ƒëang ph√¢n t√≠ch ·∫£nh...</strong></small>
                </div>
            </div>
        </div>
        
        <!-- AI Extraction Results - Review Table -->
        <div id="ai-results-review" class="mt-3" style="display: none;">
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i>AI ƒë√£ tr√≠ch xu·∫•t th√†nh c√¥ng!</h5>
                <p class="mb-0">T√¨m th·∫•y <span id="extracted-count">0</span> booking t·ª´ ·∫£nh. Vui l√≤ng ki·ªÉm tra v√† ch·ªânh s·ª≠a n·∫øu c·∫ßn:</p>
            </div>
            
            <!-- Review Table with Edit Capabilities -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-table me-2"></i>Xem tr∆∞·ªõc v√† ch·ªânh s·ª≠a th√¥ng tin</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover mb-0" id="review-table">
                            <thead class="table-primary">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="20%">T√™n kh√°ch *</th>
                                    <th width="15%">Booking ID</th>
                                    <th width="12%">Check-in *</th>
                                    <th width="12%">Check-out *</th>
                                    <th width="15%">T·ªïng ti·ªÅn *</th>
                                    <th width="15%">Hoa h·ªìng</th>
                                    <th width="6%">X√≥a</th>
                                </tr>
                            </thead>
                            <tbody id="review-table-body">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-6">
                            <button id="add-manual-row" class="btn btn-outline-primary">
                                <i class="fas fa-plus me-2"></i>Th√™m kh√°ch th·ªß c√¥ng
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <button onclick="resetPhotoUpload()" class="btn btn-secondary me-2">
                                <i class="fas fa-undo me-2"></i>Th·ª≠ l·∫°i
                            </button>
                            <button id="confirm-save-all" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>X√°c nh·∫≠n l∆∞u t·∫•t c·∫£
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Form (Auto-filled by AI or manual entry) -->
<div id="manual-form-container">
    <div class="card border-secondary">
        <div class="card-header bg-secondary text-white">
            <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Form th·ªß c√¥ng (t·ª± ƒë·ªông ƒëi·ªÅn t·ª´ AI)</h6>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('add_booking') }}">
                <div class="row g-3">
                    <!-- Essential Information -->
                    <div class="col-md-6">
                        <label for="T√™n ng∆∞·ªùi ƒë·∫∑t" class="form-label"><i class="fas fa-user me-1"></i>T√™n ng∆∞·ªùi ƒë·∫∑t *</label>
                        <input type="text" class="form-control" id="T√™n ng∆∞·ªùi ƒë·∫∑t" name="T√™n ng∆∞·ªùi ƒë·∫∑t" 
                               value="{{ form_data.get('T√™n ng∆∞·ªùi ƒë·∫∑t', '') if form_data else '' }}" 
                               placeholder="Nh·∫≠p t√™n kh√°ch h√†ng ho·∫∑c ƒë·ªÉ AI t·ª± ƒëi·ªÅn" required>
                    </div>
                    <div class="col-md-6">
                        <label for="S·ªë ƒë·∫∑t ph√≤ng" class="form-label"><i class="fas fa-hashtag me-1"></i>S·ªë ƒë·∫∑t ph√≤ng</label>
                        <input type="text" class="form-control" id="S·ªë ƒë·∫∑t ph√≤ng" name="S·ªë ƒë·∫∑t ph√≤ng" 
                               value="{{ form_data.get('S·ªë ƒë·∫∑t ph√≤ng', '') if form_data else '' }}" 
                               placeholder="Nh·∫≠p m√£ booking ho·∫∑c ƒë·ªÉ AI t·ª± ƒëi·ªÅn">
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="col-md-4">
                        <label for="Email" class="form-label"><i class="fas fa-envelope me-1"></i>Email</label>
                        <input type="email" class="form-control" id="Email" name="Email" 
                               value="{{ form_data.get('Email', '') if form_data else '' }}" 
                               placeholder="email@example.com">
                    </div>
                    <div class="col-md-4">
                        <label for="S·ªë ƒëi·ªán tho·∫°i" class="form-label"><i class="fas fa-phone me-1"></i>S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" class="form-control" id="S·ªë ƒëi·ªán tho·∫°i" name="S·ªë ƒëi·ªán tho·∫°i" 
                               value="{{ form_data.get('S·ªë ƒëi·ªán tho·∫°i', '') if form_data else '' }}" 
                               placeholder="+84...">
                    </div>
                    <div class="col-md-4">
                        <label for="S·ªë kh√°ch" class="form-label"><i class="fas fa-users me-1"></i>S·ªë kh√°ch</label>
                        <input type="number" class="form-control" id="S·ªë kh√°ch" name="S·ªë kh√°ch" 
                               value="{{ form_data.get('S·ªë kh√°ch', '1') if form_data else '1' }}" 
                               placeholder="1" min="1" max="10">
                    </div>

                    <!-- Dates -->
                    <div class="col-md-6">
                        <label for="Ng√†y ƒë·∫øn" class="form-label"><i class="fas fa-calendar-check me-1"></i>Ng√†y ƒë·∫øn (Check-in) *</label>
                        <input type="date" class="form-control" id="Ng√†y ƒë·∫øn" name="Ng√†y ƒë·∫øn" 
                               value="{{ form_data.get('Ng√†y ƒë·∫øn', '') if form_data else '' }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="Ng√†y ƒëi" class="form-label"><i class="fas fa-calendar-times me-1"></i>Ng√†y ƒëi (Check-out) *</label>
                        <input type="date" class="form-control" id="Ng√†y ƒëi" name="Ng√†y ƒëi" 
                               value="{{ form_data.get('Ng√†y ƒëi', '') if form_data else '' }}" required>
                    </div>

                    <!-- Payment Information -->
                    <div class="col-md-6">
                        <label for="T·ªïng thanh to√°n" class="form-label"><i class="fas fa-coins me-1"></i>T·ªïng thanh to√°n (VND) *</label>
                        <input type="number" step="any" class="form-control" id="T·ªïng thanh to√°n" name="T·ªïng thanh to√°n" 
                               value="{{ form_data.get('T·ªïng thanh to√°n', '') if form_data else '' }}"
                               placeholder="0" min="0" required>
                    </div>
                    <div class="col-md-6">
                        <label for="Hoa h·ªìng" class="form-label"><i class="fas fa-percentage me-1"></i>Hoa h·ªìng (VND)</label>
                        <input type="number" step="any" class="form-control" id="Hoa h·ªìng" name="Hoa h·ªìng" 
                               value="{{ form_data.get('Hoa h·ªìng', '') if form_data else '0' }}"
                               placeholder="0" min="0">
                    </div>
                    
                    <!-- Status and Payment -->
                    <div class="col-md-6">
                        <label for="T√¨nh tr·∫°ng" class="form-label"><i class="fas fa-flag me-1"></i>T√¨nh tr·∫°ng</label>
                        <select class="form-select" id="T√¨nh tr·∫°ng" name="T√¨nh tr·∫°ng">
                            <option value="OK" {% if not form_data or form_data.get('T√¨nh tr·∫°ng') == 'OK' %}selected{% endif %}>‚úÖ OK</option>
                            <option value="ƒê√£ h·ªßy" {% if form_data and form_data.get('T√¨nh tr·∫°ng') == 'ƒê√£ h·ªßy' %}selected{% endif %}>‚ùå ƒê√£ h·ªßy</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="Ng∆∞·ªùi thu ti·ªÅn" class="form-label"><i class="fas fa-user-tie me-1"></i>Ng∆∞·ªùi thu ti·ªÅn</label>
                        <select class="form-select" id="Ng∆∞·ªùi thu ti·ªÅn" name="Ng∆∞·ªùi thu ti·ªÅn">
                            <option value="" {% if not form_data or not form_data.get('Ng∆∞·ªùi thu ti·ªÅn') %}selected{% endif %}>üö´ Ch∆∞a thu</option>
                            <option value="LOC LE" {% if form_data and form_data.get('Ng∆∞·ªùi thu ti·ªÅn') == 'LOC LE' %}selected{% endif %}>üë§ LOC LE</option>
                            <option value="THAO LE" {% if form_data and form_data.get('Ng∆∞·ªùi thu ti·ªÅn') == 'THAO LE' %}selected{% endif %}>üë§ THAO LE</option>
                        </select>
                    </div>

                    <!-- Hidden fields with default values -->
                    <input type="hidden" name="T√™n ch·ªó ngh·ªâ" value="118 Hang Bac Hostel">
                    <input type="hidden" name="ƒê∆∞·ª£c ƒë·∫∑t v√†o" value="">
                    <input type="hidden" name="Ti·ªÅn t·ªá" value="VND">
                    <input type="hidden" name="V·ªã tr√≠" value="H√† N·ªôi">
                    <input type="hidden" name="Th√†nh vi√™n Genius" value="Kh√¥ng">
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary btn-lg me-2">
                        <i class="fas fa-plus me-2"></i>Th√™m 1 ƒê·∫∑t ph√≤ng
                    </button>
                    <a href="{{ url_for('view_bookings') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Store extracted bookings for multiple booking scenario with session persistence
let extractedBookings = [];

// Session persistence functions
function saveExtractedBookingsToSession() {
    try {
        sessionStorage.setItem('hotel_extracted_bookings', JSON.stringify(extractedBookings));
        console.log('üíæ Saved extracted bookings to session:', extractedBookings.length);
    } catch (error) {
        console.warn('‚ö†Ô∏è Failed to save to sessionStorage:', error);
    }
}

function loadExtractedBookingsFromSession() {
    try {
        const saved = sessionStorage.getItem('hotel_extracted_bookings');
        if (saved) {
            extractedBookings = JSON.parse(saved);
            console.log('üìÇ Loaded extracted bookings from session:', extractedBookings.length);
            
            // If we have data, show the review table
            if (extractedBookings.length > 0) {
                console.log('üîÑ Restoring review table with session data...');
                showReviewTable(extractedBookings, null);
            }
            return true;
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Failed to load from sessionStorage:', error);
        extractedBookings = [];
    }
    return false;
}

function clearExtractedBookingsSession() {
    try {
        sessionStorage.removeItem('hotel_extracted_bookings');
        console.log('üóëÔ∏è Cleared extracted bookings from session');
    } catch (error) {
        console.warn('‚ö†Ô∏è Failed to clear sessionStorage:', error);
    }
}

// IMMEDIATE GLOBAL FUNCTIONS - Available from page load
window.testPhotoUpload = function() {
    console.log('üß™ Testing photo upload functionality...');
    const uploadArea = document.getElementById('photo-upload-area');
    const photoInput = document.getElementById('photo-input');
    console.log('üìÅ Upload area element:', uploadArea);
    console.log('üìÇ Photo input element:', photoInput);
    
    if (uploadArea && photoInput) {
        console.log('‚úÖ Elements found');
        alert('‚úÖ Elements found!\nUpload area: ' + (uploadArea ? 'OK' : 'Missing') + '\nPhoto input: ' + (photoInput ? 'OK' : 'Missing'));
        return true;
    } else {
        console.error('‚ùå Elements missing');
        alert('‚ùå Elements missing!\nUpload area: ' + (uploadArea ? 'OK' : 'Missing') + '\nPhoto input: ' + (photoInput ? 'OK' : 'Missing'));
        return false;
    }
};

window.fixPhotoUpload = function() {
    console.log('üîß Manual photo upload fix...');
    const uploadArea = document.getElementById('photo-upload-area');
    const photoInput = document.getElementById('photo-input');
    
    if (!uploadArea || !photoInput) {
        alert('‚ùå Cannot fix: Elements not found');
        return false;
    }
    
    // Direct onclick assignment
    uploadArea.onclick = function(e) {
        console.log('üîß MANUAL CLICK: Opening file dialog');
        e.preventDefault();
        e.stopPropagation();
        photoInput.click();
    };
    
    // File change handler
    photoInput.onchange = function(e) {
        console.log('üîß MANUAL FILE: File selected', e.target.files[0]);
        if (e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(event) {
                console.log('üîß MANUAL PROCESS: Processing photo');
                if (typeof processPhoto === 'function') {
                    processPhoto(event.target.result);
                } else {
                    alert('‚ùå processPhoto function not found');
                }
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    };
    
    alert('‚úÖ Photo upload manually fixed!\nTry clicking the upload area now.');
    return true;
};

// NUCLEAR OPTION - Simple direct fix
window.nuclearFixPhotoUpload = function() {
    console.log('üí• NUCLEAR: Direct HTML replacement');
    const uploadArea = document.getElementById('photo-upload-area');
    if (uploadArea) {
        uploadArea.innerHTML = `
            <input type="file" accept="image/*" 
                   style="display:block;margin:20px auto;padding:20px;border:2px dashed #007bff;background:#f8f9ff;cursor:pointer;width:90%;text-align:center;"
                   onchange="
                       console.log('üí• NUCLEAR FILE SELECTED');
                       if(this.files[0]) {
                           const reader = new FileReader();
                           reader.onload = function(e) {
                               console.log('üí• NUCLEAR PROCESSING');
                               if(typeof processPhoto === 'function') {
                                   processPhoto(e.target.result);
                               } else {
                                   alert('processPhoto function not available');
                               }
                           };
                           reader.readAsDataURL(this.files[0]);
                       }
                   ">
            <div style="pointer-events:none;margin-top:10px;">
                <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                <p><strong>NUCLEAR MODE: Click to select image file</strong></p>
            </div>
        `;
        alert('üí• Nuclear mode activated!\nUpload area replaced with direct file input.');
        return true;
    } else {
        alert('‚ùå Upload area not found');
        return false;
    }
};

// Test that functions are defined
console.log('üß™ FUNCTIONS TEST: testPhotoUpload defined:', typeof window.testPhotoUpload);
console.log('üîß FUNCTIONS TEST: fixPhotoUpload defined:', typeof window.fixPhotoUpload);
console.log('üí• FUNCTIONS TEST: nuclearFixPhotoUpload defined:', typeof window.nuclearFixPhotoUpload);

// EMERGENCY FIX: Direct element binding without waiting for DOMContentLoaded
function initPhotoUploadImmediate() {
    console.log('üö® EMERGENCY: Direct photo upload initialization...');
    
    const uploadArea = document.getElementById('photo-upload-area');
    const photoInput = document.getElementById('photo-input');
    
    console.log('üîç Direct check - Upload Area:', uploadArea);
    console.log('üîç Direct check - Photo Input:', photoInput);
    
    if (uploadArea && photoInput) {
        // Remove any existing event listeners
        uploadArea.onclick = null;
        photoInput.onchange = null;
        
        // Add direct event listeners
        uploadArea.addEventListener('click', function(e) {
            console.log('üö® EMERGENCY CLICK: Upload area clicked');
            e.preventDefault();
            e.stopPropagation();
            photoInput.click();
        });
        
        photoInput.addEventListener('change', function(e) {
            console.log('üö® EMERGENCY CHANGE: File selected', e.target.files[0]);
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    console.log('üö® EMERGENCY PROCESS: Processing photo');
                    processPhoto(event.target.result);
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        
        // Add paste support to document
        document.addEventListener('paste', function(e) {
            console.log('üö® EMERGENCY PASTE: Paste detected');
            if (e.clipboardData && e.clipboardData.items) {
                for (let item of e.clipboardData.items) {
                    if (item.type.startsWith('image/')) {
                        console.log('üö® EMERGENCY IMAGE: Processing pasted image');
                        const file = item.getAsFile();
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                processPhoto(event.target.result);
                            };
                            reader.readAsDataURL(file);
                        }
                        break;
                    }
                }
            }
        });
        
        console.log('üö® EMERGENCY SUCCESS: Photo upload initialized directly');
        window.emergencyPhotoUploadFixed = true;
        return true;
    } else {
        console.error('üö® EMERGENCY FAIL: Elements not found');
        return false;
    }
}

// Try immediate initialization
if (document.readyState === 'loading') {
    console.log('üìÑ Document still loading, waiting...');
} else {
    console.log('üìÑ Document already loaded, initializing immediately');
    initPhotoUploadImmediate();
}

// Photo upload functionality - Primary initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing photo upload functionality...');
    
    // Skip if emergency fix already worked
    if (window.emergencyPhotoUploadFixed) {
        console.log('‚úÖ Emergency fix already applied, skipping normal initialization');
        return;
    }
    
    const uploadArea = document.getElementById('photo-upload-area');
    const photoInput = document.getElementById('photo-input');
    
    if (!uploadArea) {
        console.error('‚ùå photo-upload-area element not found!');
        return;
    }
    
    if (!photoInput) {
        console.error('‚ùå photo-input element not found!');
        return;
    }
    
    console.log('‚úÖ Photo upload elements found, attaching event listeners...');
    
    // Click to upload
    uploadArea.onclick = function(e) {
        console.log('üìÅ Upload area clicked, opening file dialog...');
        e.preventDefault();
        e.stopPropagation();
        photoInput.click();
    };
    
    // File selection
    photoInput.onchange = function(e) {
        console.log('üìÇ File selected:', e.target.files[0]);
        if (e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(event) {
                console.log('üì∏ File read complete, processing photo...');
                processPhoto(event.target.result);
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    };
    
    // Paste support
    document.addEventListener('paste', function(e) {
        console.log('üìã Paste event detected');
        
        if (!e.clipboardData || !e.clipboardData.items) {
            console.log('‚ö†Ô∏è No clipboard data available');
            return;
        }
        
        const items = e.clipboardData.items;
        console.log('üìã Clipboard items:', items.length);
        
        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            console.log(`üìã Item ${i}: type=${item.type}, kind=${item.kind}`);
            
            if (item.type.startsWith('image/')) {
                console.log('üñºÔ∏è Image found in clipboard, processing...');
                e.preventDefault();
                e.stopPropagation();
                
                const file = item.getAsFile();
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        console.log('üì∏ Pasted image read complete, processing photo...');
                        processPhoto(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
                break;
            }
        }
    });
    
    console.log('‚úÖ Photo upload functionality initialized successfully');
    window.photoUploadInitialized = true;
    
    // Test function for debugging
    window.testPhotoUpload = function() {
        console.log('üß™ Testing photo upload functionality...');
        console.log('üìÅ Upload area element:', uploadArea);
        console.log('üìÇ Photo input element:', photoInput);
        console.log('üéØ Upload area onclick:', uploadArea.onclick);
        console.log('üéØ Photo input onchange:', photoInput.onchange);
        
        if (uploadArea && photoInput) {
            console.log('‚úÖ All elements found and configured');
            alert('‚úÖ Photo upload elements are properly configured!\n\nTry:\n‚Ä¢ Click the upload area\n‚Ä¢ Paste an image (Ctrl+V)\n‚Ä¢ Check browser console for detailed logs');
        } else {
            console.error('‚ùå Some elements are missing');
            alert('‚ùå Photo upload elements are missing. Check browser console for details.');
        }
    };
    
    // Manual fix function for users
    window.fixPhotoUpload = function() {
        console.log('üîß Manual photo upload fix...');
        const success = initPhotoUploadImmediate();
        if (success) {
            alert('‚úÖ Photo upload manually fixed!\n\nTry clicking the upload area or pasting an image now.');
        } else {
            alert('‚ùå Manual fix failed. Check browser console for details.');
        }
    };
});

// Fallback initialization - in case DOMContentLoaded already fired
setTimeout(function() {
    if (!window.photoUploadInitialized && !window.emergencyPhotoUploadFixed) {
        console.log('üîÑ Running fallback photo upload initialization...');
        
        const success = initPhotoUploadImmediate();
        if (success) {
            console.log('‚úÖ Fallback initialization successful');
            window.photoUploadInitialized = true;
        } else {
            console.error('‚ùå Fallback initialization failed');
        }
    }
}, 1000);

// Additional aggressive retry for stubborn cases
setTimeout(function() {
    if (!window.photoUploadInitialized && !window.emergencyPhotoUploadFixed) {
        console.log('üö® AGGRESSIVE RETRY: Final attempt at photo upload initialization...');
        
        const uploadArea = document.getElementById('photo-upload-area');
        const photoInput = document.getElementById('photo-input');
        
        if (uploadArea && photoInput) {
            // Use more aggressive event binding
            uploadArea.setAttribute('onclick', 'document.getElementById("photo-input").click(); console.log("üö® ONCLICK ATTR: Clicked via attribute");');
            
            // Also add addEventListener as backup
            uploadArea.addEventListener('click', function(e) {
                console.log('üö® AGGRESSIVE: Click event fired');
                document.getElementById('photo-input').click();
            }, true); // Use capture phase
            
            console.log('üö® AGGRESSIVE: Applied onclick attribute and capture listener');
        }
    }
}, 3000);

function processPhoto(imageData) {
    console.log('üîç Processing photo...');
    
    // Show processing indicator
    document.getElementById('photo-processing').style.display = 'block';
    
    // Hide AI results if previously shown
    const aiResults = document.getElementById('ai-results-review');
    if (aiResults) {
        aiResults.style.display = 'none';
    }
    
    // Call AI processing endpoint
    fetch('/api/process_pasted_image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image_b64: imageData })
    })
    .then(response => response.json())
    .then(data => {
        // Hide processing indicator with null check
        const processingEl = document.getElementById('photo-processing');
        if (processingEl) {
            processingEl.style.display = 'none';
        }
        
        console.log('üìã AI Response:', data);
        
        if (data.error) {
            alert('‚ùå L·ªói x·ª≠ l√Ω ·∫£nh: ' + data.error);
            return;
        }
        
        // Handle new smart response format - always show review table
        if (data.type === 'single') {
            // Single booking detected - show in review table
            console.log('üìù Single booking detected - showing review table');
            showReviewTable([data.booking], data.duplicate_check);
            
        } else if (data.type === 'multiple') {
            // Multiple bookings detected - show in review table
            console.log('üë• Multiple bookings detected - showing review table');
            showReviewTable(data.bookings, data.duplicate_check);
            
        } else {
            // Fallback for legacy response format
            console.log('üîÑ Using legacy response format');
            let bookings = [];
            if (Array.isArray(data)) {
                bookings = data;
            } else if (data.bookings && Array.isArray(data.bookings)) {
                bookings = data.bookings;
            } else if (data.guest_name) {
                bookings = [data];
            }
            
            const validBookings = bookings.filter(booking => !booking.error);
            
            if (validBookings.length === 0) {
                alert('‚ö†Ô∏è Kh√¥ng th·ªÉ tr√≠ch xu·∫•t th√¥ng tin booking t·ª´ ·∫£nh n√†y. Vui l√≤ng th·ª≠ ·∫£nh kh√°c ho·∫∑c nh·∫≠p th·ªß c√¥ng.');
                return;
            }
            
            // Show all bookings in review table
            showReviewTable(validBookings, null);
        }
    })
    .catch(error => {
        // Hide processing indicator with null check
        const processingEl = document.getElementById('photo-processing');
        if (processingEl) {
            processingEl.style.display = 'none';
        }
        console.error('‚ùå Photo processing error:', error);
        alert('‚ùå L·ªói k·∫øt n·ªëi khi x·ª≠ l√Ω ·∫£nh: ' + error.message);
    });
}

// Auto-fill function removed - now using review table for all scenarios

function showReviewTable(bookings, duplicateCheck) {
    console.log('üìä Showing review table for:', bookings);
    
    extractedBookings = bookings;
    
    // Save to session storage
    saveExtractedBookingsToSession();
    
    // Update counter with null check
    const countEl = document.getElementById('extracted-count');
    if (countEl) {
        countEl.textContent = bookings.length;
    }
    
    // Check for existing bookings in database
    checkExistingBookings(bookings).then(() => {
        // Show duplicate warning if needed
        if (duplicateCheck && duplicateCheck.has_duplicates) {
            const duplicateCount = duplicateCheck.duplicates.length;
            const duplicateNames = duplicateCheck.duplicates.map(dup => dup.guest_name).join(', ');
            alert(`‚ö†Ô∏è C·∫¢NH B√ÅO TR√ôNG L·∫∂P: T√¨m th·∫•y ${duplicateCount} kh√°ch c√≥ th·ªÉ ƒë√£ t·ªìn t·∫°i!\\n\\n` +
                  `Kh√°ch tr√πng l·∫∑p: ${duplicateNames}\\n\\n` +
                  'üîç C√°c d√≤ng b·ªã tr√πng l·∫∑p ƒë∆∞·ª£c ƒë√°nh d·∫•u V√ÄNG v·ªõi bi·ªÉu t∆∞·ª£ng ‚ö†Ô∏è\\n' +
                  'Vui l√≤ng ki·ªÉm tra k·ªπ tr∆∞·ªõc khi l∆∞u ƒë·ªÉ tr√°nh t·∫°o booking tr√πng l·∫∑p!');
        }
        
        // Generate the table after checking existing bookings
        generateReviewTableHtml(duplicateCheck);
    });
}

// Check for existing bookings in database
async function checkExistingBookings(bookings) {
    try {
        console.log('üîç Checking for existing bookings...');
        
        const response = await fetch('/api/check_existing_bookings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bookings: bookings })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('üìã Existing bookings check results:', data.results);
            
            // Mark bookings as existing
            data.results.forEach(result => {
                if (result.exists && extractedBookings[result.index]) {
                    extractedBookings[result.index].exists_in_db = true;
                    extractedBookings[result.index].status = 'existing';
                }
            });
            
            // Show summary if there are existing bookings
            if (data.total_existing > 0) {
                console.log(`‚ö†Ô∏è Found ${data.total_existing} existing bookings`);
                
                // Show notification about existing bookings
                const existingNames = data.results
                    .filter(r => r.exists)
                    .map(r => r.guest_name)
                    .join(', ');
                
                // Add a notification area
                let notificationArea = document.getElementById('existing-bookings-notification');
                if (!notificationArea) {
                    notificationArea = document.createElement('div');
                    notificationArea.id = 'existing-bookings-notification';
                    notificationArea.className = 'alert alert-info mb-3';
                    document.getElementById('ai-results-review').insertBefore(
                        notificationArea, 
                        document.getElementById('ai-results-review').firstChild.nextSibling
                    );
                }
                
                notificationArea.innerHTML = `
                    <h6><i class="fas fa-info-circle me-2"></i>üìã Booking ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng</h6>
                    <p class="mb-2">T√¨m th·∫•y <strong>${data.total_existing}</strong> booking ƒë√£ t·ªìn t·∫°i: <strong>${existingNames}</strong></p>
                    <p class="mb-0">
                        <i class="fas fa-lightbulb me-1"></i>
                        <strong>G·ª£i √Ω:</strong> C√°c booking m√†u cam c√≥ th·ªÉ ƒë∆∞·ª£c x√≥a tr∆∞·ªõc khi l∆∞u ƒë·ªÉ tr√°nh tr√πng l·∫∑p.
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeAllExistingBookings()">
                            <i class="fas fa-trash me-1"></i>X√≥a t·∫•t c·∫£ booking ƒë√£ t·ªìn t·∫°i
                        </button>
                    </p>
                `;
            }
        }
    } catch (error) {
        console.error('‚ùå Error checking existing bookings:', error);
    }
}

function generateReviewTableHtml(duplicateCheck) {
    // Create editable table rows with duplicate and existing indicators
    const tableBodyHtml = extractedBookings.map((booking, index) => {
        // Check if this guest might be a duplicate
        const guestName = booking.guest_name || '';
        const isDuplicate = duplicateCheck && duplicateCheck.has_duplicates && 
                           duplicateCheck.duplicates.some(dup => {
                               const dupName = dup.guest_name || '';
                               const currentName = guestName || '';
                               if (!dupName || !currentName) return false;
                               return dupName.toLowerCase().includes(currentName.toLowerCase()) ||
                                      currentName.toLowerCase().includes(dupName.toLowerCase());
                           });
        
        // Check if booking already exists in database
        const existsInDb = booking.exists_in_db || false;
        
        let statusIcon = '';
        let rowClass = '';
        
        if (existsInDb) {
            // Existing booking - orange background with database icon
            statusIcon = '<i class="fas fa-database text-danger ms-1" title="üìã Booking ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng"></i>';
            rowClass = 'table-warning border border-danger';
        } else if (isDuplicate) {
            // Potential duplicate - yellow background with warning
            statusIcon = '<i class="fas fa-exclamation-triangle text-warning ms-1" title="‚ö†Ô∏è Kh√°ch c√≥ th·ªÉ ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng"></i>';
            rowClass = 'table-warning';
        }
        
        return `
        <tr data-index="${index}" class="${rowClass}">
            <td class="text-center fw-bold">${index + 1}</td>
            <td>
                <div class="d-flex align-items-center">
                    <input type="text" class="form-control form-control-sm flex-grow-1" 
                           value="${guestName}" 
                           onchange="updateBookingData(${index}, 'guest_name', this.value)"
                           placeholder="T√™n kh√°ch h√†ng" required>
                    ${statusIcon}
                </div>
            </td>
            <td>
                <input type="text" class="form-control form-control-sm" 
                       value="${booking.booking_id || ''}" 
                       onchange="updateBookingData(${index}, 'booking_id', this.value)"
                       placeholder="T·ª± t·∫°o">
            </td>
            <td>
                <input type="date" class="form-control form-control-sm" 
                       value="${booking.checkin_date || booking.check_in_date || ''}" 
                       onchange="updateBookingData(${index}, 'checkin_date', this.value)" required>
            </td>
            <td>
                <input type="date" class="form-control form-control-sm" 
                       value="${booking.checkout_date || booking.check_out_date || ''}" 
                       onchange="updateBookingData(${index}, 'checkout_date', this.value)" required>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm" 
                       value="${booking.room_amount || booking.total_payment || ''}" 
                       onchange="updateBookingData(${index}, 'room_amount', this.value)"
                       placeholder="0" min="0" required>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm" 
                       value="${booking.commission || ''}" 
                       onchange="updateBookingData(${index}, 'commission', this.value)"
                       placeholder="0" min="0">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm" 
                        onclick="removeBookingRow(${index})" title="X√≥a kh√°ch n√†y">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>`;
    }).join('');
    
    // Update table content with null check
    const tableBodyEl = document.getElementById('review-table-body');
    if (tableBodyEl) {
        tableBodyEl.innerHTML = tableBodyHtml;
    }
    
    // Show AI results with null check
    const resultsEl = document.getElementById('ai-results-review');
    if (resultsEl) {
        resultsEl.style.display = 'block';
    }
    
    // Hide manual form during review with null check
    const manualFormEl = document.getElementById('manual-form-container');
    if (manualFormEl) {
        manualFormEl.style.display = 'none';
    }
}

function resetPhotoUpload() {
    // Hide processing and results with null checks
    const processingEl = document.getElementById('photo-processing');
    if (processingEl) {
        processingEl.style.display = 'none';
    }
    
    const resultsEl = document.getElementById('ai-results-review');
    if (resultsEl) {
        resultsEl.style.display = 'none';
    }
    
    const manualFormEl = document.getElementById('manual-form-container');
    if (manualFormEl) {
        manualFormEl.style.display = 'block';
    }
    
    const photoInputEl = document.getElementById('photo-input');
    if (photoInputEl) {
        photoInputEl.value = '';
    }
    
    extractedBookings = [];
    
    // Clear session storage
    clearExtractedBookingsSession();
}

function updateBookingData(index, field, value) {
    if (extractedBookings[index]) {
        extractedBookings[index][field] = value;
        console.log(`üìù Updated booking ${index + 1} ${field}: ${value}`);
        
        // Save changes to session
        saveExtractedBookingsToSession();
    }
}

function removeBookingRow(index) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√°ch n√†y?')) {
        extractedBookings.splice(index, 1);
        console.log(`üóëÔ∏è Removed booking at index ${index}`);
        
        // Save changes to session
        saveExtractedBookingsToSession();
        
        // Refresh the table
        generateReviewTableHtml(null);
        
        // Update counter
        document.getElementById('extracted-count').textContent = extractedBookings.length;
        
        if (extractedBookings.length === 0) {
            resetPhotoUpload();
        }
    }
}

function removeAllExistingBookings() {
    const existingBookings = extractedBookings.filter(booking => booking.exists_in_db);
    
    if (existingBookings.length === 0) {
        alert('Kh√¥ng c√≥ booking n√†o ƒë√£ t·ªìn t·∫°i ƒë·ªÉ x√≥a.');
        return;
    }
    
    const confirmMsg = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${existingBookings.length} booking ƒë√£ t·ªìn t·∫°i?\\n\\n` +
                      existingBookings.map(b => `‚Ä¢ ${b.guest_name} (${b.booking_id})`).join('\\n');
    
    if (confirm(confirmMsg)) {
        // Remove all existing bookings
        extractedBookings = extractedBookings.filter(booking => !booking.exists_in_db);
        console.log(`üóëÔ∏è Removed ${existingBookings.length} existing bookings`);
        
        // Save changes to session
        saveExtractedBookingsToSession();
        
        // Refresh the table
        generateReviewTableHtml(null);
        
        // Update counter
        document.getElementById('extracted-count').textContent = extractedBookings.length;
        
        // Remove notification
        const notification = document.getElementById('existing-bookings-notification');
        if (notification) {
            notification.remove();
        }
        
        if (extractedBookings.length === 0) {
            resetPhotoUpload();
        }
    }
}

function addManualRow() {
    const newBooking = {
        guest_name: '',
        booking_id: '',
        checkin_date: '',
        checkout_date: '',
        room_amount: '',
        commission: ''
    };
    
    extractedBookings.push(newBooking);
    console.log('‚ûï Added manual booking row');
    
    // Save changes to session
    saveExtractedBookingsToSession();
    
    // Refresh the table
    generateReviewTableHtml(null);
}

function validateBookings() {
    const errors = [];
    
    extractedBookings.forEach((booking, index) => {
        const rowNum = index + 1;
        
        if (!booking.guest_name || booking.guest_name.trim() === '') {
            errors.push(`D√≤ng ${rowNum}: Thi·∫øu t√™n kh√°ch h√†ng`);
        }
        
        if (!booking.checkin_date) {
            errors.push(`D√≤ng ${rowNum}: Thi·∫øu ng√†y check-in`);
        }
        
        if (!booking.checkout_date) {
            errors.push(`D√≤ng ${rowNum}: Thi·∫øu ng√†y check-out`);
        }
        
        if (!booking.room_amount || booking.room_amount <= 0) {
            errors.push(`D√≤ng ${rowNum}: Thi·∫øu ho·∫∑c sai t·ªïng ti·ªÅn`);
        }
        
        // Validate dates
        if (booking.checkin_date && booking.checkout_date) {
            if (new Date(booking.checkin_date) >= new Date(booking.checkout_date)) {
                errors.push(`D√≤ng ${rowNum}: Ng√†y check-out ph·∫£i sau ng√†y check-in`);
            }
        }
    });
    
    return errors;
}

// Save all bookings functionality with validation
document.addEventListener('DOMContentLoaded', function() {
    // Add manual row button
    const addRowButton = document.getElementById('add-manual-row');
    if (addRowButton) {
        addRowButton.onclick = addManualRow;
    }
    
    // Confirm save button
    const confirmSaveButton = document.getElementById('confirm-save-all');
    if (confirmSaveButton) {
        confirmSaveButton.onclick = function() {
            if (extractedBookings.length === 0) {
                alert('Kh√¥ng c√≥ booking n√†o ƒë·ªÉ l∆∞u');
                return;
            }
            
            // Validate all bookings
            const errors = validateBookings();
            if (errors.length > 0) {
                alert('‚ùå Vui l√≤ng s·ª≠a l·ªói sau:\\n\\n' + errors.join('\\n'));
                return;
            }
            
            // Show confirmation
            const confirmMessage = `X√°c nh·∫≠n l∆∞u ${extractedBookings.length} booking:\\n\\n` +
                extractedBookings.map((b, i) => `${i + 1}. ${b.guest_name} - ${(b.room_amount || 0).toLocaleString()}ƒë`).join('\\n') +
                '\\n\\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u?';
                
            if (!confirm(confirmMessage)) {
                return;
            }
            
            console.log('üíæ Saving all bookings after validation:', extractedBookings);
            
            // Disable button and show loading
            confirmSaveButton.disabled = true;
            confirmSaveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang l∆∞u...';
            
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/bookings/save_extracted';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'extracted_json';
            input.value = JSON.stringify(extractedBookings);
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        };
    }
});

function clearForm() {
    // Clear all form fields
    document.querySelectorAll('input, select').forEach(function(element) {
        if (element.type === 'text' || element.type === 'number' || element.type === 'date' || element.type === 'email' || element.type === 'tel') {
            element.value = '';
        } else if (element.tagName === 'SELECT') {
            element.selectedIndex = 0;
        }
    });
    
    // Reset photo upload
    resetPhotoUpload();
    
    // Hide any duplicate warning
    const warning = document.querySelector('.alert-warning');
    if (warning) {
        warning.style.display = 'none';
    }
    
    // Focus on first input
    document.querySelector('input[name="T√™n ng∆∞·ªùi ƒë·∫∑t"]').focus();
}

// ============================
// PROFESSIONAL APARTMENT MANAGEMENT SYSTEM
// ============================

// Apartment configurations
const APARTMENTS = {
    1: {
        name: 'üè† CƒÉn h·ªô 1',
        hotelId: '14171449',
        defaultDateFrom: '2025-07-01',
        defaultDateTo: '2025-08-31',
        color: 'primary',
        baseUrl: 'https://admin.booking.com/hotel/hoteladmin/extranet_ng/manage/search_reservations.html'
    },
    2: {
        name: 'üè¢ CƒÉn h·ªô 2', 
        hotelId: '14174292',
        defaultDateFrom: '2025-06-27',
        defaultDateTo: '2025-08-31',
        color: 'warning',
        baseUrl: 'https://admin.booking.com/hotel/hoteladmin/extranet_ng/manage/search_reservations.html'
    }
};

let selectedApartment = null;

// Initialize apartment management
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates to current month
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 2, 0); // Next month end
    
    document.getElementById('crawl-date-from').value = firstDay.toISOString().split('T')[0];
    document.getElementById('crawl-date-to').value = lastDay.toISOString().split('T')[0];
    
    // Add event listeners
    document.getElementById('crawl-date-from').addEventListener('change', updateGeneratedUrl);
    document.getElementById('crawl-date-to').addEventListener('change', updateGeneratedUrl);
});

function selectApartment(apartmentId) {
    selectedApartment = apartmentId;
    const apartment = APARTMENTS[apartmentId];
    
    // Update visual selection
    document.querySelectorAll('.apartment-card').forEach(card => {
        card.style.border = '2px solid #e9ecef';
        card.style.transform = 'scale(1)';
    });
    
    const selectedCard = document.getElementById(`apartment-${apartmentId}`);
    selectedCard.style.border = `3px solid var(--bs-${apartment.color})`;
    selectedCard.style.transform = 'scale(1.02)';
    selectedCard.style.transition = 'all 0.3s ease';
    
    // Show apartment info panel
    const infoPanel = document.getElementById('selected-apartment-info');
    infoPanel.style.display = 'block';
    infoPanel.className = `alert alert-${apartment.color}`;
    
    // Update apartment details
    document.getElementById('selected-apartment-name').textContent = apartment.name;
    document.getElementById('selected-apartment-id').textContent = `Hotel ID: ${apartment.hotelId}`;
    
    // Set default dates
    document.getElementById('crawl-date-from').value = apartment.defaultDateFrom;
    document.getElementById('crawl-date-to').value = apartment.defaultDateTo;
    
    // Enable crawl button
    document.getElementById('start-crawl-btn').disabled = false;
    
    // Update URL
    updateGeneratedUrl();
    
    // Scroll to info panel
    infoPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    console.log(`‚úÖ Selected apartment ${apartmentId}: ${apartment.name}`);
}

function updateGeneratedUrl() {
    if (!selectedApartment) return;
    
    const apartment = APARTMENTS[selectedApartment];
    const dateFrom = document.getElementById('crawl-date-from').value;
    const dateTo = document.getElementById('crawl-date-to').value;
    
    if (!dateFrom || !dateTo) return;
    
    // Build the complete URL
    const urlParams = new URLSearchParams({
        'upcoming_reservations': '1',
        'source': 'nav',
        'hotel_id': apartment.hotelId,
        'lang': 'vi',
        'reservation_status': 'ok',
        'date_from': dateFrom,
        'date_to': dateTo,
        'date_type': 'arrival'
    });
    
    // Add session parameter for apartment 2 if needed
    if (selectedApartment === 2) {
        urlParams.set('ses', '93a2f637e391ca2393f6e8d3e559c666');
    }
    
    const fullUrl = `${apartment.baseUrl}?${urlParams.toString()}`;
    document.getElementById('generated-url').value = fullUrl;
    
    console.log(`üîó Generated URL for ${apartment.name}:`, fullUrl);
}

document.getElementById('start-crawl-btn').addEventListener('click', async function() {
    if (!selectedApartment) {
        alert('‚ùå Vui l√≤ng ch·ªçn cƒÉn h·ªô tr∆∞·ªõc khi crawl');
        return;
    }
    
    const apartment = APARTMENTS[selectedApartment];
    const adminUrl = document.getElementById('generated-url').value;
    const profileName = document.getElementById('crawl-profile-select').value;
    const crawlBtn = document.getElementById('start-crawl-btn');
    const crawlProcessing = document.getElementById('crawl-processing');
    
    if (!adminUrl) {
        alert('‚ùå URL kh√¥ng h·ª£p l·ªá. Vui l√≤ng ch·ªçn ng√†y crawl.');
        return;
    }

    // Show loading state with apartment info
    crawlBtn.disabled = true;
    crawlBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>ƒêang crawl ${apartment.name}...`;
    
    // Update crawl processing message
    const dateFrom = document.getElementById('crawl-date-from').value;
    const dateTo = document.getElementById('crawl-date-to').value;
    crawlProcessing.innerHTML = `
        <div class="alert alert-info">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm text-${apartment.color} me-3"></div>
                <div>
                    <strong>üï∑Ô∏è ƒêang crawl ${apartment.name} (ID: ${apartment.hotelId})</strong><br>
                    <small class="text-muted">üìÖ T·ª´ ${dateFrom} ƒë·∫øn ${dateTo} | üõ°Ô∏è Smart cleanup b·∫£o v·ªá dev tools c·ªßa b·∫°n</small>
                </div>
            </div>
        </div>
    `;
    crawlProcessing.style.display = 'block';

    try {
        console.log('üï∑Ô∏è Starting admin panel crawl...');
        console.log('‚ÑπÔ∏è Note: Using smart cleanup that preserves your dev tools and other Chrome windows');
        
        const response = await fetch('/api/crawl_admin_bookings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                target_url: adminUrl,
                profile_name: profileName
            })
        });

        const result = await response.json();

        if (result.success && result.bookings && result.bookings.length > 0) {
            console.log(`‚úÖ Successfully crawled ${result.bookings_count} bookings from ${apartment.name}`);
            
            // Process crawled bookings for display in the review table
            const processedBookings = result.bookings.map((booking, index) => ({
                id: index + 1,
                guest_name: booking.guest_name || 'Unknown',
                booking_id: booking.booking_id || 'N/A',
                check_in_date: booking.checkin_date || 'N/A',
                check_out_date: booking.checkout_date || 'N/A',
                room_type: booking.room_type || 'N/A',
                room_amount: booking.room_amount || 0,
                commission: booking.commission || 0,
                email: booking.email || '',
                phone: booking.phone || '',
                source: `${apartment.name}_crawl`,
                apartment_id: selectedApartment,
                apartment_name: apartment.name
            }));

            // Display results with real-time duplicate detection
            await displayCrawlResults(processedBookings, result.bookings_count);
            
            // Hide crawl processing, show success
            crawlProcessing.style.display = 'none';
            
            // Show enhanced success message with duplicate info
            const dateRange = `${dateFrom} ‚Üí ${dateTo}`;
            showTemporaryMessage(`‚úÖ Crawl th√†nh c√¥ng ${apartment.name}!\nüìä ƒê√£ tr√≠ch xu·∫•t ${result.bookings_count} booking\nüìÖ Th·ªùi gian: ${dateRange}\nüîç Real-time duplicate detection ho√†n t·∫•t`, 'success');

        } else {
            throw new Error(result.error || 'Kh√¥ng c√≥ booking n√†o ƒë∆∞·ª£c tr√≠ch xu·∫•t');
        }

    } catch (error) {
        console.error('‚ùå Crawl failed:', error);
        crawlProcessing.style.display = 'none';
        showTemporaryMessage('‚ùå Crawl th·∫•t b·∫°i: ' + error.message, 'error');
    } finally {
        // Reset button state with apartment context
        crawlBtn.disabled = false;
        if (selectedApartment) {
            crawlBtn.innerHTML = `<i class="fas fa-spider me-2"></i>Crawl ${APARTMENTS[selectedApartment].name}`;
        } else {
            crawlBtn.innerHTML = '<i class="fas fa-spider me-2"></i>B·∫Øt ƒë·∫ßu Crawl';
        }
    }
});

// Real-time duplicate detection for crawled bookings
async function detectCrawledDuplicates(crawledBookings) {
    try {
        console.log('üîç Starting real-time duplicate detection for crawled bookings...');
        
        // Call the backend API to check for duplicates
        const response = await fetch('/api/check_existing_bookings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                bookings: crawledBookings.map(booking => ({
                    booking_id: booking.booking_id,
                    guest_name: booking.guest_name,
                    check_in_date: booking.check_in_date,
                    check_out_date: booking.check_out_date,
                    room_amount: booking.room_amount
                }))
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            const duplicates = result.existing_bookings || [];
            console.log(`üîç Duplicate detection complete: ${duplicates.length} duplicates found`);
            
            return {
                duplicates: duplicates,
                total_checked: crawledBookings.length,
                duplicate_count: duplicates.length
            };
        } else {
            throw new Error(result.error || 'Duplicate detection failed');
        }
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Duplicate detection failed:', error);
        // Return empty result on error to not break the crawling process
        return {
            duplicates: [],
            total_checked: crawledBookings.length,
            duplicate_count: 0
        };
    }
}

async function displayCrawlResults(bookings, count) {
    // Show the AI results review section
    const aiResultsReview = document.getElementById('ai-results-review');
    const extractedCountSpan = document.getElementById('extracted-count');
    const aiResultsTable = document.getElementById('review-table');

    // Real-time duplicate detection for crawled bookings
    const duplicateInfo = await detectCrawledDuplicates(bookings);
    
    // Update count with duplicate information
    if (duplicateInfo.duplicates.length > 0) {
        extractedCountSpan.innerHTML = `${count} <span class="badge bg-warning ms-1">${duplicateInfo.duplicates.length} duplicates</span>`;
    } else {
        extractedCountSpan.textContent = count;
    }

    // Build table HTML
    let tableHtml = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-primary">
                    <tr>
                        <th>STT</th>
                        <th>T√™n kh√°ch</th>
                        <th>M√£ booking</th>
                        <th>Check-in</th>
                        <th>Check-out</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Hoa h·ªìng</th>
                        <th>Ngu·ªìn</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
    `;

    bookings.forEach((booking) => {
        const isDuplicate = duplicateInfo.duplicates.some(dup => 
            dup.booking_id === booking.booking_id || 
            (dup.guest_name.toLowerCase() === booking.guest_name.toLowerCase() && 
             Math.abs(new Date(dup.check_in_date) - new Date(booking.check_in_date)) <= 3 * 24 * 60 * 60 * 1000)
        );
        
        const rowClass = isDuplicate ? 'duplicate-row' : '';
        const duplicateIcon = isDuplicate ? '<i class="fas fa-users duplicate-icon me-1" title="C√≥ th·ªÉ tr√πng l·∫∑p v·ªõi booking hi·ªán t·∫°i"></i>' : '';
        
        tableHtml += `
            <tr class="${rowClass}" ${isDuplicate ? 'data-bs-toggle="tooltip" title="‚ö†Ô∏è Booking c√≥ th·ªÉ tr√πng l·∫∑p"' : ''}>
                <td>${booking.id}</td>
                <td><strong>${duplicateIcon}${booking.guest_name}</strong></td>
                <td><code>${booking.booking_id}</code></td>
                <td>${booking.check_in_date}</td>
                <td>${booking.check_out_date}</td>
                <td><span class="text-success">${booking.room_amount.toLocaleString()} VND</span></td>
                <td><span class="text-warning">${booking.commission.toLocaleString()} VND</span></td>
                <td><span class="badge ${isDuplicate ? 'duplicate-badge' : 'bg-success'}">üï∑Ô∏è ${isDuplicate ? 'Crawl (Duplicate?)' : 'Crawl'}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="fillFormWithBooking(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                        <i class="fas fa-edit me-1"></i>ƒêi·ªÅn form
                    </button>
                    ${isDuplicate ? '<br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Check duplicate</small>' : ''}
                </td>
            </tr>
        `;
    });

    tableHtml += `
                </tbody>
            </table>
        </div>
    `;
    
    // Add duplicate summary if duplicates found
    if (duplicateInfo.duplicates.length > 0) {
        tableHtml += `
            <div class="alert duplicate-alert mt-3" role="alert">
                <h6 class="alert-heading">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ph√°t hi·ªán ${duplicateInfo.duplicate_count} booking c√≥ th·ªÉ tr√πng l·∫∑p
                </h6>
                <p class="mb-2">
                    C√°c booking ƒë∆∞·ª£c ƒë√°nh d·∫•u <span class="duplicate-badge">‚ö†Ô∏è yellow</span> 
                    c√≥ th·ªÉ ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng. Vui l√≤ng ki·ªÉm tra k·ªπ tr∆∞·ªõc khi l∆∞u.
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            üí° <strong>G·ª£i √Ω:</strong> S·ª≠ d·ª•ng 
                            <a href="/duplicate_management" target="_blank" class="alert-link">Qu·∫£n l√Ω Tr√πng l·∫∑p</a> 
                            ƒë·ªÉ ph√¢n t√≠ch chi ti·∫øt.
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-sm btn-warning" onclick="showDuplicateDetails()">
                            <i class="fas fa-eye me-1"></i>Xem chi ti·∫øt
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Add action buttons
    const duplicateWarning = duplicateInfo.duplicates.length > 0 ? 
        ` <small class="text-warning">(${duplicateInfo.duplicate_count} duplicates detected)</small>` : '';
    
    tableHtml += `
        <div class="mt-3 text-center">
            <button class="btn btn-success btn-lg" onclick="saveAllCrawledBookings(${JSON.stringify(bookings).replace(/"/g, '&quot;')})">
                <i class="fas fa-save me-2"></i>L∆∞u t·∫•t c·∫£ ${count} booking${duplicateWarning}
            </button>
            ${duplicateInfo.duplicates.length > 0 ? `
                <button class="btn btn-outline-warning btn-lg ms-2" onclick="saveNonDuplicateBookings(${JSON.stringify(bookings).replace(/"/g, '&quot;')}, ${JSON.stringify(duplicateInfo.duplicates).replace(/"/g, '&quot;')})">
                    <i class="fas fa-filter me-2"></i>Ch·ªâ l∆∞u booking m·ªõi (${count - duplicateInfo.duplicate_count})
                </button>
            ` : ''}
        </div>
    `;

    if (aiResultsTable) {
        aiResultsTable.innerHTML = tableHtml;
        aiResultsReview.style.display = 'block';
    } else {
        console.error('‚ùå aiResultsTable element not found, creating temporary display');
        // Create a temporary display area
        aiResultsReview.innerHTML = `
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i>üéâ Crawl th√†nh c√¥ng!</h5>
                <p class="mb-0">ƒê√£ tr√≠ch xu·∫•t <strong>${count}</strong> booking t·ª´ admin panel!</p>
                <div class="mt-3">
                    ${bookings.map((booking, i) => `
                        <div class="card mb-2">
                            <div class="card-body">
                                <strong>${i+1}. ${booking.guest_name}</strong> - 
                                M√£: <code>${booking.booking_id}</code> - 
                                ${booking.check_in_date} ƒë·∫øn ${booking.check_out_date} - 
                                <span class="text-success">${booking.room_amount?.toLocaleString()} VND</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-3">
                    <button class="btn btn-success me-2" onclick="saveBulkBookings()">
                        <i class="fas fa-save me-2"></i>L∆∞u t·∫•t c·∫£ ${count} booking
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <i class="fas fa-sync me-2"></i>L√†m m·ªõi trang
                    </button>
                </div>
            </div>
        `;
        aiResultsReview.style.display = 'block';
    }

    // Scroll to results
    aiResultsReview.scrollIntoView({ behavior: 'smooth' });
}

function fillFormWithBooking(booking) {
    // Fill the manual form with booking data (with null checks)
    try {
        const setFieldValue = (selector, value) => {
            const field = document.querySelector(selector);
            if (field) {
                field.value = value || '';
            } else {
                console.warn(`Field not found: ${selector}`);
            }
        };

        setFieldValue('input[name="T√™n ng∆∞·ªùi ƒë·∫∑t"]', booking.guest_name);
        setFieldValue('input[name="Email"]', booking.email);
        setFieldValue('input[name="S·ªë ƒëi·ªán tho·∫°i"]', booking.phone);
        setFieldValue('input[name="Ng√†y ƒë·∫øn"]', booking.check_in_date || booking.checkin_date);
        setFieldValue('input[name="Ng√†y ƒëi"]', booking.check_out_date || booking.checkout_date);
        setFieldValue('input[name="Lo·∫°i ph√≤ng"]', booking.room_type || 'Standard');
        setFieldValue('input[name="T·ªïng thanh to√°n"]', booking.room_amount || 0);
        setFieldValue('input[name="Hoa h·ªìng"]', booking.commission || 0);
        setFieldValue('input[name="S·ªë ƒë·∫∑t ph√≤ng"]', booking.booking_id);

        // Scroll to form
        const firstField = document.querySelector('input[name="T√™n ng∆∞·ªùi ƒë·∫∑t"]');
        if (firstField) {
            firstField.scrollIntoView({ behavior: 'smooth' });
            firstField.focus();
        }

        showTemporaryMessage('‚úÖ ƒê√£ ƒëi·ªÅn form v·ªõi th√¥ng tin booking: ' + booking.guest_name, 'success');
    } catch (error) {
        console.error('Error filling form:', error);
        showTemporaryMessage('‚ùå L·ªói khi ƒëi·ªÅn form: ' + error.message, 'error');
    }
}

function saveBulkBookings() {
    // Use globally stored bookings
    if (!window.extractedBookings || window.extractedBookings.length === 0) {
        alert('‚ùå Kh√¥ng c√≥ booking n√†o ƒë·ªÉ l∆∞u');
        return;
    }
    
    saveAllCrawledBookings(window.extractedBookings);
}

function saveAllCrawledBookings(bookings) {
    if (!bookings || bookings.length === 0) {
        alert('‚ùå Kh√¥ng c√≥ booking n√†o ƒë·ªÉ l∆∞u');
        return;
    }

    // Prepare data for bulk save
    const bulkData = bookings.map(booking => ({
        guest_name: booking.guest_name,
        email: booking.email,
        phone: booking.phone,
        check_in_date: booking.check_in_date,
        check_out_date: booking.check_out_date,
        room_type: booking.room_type,
        room_amount: booking.room_amount,
        commission: booking.commission,
        booking_id: booking.booking_id,
        status: 'confirmed',
        source: 'admin_crawl'
    }));

    // Show confirmation
    if (confirm(`ü§î X√°c nh·∫≠n l∆∞u ${bookings.length} booking v√†o database?\n\nC√°c booking s·∫Ω ƒë∆∞·ª£c ki·ªÉm tra duplicate tr∆∞·ªõc khi l∆∞u.`)) {
        // Send to existing bulk save endpoint (you may need to create this)
        fetch('/api/save_bulk_bookings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ bookings: bulkData })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                let message = `üìä K·∫øt qu·∫£ l∆∞u:\n‚úÖ ${result.saved_count} booking m·ªõi\n`;
                if (result.skipped_count > 0) {
                    message += `‚ö†Ô∏è ${result.skipped_count} booking ƒë√£ t·ªìn t·∫°i\n`;
                }
                if (result.failed_count > 0) {
                    message += `‚ùå ${result.failed_count} booking l·ªói\n`;
                }
                
                showTemporaryMessage(message, result.saved_count > 0 ? 'success' : 'warning');
                
                // Clear session storage after successful save
                if (result.saved_count > 0) {
                    clearSessionAfterSave();
                }
                
                // Only redirect if we saved something new
                if (result.saved_count > 0) {
                    setTimeout(() => {
                        window.location.href = '/';  // Dashboard is at root
                    }, 3000);
                }
            } else {
                showTemporaryMessage('‚ùå L·ªói khi l∆∞u: ' + result.error, 'error');
            }
        })
        .catch(error => {
            showTemporaryMessage('‚ùå Network error: ' + error.message, 'error');
        });
    }
}

function showTemporaryMessage(message, type) {
    // Create temporary message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert at top of page
    const container = document.querySelector('.container-fluid');
    container.insertBefore(messageDiv, container.firstChild);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.remove();
        }
    }, 5000);
}

// Duplicate management helper functions for crawled bookings
function showDuplicateDetails() {
    const detailsModal = `
        <div class="modal fade" id="duplicateDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-users me-2"></i>Chi ti·∫øt Duplicate Detection
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Duplicate Detection Logic</h6>
                            <p class="mb-1">H·ªá th·ªëng ph√°t hi·ªán duplicate d·ª±a tr√™n:</p>
                            <ul class="mb-0">
                                <li><strong>Booking ID:</strong> Tr√πng kh·ªõp ho√†n to√†n</li>
                                <li><strong>T√™n kh√°ch + Ng√†y:</strong> T√™n gi·ªëng nhau v√† check-in trong v√≤ng 3 ng√†y</li>
                                <li><strong>Real-time:</strong> Ki·ªÉm tra v·ªõi database hi·ªán t·∫°i</li>
                            </ul>
                        </div>
                        <p>Nh·ªØng booking ƒë∆∞·ª£c ƒë√°nh d·∫•u <span class="badge bg-warning">‚ö†Ô∏è yellow</span> c√≥ kh·∫£ nƒÉng cao ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng.</p>
                        <p><strong>Khuy·∫øn ngh·ªã:</strong> Ki·ªÉm tra k·ªπ v√† s·ª≠ d·ª•ng ch·ª©c nƒÉng "Ch·ªâ l∆∞u booking m·ªõi" ƒë·ªÉ tr√°nh duplicate.</p>
                    </div>
                    <div class="modal-footer">
                        <a href="/duplicate_management" target="_blank" class="btn btn-primary">
                            <i class="fas fa-external-link-alt me-1"></i>M·ªü Duplicate Management
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page and show
    document.body.insertAdjacentHTML('beforeend', detailsModal);
    const modal = new bootstrap.Modal(document.getElementById('duplicateDetailsModal'));
    modal.show();
    
    // Remove modal after hide
    document.getElementById('duplicateDetailsModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

function saveNonDuplicateBookings(allBookings, duplicates) {
    // Filter out duplicate bookings
    const nonDuplicateBookings = allBookings.filter(booking => {
        return !duplicates.some(dup => 
            dup.booking_id === booking.booking_id || 
            (dup.guest_name.toLowerCase() === booking.guest_name.toLowerCase() && 
             Math.abs(new Date(dup.check_in_date) - new Date(booking.check_in_date)) <= 3 * 24 * 60 * 60 * 1000)
        );
    });
    
    if (nonDuplicateBookings.length === 0) {
        showTemporaryMessage('‚ùå Kh√¥ng c√≥ booking m·ªõi ƒë·ªÉ l∆∞u. T·∫•t c·∫£ ƒë·ªÅu l√† duplicate.', 'error');
        return;
    }
    
    const confirmMessage = `B·∫°n c√≥ ch·∫Øc mu·ªën l∆∞u ${nonDuplicateBookings.length} booking m·ªõi?\n\n${duplicates.length} booking duplicate s·∫Ω ƒë∆∞·ª£c b·ªè qua.`;
    
    if (confirm(confirmMessage)) {
        saveAllCrawledBookings(nonDuplicateBookings);
    }
}

// Page initialization - load session data when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Page loaded - checking for session persistence...');
    
    // Try to load extracted bookings from session
    const hasSessionData = loadExtractedBookingsFromSession();
    
    if (hasSessionData) {
        console.log('‚úÖ Session data restored successfully');
        // Hide manual form if we have extracted data
        const manualFormEl = document.getElementById('manual-form-container');
        if (manualFormEl && extractedBookings.length > 0) {
            manualFormEl.style.display = 'none';
        }
    } else {
        console.log('üìù No session data found - starting fresh');
    }
});

// Clear session when user successfully saves bookings
function clearSessionAfterSave() {
    clearExtractedBookingsSession();
    console.log('‚úÖ Session cleared after successful save');
}

// Clear session when navigating away (optional - for clean state)
window.addEventListener('beforeunload', function() {
    // Note: We intentionally DON'T clear session here to preserve data across refreshes
    // Session will only be cleared on successful save or manual reset
    console.log('üîÑ Page unloading - session data preserved');
});
</script>

<style>
/* Duplicate guest styling */
.table-warning {
    background-color: #fff3cd !important;
    border-left: 4px solid #ffc107 !important;
}

.table-warning:hover {
    background-color: #ffeaa7 !important;
}

/* Duplicate warning icon animation */
.fas.fa-exclamation-triangle.text-warning {
    animation: pulse-warning 2s infinite;
}

@keyframes pulse-warning {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

/* Enhanced alert styling for duplicate notification */
.alert.alert-success {
    position: relative;
}

.alert.alert-success .fas.fa-check-circle {
    color: #28a745;
}

/* Existing booking styling */
.table-warning.border-danger {
    background-color: #fff3cd !important;
    border-left: 4px solid #dc3545 !important;
}

.table-warning.border-danger:hover {
    background-color: #ffeaa7 !important;
}

/* Existing booking icon animation */
.fas.fa-database.text-danger {
    animation: pulse-danger 2s infinite;
}

@keyframes pulse-danger {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

/* Enhanced existing bookings notification */
#existing-bookings-notification {
    border-left: 4px solid #17a2b8;
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
}

#existing-bookings-notification h6 {
    color: white;
    margin-bottom: 0.5rem;
}

#existing-bookings-notification .btn-outline-danger {
    border-color: white;
    color: white;
}

#existing-bookings-notification .btn-outline-danger:hover {
    background-color: white;
    color: #dc3545;
}

/* Photo upload area styling */
.photo-upload-zone {
    transition: all 0.3s ease !important;
    cursor: pointer !important;
    user-select: none;
}

.photo-upload-zone:hover {
    background-color: #e3f2fd !important;
    border-color: #1976d2 !important;
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.photo-upload-zone:active {
    transform: scale(0.98);
    background-color: #bbdefb !important;
}

.photo-upload-zone i {
    transition: transform 0.3s ease;
}

.photo-upload-zone:hover i {
    transform: scale(1.1);
}
</style>

{% endblock %}